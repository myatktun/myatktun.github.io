
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Kubernetes &#8212; Notes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!-- 
    this give us a css class that will be invisible only if js is disabled 
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=26a4bc78f4c0ddb94549" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=a3416100" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=26a4bc78f4c0ddb94549"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549" />

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'Kubernetes';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="LangChain" href="LangChain.html" />
    <link rel="prev" title="Jenkins" href="Jenkins.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
  
    <p class="title logo__title">Notes</p>
  
</a></div>
        <div class="sidebar-primary-item">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="AITools.html">AI Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="AWS.html">AWS</a></li>
<li class="toctree-l1"><a class="reference internal" href="ArmArchitecture.html">Arm Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="Assembly.html">Assembly</a></li>
<li class="toctree-l1"><a class="reference internal" href="BackendEngineering.html">Backend Engineering</a></li>
<li class="toctree-l1"><a class="reference internal" href="C.html">C</a></li>
<li class="toctree-l1"><a class="reference internal" href="C%2B%2B.html">C++</a></li>
<li class="toctree-l1"><a class="reference internal" href="CSharp.html">C# #</a></li>
<li class="toctree-l1"><a class="reference internal" href="CTF.html">CTF</a></li>
<li class="toctree-l1"><a class="reference internal" href="CompTIA.html">CompTIA Cert Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="Compilers.html">Compilers</a></li>
<li class="toctree-l1"><a class="reference internal" href="ComputerGraphics.html">Computer Graphics</a></li>
<li class="toctree-l1"><a class="reference internal" href="ComputerVision.html">Computer Vision</a></li>
<li class="toctree-l1"><a class="reference internal" href="ComputingSystems.html">Computing Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="CyberSecurity.html">Cyber Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataStructure%26Algorithms.html">Data Structure &amp; Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="DatabaseEngineering.html">Database Engineering</a></li>
<li class="toctree-l1"><a class="reference internal" href="DeepLearning.html">Deep Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="DesignPatterns.html">Design Patterns</a></li>
<li class="toctree-l1"><a class="reference internal" href="Docker.html">Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="ECS.html">ECS</a></li>
<li class="toctree-l1"><a class="reference internal" href="FFmpeg.html">FFmpeg</a></li>
<li class="toctree-l1"><a class="reference internal" href="Git.html">Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="Helm.html">Helm</a></li>
<li class="toctree-l1"><a class="reference internal" href="Istio.html">Istio</a></li>
<li class="toctree-l1"><a class="reference internal" href="JDBC.html">JDBC</a></li>
<li class="toctree-l1"><a class="reference internal" href="Java.html">Java</a></li>
<li class="toctree-l1"><a class="reference internal" href="Jenkins.html">Jenkins</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="LangChain.html">LangChain</a></li>
<li class="toctree-l1"><a class="reference internal" href="Linux.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="MachineLearning.html">Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="Microservices.html">Microservices</a></li>
<li class="toctree-l1"><a class="reference internal" href="MongoDB.html">MongoDB</a></li>
<li class="toctree-l1"><a class="reference internal" href="NetworkProgramming.html">Network Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="NodeJS.html">Node.js</a></li>
<li class="toctree-l1"><a class="reference internal" href="OpenAPI.html">OpenAPI</a></li>
<li class="toctree-l1"><a class="reference internal" href="OperatingSystem.html">Operating System</a></li>
<li class="toctree-l1"><a class="reference internal" href="POSIXThreads.html">POSIX Threads</a></li>
<li class="toctree-l1"><a class="reference internal" href="PenetrationTesting.html">Penetration Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProgramDesign.html">Program Design</a></li>
<li class="toctree-l1"><a class="reference internal" href="ProjectManagement.html">Project Management</a></li>
<li class="toctree-l1"><a class="reference internal" href="Prometheus.html">Prometheus</a></li>
<li class="toctree-l1"><a class="reference internal" href="Python.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="React.html">React</a></li>
<li class="toctree-l1"><a class="reference internal" href="Redis.html">Redis</a></li>
<li class="toctree-l1"><a class="reference internal" href="SFML.html">SFML</a></li>
<li class="toctree-l1"><a class="reference internal" href="SQL.html">SQL</a></li>
<li class="toctree-l1"><a class="reference internal" href="StrategicPlanning.html">Strategic Planning</a></li>
<li class="toctree-l1"><a class="reference internal" href="Terraform.html">Terraform</a></li>
<li class="toctree-l1"><a class="reference internal" href="TypeScript.html">TypeScript</a></li>
<li class="toctree-l1"><a class="reference internal" href="UIUX.html">UI/UX</a></li>
<li class="toctree-l1"><a class="reference internal" href="Vagrant.html">Vagrant</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/Kubernetes.rst" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.rst</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button>


<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Kubernetes</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-k8s">What is K8s?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#principles">Principles</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basics">Basics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#velocity">Velocity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#project-maturity">Project Maturity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#yaml">YAML</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tls-basics">TLS Basics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#switching-routing">Switching &amp; Routing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dns">DNS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#network-namespace">Network Namespace</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-network-configurations">Container Network Configurations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-runtime-interface-cri">Container Runtime Interface (CRI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-storage-interface-csi">Container Storage Interface (CSI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-network-interface-cni">Container Network Interface (CNI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-sandboxing">Container Sandboxing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#system-calls">System Calls</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apparmor">AppArmor</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nodes">Nodes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster">Cluster</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-plane">Control Plane</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#worker-nodes">Worker Nodes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-k8s">Setting up K8s</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubeadm">kubeadm</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#microk8s">MicroK8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minikube">minikube</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectl">kubectl</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectl-apply">kubectl apply</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectl-proxy">kubectl proxy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectl-port-forward">kubectl port-forward</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#etcd">etcd</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pods">Pods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-pods">Creating Pods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-yaml">Generating YAML</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-pods">Editing Pods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copying-files">Copying Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#static-pods">Static Pods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#init-containers">Init Containers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-container-pods">Multi-Container pods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#services">Services</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nodeport">NodePort</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clusterip">ClusterIP</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loadbalancer">LoadBalancer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#headless-services">Headless Services</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selector-less-services">Selector-less Services</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#connect-from-external">Connect from External</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workloads">Workloads</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-controller">Replication Controller</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replicaset">ReplicaSet</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deployments">Deployments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deployment-strategies">Deployment Strategies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#statefulsets">StatefulSets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#daemonset">Daemonset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jobs">Jobs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cronjobs">CronJobs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#storage-volumes">Storage &amp; Volumes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-patterns">Recommended Patterns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#persistent-volume-pv">Persistent Volume (PV)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#persistent-volume-claims-pvc">Persistent Volume Claims (PVC)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storage-classes">Storage Classes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controller">Controller</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kube-controller-manager">Kube Controller Manager</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#node-controller">Node Controller</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#admission-controller">Admission Controller</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#webhook">Webhook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-controllers">Custom Controllers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#operator-framework">Operator Framework</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scheduler">Scheduler</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#binding">Binding</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#networking">Networking</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ports">ports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-network-model">Implementing Network Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cni-in-k8s">CNI in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-networking">Service Networking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dns-in-k8s">DNS in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#network-policies">Network Policies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ingress">Ingress</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mtls">mTLS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#security">Security</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#authentication">Authentication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubeconfig">kubeconfig</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#authorization">Authorization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tls-in-k8s">TLS in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#certificates-api">Certificates API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-security">Image Security</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k8s-attack-surface">K8s Attack Surface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubelet-security">Kubelet Security</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pod-security-policies">Pod Security Policies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#opa-in-k8s">OPA in K8s</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declarative">Declarative</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imperative">Imperative</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#namespaces">Namespaces</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#labels">Labels</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotations">Annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specify-arguments-and-commands">Specify arguments and commands</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configmaps">ConfigMaps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#secrets">Secrets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-env-variables">Setting ENV variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resource-requirements">Resource Requirements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-accounts">Service Accounts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taints-tolerations">Taints &amp; Tolerations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#node-selectors">Node Selectors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#node-affinity">Node Affinity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-resource-definition">Custom Resource Definition</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observability">Observability</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#health-checks">Health Checks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#readiness-probes">Readiness Probes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#liveness-probes">Liveness Probes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#startup-probes">Startup Probes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exec-probes">Exec Probes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logging">Logging</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monitoring">Monitoring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#application-failure">Application Failure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#controlplane-failure">Controlplane Failure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#node-failure">Node Failure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#network-failure">Network Failure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#auditing">Auditing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k8s-dashboard">K8s Dashboard</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#json-path">JSON Path</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-maintenance">Cluster Maintenance</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#draining-the-node">Draining the node</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k8s-versions">K8s Versions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k8s-api">K8s API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backup">Backup</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#microservices-architecture">Microservices Architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sidecar-pattern">Sidecar pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adapter-pattern">Adapter pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ambassador-pattern">Ambassador pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#purpose">Purpose</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#environment">Environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-workloads">Choosing Workloads</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-infrastructure">Choosing Infrastructure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#high-availability">High Availability</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mutable-vs-immutable-infrastructure">Mutable vs Immutable Infrastructure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-hardening">System Hardening</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#limit-access-to-nodes">Limit access to nodes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seccomp-in-k8s">Seccomp in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apparmor-in-k8s">AppArmor in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#capabilities">Capabilities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minimize-base-image-footprint">Minimize base image footprint</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-policy-webhook">Image Policy Webhook</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tools">Tools</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectx">kubectx</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubesec">kubesec</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trivy">Trivy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#weaveworks">Weaveworks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helm">Helm</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cis-benchmark-center-for-internet-security">CIS Benchmark (Center for Internet Security)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kube-bench">kube-bench</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#opa-open-policy-agent">OPA (Open Policy Agent)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gvisor">gVisor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kata-containers">Kata Containers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#falco">Falco</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exam-guide">Exam Guide</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ckad">CKAD</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cka">CKA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cks">CKS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="kubernetes">
<h1>Kubernetes<a class="headerlink" href="#kubernetes" title="Link to this heading">#</a></h1>
<ol class="arabic simple">
<li><p><a class="reference internal" href="#what-is-k8s">What is K8s?</a></p></li>
<li><p><a class="reference internal" href="#basics">Basics</a></p></li>
<li><p><a class="reference internal" href="#architecture">Architecture</a></p></li>
<li><p><a class="reference internal" href="#setting-up-k8s">Setting up K8s</a></p></li>
<li><p><a class="reference internal" href="#kubectl">kubectl</a></p></li>
<li><p><a class="reference internal" href="#etcd">etcd</a></p></li>
<li><p><a class="reference internal" href="#pods">Pods</a></p></li>
<li><p><a class="reference internal" href="#services">Services</a></p></li>
<li><p><a class="reference internal" href="#workloads">Workloads</a></p></li>
<li><p><a class="reference internal" href="#storage-volumes">Storage &amp; Volumes</a></p></li>
<li><p><a class="reference internal" href="#controller">Controller</a></p></li>
<li><p><a class="reference internal" href="#scheduler">Scheduler</a></p></li>
<li><p><a class="reference internal" href="#networking">Networking</a></p></li>
<li><p><a class="reference internal" href="#security">Security</a></p></li>
<li><p><a class="reference internal" href="#configuration">Configuration</a></p></li>
<li><p><a class="reference internal" href="#observability">Observability</a></p></li>
<li><p><a class="reference internal" href="#cluster-maintenance">Cluster Maintenance</a></p></li>
<li><p><a class="reference internal" href="#microservices-architecture">Microservices Architecture</a></p></li>
<li><p><a href="#id29"><span class="problematic" id="id30">`Designing a Cluster`_</span></a></p></li>
<li><p><a class="reference internal" href="#system-hardening">System Hardening</a></p></li>
<li><p><a class="reference internal" href="#tools">Tools</a></p></li>
<li><p><a class="reference internal" href="#exam-guide">Exam Guide</a></p></li>
<li><p><a class="reference internal" href="#additional-resources">Additional Resources</a></p></li>
</ol>
<section id="what-is-k8s">
<h2>What is K8s?<a class="headerlink" href="#what-is-k8s" title="Link to this heading">#</a></h2>
<ul>
<li><p>developed by Google and became open source</p></li>
<li><p>orchestrate containers and configure auto scaling as needed</p></li>
<li><p>have more options and features than other orchestration tools</p></li>
<li><p>can upgrade instances with rolling upgrade fashion one at a time</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>rolling-update<span class="w"> </span>my-app<span class="w"> </span>--image<span class="o">=</span>app:2
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>can roll back if error occurs</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>rolling-update<span class="w"> </span>my-app<span class="w"> </span>--rollback
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>can test new features by only upgrading a few of instances through A/B testing</p></li>
<li><p>open architecture provides support for many network and storage vendors</p></li>
<li><p>supports a variety of authentication and authorization mechanisms</p></li>
</ul>
<section id="principles">
<h3>Principles<a class="headerlink" href="#principles" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>Kube API declarative over imperative</dt><dd><ul>
<li><p>self-healing, able to rollback, extensible</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>No hidden internal APIs</dt><dd><ul>
<li><p>immutable regardless of the environment</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Meet the user where they are</dt><dd><ul>
<li><p>ease of adoption</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Workload portability</dt><dd><ul>
<li><p>cloud/cluster agnostic, separation of concerns</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<ul>
<li><dl>
<dt>K8s achieves scalability by favoring <strong>decoupled architectures</strong></dt><dd><ul class="simple">
<li><p>each component is separated from other components by defined APIs and service load</p></li>
</ul>
<p>balancers
* APIs provide buffer between implementer and consumer
* load balancers provide buffer between running instances of each service
* K8s provide numerous abstractions and APIs to make building decoupled microservice
architectures easier</p>
</dd>
</dl>
</li>
</ul>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="basics">
<h2>Basics<a class="headerlink" href="#basics" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#velocity">Velocity</a>, <a class="reference internal" href="#project-maturity">Project Maturity</a>, <a class="reference internal" href="#yaml">YAML</a>, <a class="reference internal" href="#tls-basics">TLS Basics</a>, <a class="reference internal" href="#switching-routing">Switching &amp; Routing</a>, <a class="reference internal" href="#dns">DNS</a>, <a class="reference internal" href="#network-namespace">Network Namespace</a></p></li>
<li><p><a href="#id31"><span class="problematic" id="id32">`Container Network Configuration`_</span></a>, <a href="#id33"><span class="problematic" id="id34">`CRI`_</span></a>, <a href="#id35"><span class="problematic" id="id36">`CSI`_</span></a>, <a href="#id37"><span class="problematic" id="id38">`CNI`_</span></a>, <a class="reference internal" href="#container-sandboxing">Container Sandboxing</a></p></li>
<li><p><a class="reference internal" href="#system-calls">System Calls</a>, <a class="reference internal" href="#apparmor">AppArmor</a></p></li>
</ul>
<section id="velocity">
<h3>Velocity<a class="headerlink" href="#velocity" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>key component in nearly all software development</p></li>
<li><p>measured not in terms of raw number of features shipped per hour or day, but rather in</p></li>
</ul>
<p>terms of number of things shipped while maintaining high availability service</p>
</div></blockquote>
</section>
<section id="project-maturity">
<h3>Project Maturity<a class="headerlink" href="#project-maturity" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt><strong>Sandbox</strong></dt><dd><ul>
<li><p>project is still in early development and adoption is not recommended</p></li>
<li><p>only early adopter or those interested in contribution should adopt the project</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Incubator</strong></dt><dd><ul>
<li><p>projects that have proven utility and stability via adoption and production usage</p></li>
<li><p>but still developing and growing communities</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Graduated</strong></dt><dd><ul>
<li><p>full mature and widely adopted</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="yaml">
<h3>YAML<a class="headerlink" href="#yaml" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl>
<dt>dictionary (key: value), unordered</dt><dd><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># comment</span>

<span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">car</span>
<span class="nt">model</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Model</span>
<span class="w">    </span><span class="nt">year</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1999</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>list (multiple items of same type), ordered</dt><dd><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">car1 blue</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">car2 red</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">car3 white</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>list of dictionaries</dt><dd><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">car</span>
<span class="w">  </span><span class="nt">model</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Model</span>
<span class="w">    </span><span class="nt">year</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1999</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">car</span>
<span class="w">  </span><span class="nt">model</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Model</span>
<span class="w">    </span><span class="nt">year</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1999</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">color</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">blue</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">car</span>
<span class="w">  </span><span class="nt">model</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Model</span>
<span class="w">    </span><span class="nt">year</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1999</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>K8s YAML contains four top definition fields</dt><dd><ul class="simple">
<li><dl class="simple">
<dt><strong>apiVersion</strong></dt><dd><ul>
<li><p>K8s api used to create objects</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>kind</strong></dt><dd><ul>
<li><p>type of object to create</p></li>
<li><p>e.g Pod (v1), ReplicaSet (apps/v1), Service (v1), Deployment (apps/v1)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>metadata</strong></dt><dd><ul>
<li><p>data about object such as name, labels</p></li>
<li><p>every data is in the form of dictionary</p></li>
<li><p>indent doesn’t matter as long as they are same</p></li>
<li><p>labels can have any key/value pairs and make pods easier to group</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>spec</strong></dt><dd><ul>
<li><p>remaining details such as containers, which contains arrays</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="tls-basics">
<h3>TLS Basics<a class="headerlink" href="#tls-basics" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>used to guarantee trust during transactions</p></li>
<li><dl>
<dt>symmetric encryption</dt><dd><ul class="simple">
<li><p>using same key to encrypt and decrypt, key has to be exchanged between receiver and</p></li>
</ul>
<p>sender
- data is encrypted using a key
- a copy of the key must also be on server
- e.g data transaction between user and web server</p>
</dd>
</dl>
</li>
<li><dl>
<dt>asymmetric encryption</dt><dd><ul class="simple">
<li><p>uses a pair of keys, private and public</p></li>
<li><p>data encrypted with public key, can only be decrypted with it’s private key</p></li>
<li><p>public key can be shared</p></li>
<li><p>cannot encrypt and decrypt with the same key</p></li>
<li><p>use one to decrypt and the other to decrypt</p></li>
<li><p>if data is encrypted using private key, public key can be used to decrypt and since</p></li>
</ul>
<p>public key has been shared, deciding which key to use to decrypt is important
- e.g safely transfer symmetric key between user and web server</p>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">ssh-keygen</span></code> is for ssh purposes, format is different</p></li>
<li><dl>
<dt>use <code class="docutils literal notranslate"><span class="pre">openssl</span></code> for web servers</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">openssl</span> <span class="pre">genrsa</span> <span class="pre">-out</span> <span class="pre">my.key</span> <span class="pre">1024</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">openssl</span> <span class="pre">rsa</span> <span class="pre">-in</span> <span class="pre">my.key</span> <span class="pre">-pubout</span> <span class="pre">&gt;</span> <span class="pre">myPub.pem</span></code></p></li>
<li><p>when the user first access the web server using https, he gets the public key from</p></li>
</ul>
<p>the server, hackers can get the public key
- the user’s browser encrypt the symmetric key using the public key provided by the
server
- the user sends the encrypted key to the server, hacker also gets the copy
- the server decrypt the symmetric key using it’s private key, since the hacker does
not have the private key, he cannot decrypt it
- the symmetric key now be used to send data between user and server, the server can
use the same encrypted symmetric key to decrypt the data</p>
</dd>
</dl>
</li>
<li><p>every certificate has a name, person or subject the certificate is issued to</p></li>
<li><p>who signed and issued the certificate is very important</p></li>
<li><p>everyone can look at the certificate and know if the persons signed is authorized or not</p></li>
<li><p>all the browsers have built-in certificate validation</p></li>
<li><dl>
<dt>Certificate Authority (CA)</dt><dd><ul class="simple">
<li><p>well-known organizations that can sign and validate the certificate</p></li>
<li><p>e.g Symantec, Digicert, Comodo, GlobalSign</p></li>
<li><p>generate a CSR (Certificate Signing Request) using the key generated and the domain</p></li>
</ul>
<p>name of the website
- <code class="docutils literal notranslate"><span class="pre">openssl</span> <span class="pre">req</span> <span class="pre">-new</span> <span class="pre">-key</span> <span class="pre">my.key</span> <span class="pre">-out</span> <span class="pre">my.csr</span> <span class="pre">-subj</span> <span class="pre">&quot;/C=US/ST=CA/O=MyOrg,</span> <span class="pre">Inc./CN=mydomain.com</span></code>
- CA verifies the details and sign the certificate and send it back
- now have a certificate that the browsers trust
- CAs make sure that the sender is the actual owner of the domain
- CAs use their private key to sign the certificate
- their public keys are built-in to the browser
- the browser uses the CAs public key to validate the certificate
- public CAs don’t help to validate sites hosted privately
- can host private CAs within organization and use the keys</p>
</dd>
</dl>
</li>
<li><dl>
<dt>client certificates</dt><dd><ul class="simple">
<li><p>the server does not know if the client can be trusted or not</p></li>
<li><p>in initial trust building exercise, the server can request a certificate from the</p></li>
</ul>
<p>client
- the client generates a pair of keys and a signed certificate from a CA and send it
to the server
- TLS client certificates are not generally implemented on web servers</p>
</dd>
</dl>
</li>
<li><p>certificates with public key are usually named <code class="docutils literal notranslate"><span class="pre">*.crt</span></code> or <code class="docutils literal notranslate"><span class="pre">*.pem</span></code></p></li>
<li><p>private keys are usually named <code class="docutils literal notranslate"><span class="pre">*.key</span></code> or <code class="docutils literal notranslate"><span class="pre">*-key.pem</span></code></p></li>
<li><dl>
<dt>PKI (Public Key Infrastructure)</dt><dd><ul class="simple">
<li><p>CAs, servers, clients and the process of generating, distributing and maintaining</p></li>
</ul>
<p>digital certificates</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Oneway SSL</strong></dt><dd><ul class="simple">
<li><p>client verifies server’s certificate, the server does not verify client’s certificate</p></li>
<li><p>the server only verifies the user based on the data sent, such as username, password</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Mutual SSL</strong></dt><dd><ul class="simple">
<li><p>both client and server verify authenticity of each other</p></li>
<li><p>client first request server’s public certificate</p></li>
<li><p>the server replies with it’s public certificate and requests for the client’s public</p></li>
</ul>
<p>certificate
- the client checks the server’s certificate with the CA
- the client then sends its public certificate and a symmetric key encrypted with the
public key of the server
- the server verifies the client’s certificate with the CA
- all communication can now be encrypted with symmetric keys</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="switching-routing">
<h3>Switching &amp; Routing<a class="headerlink" href="#switching-routing" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to connect computers/systems to a switch, an interface is needed on each host, physical</p></li>
</ul>
<p>or virtual
* once the IPs are assigned to the interfaces, the systems can now communicate through the
switch
* the switch can only enable communication within the same network
* for systems to reach other networks, a router is needed
* a router connects separate networks, getting assigned IPs on each network
* a gateway in the network is required for a system to send packets to through it
* connect the router to the Internet and add a new route, so that the systems can reach the
Internet
* for any network the system does not know a route to, can let it use the router as default
gateway
* 0.0.0.0 entry in Gateway means the system does not need a gateway to reach the
destination
* if there are multiple routers for different networks, separate entries for each network are
required
* by default in Linux, packets are not forwarded from one interface to the next
* to allow packet forwarding, edit the <code class="docutils literal notranslate"><span class="pre">/pro/sys/net/ipv4/ip_forward</span></code> (0 to disable and 1
to enable), configuration does not persist through reboots
* to persist the configuration, set the <code class="docutils literal notranslate"><span class="pre">net.ipv4.ip_forward</span></code> value in <code class="docutils literal notranslate"><span class="pre">/etc/sysctl.conf</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># check interface</span>
ip<span class="w"> </span>link

<span class="c1"># assign IP to the interface</span>
ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.1.10/24<span class="w"> </span>dev<span class="w"> </span>eth0

<span class="c1"># check routing tables</span>
route

<span class="c1"># add gateway (the system can reach 192.168.2.0 through 192.168.1.1)</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.2.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.1.1

<span class="c1"># use router as default gateway</span>
ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.1.1
</pre></div>
</div>
</div></blockquote>
</section>
<section id="dns">
<h3>DNS<a class="headerlink" href="#dns" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>allow systems to communicate using names instead of IP addresses</p></li>
<li><dl class="simple">
<dt><strong>Name Resolution</strong></dt><dd><ul class="simple">
<li><p>translating IP addresses to names</p></li>
<li><p>edit <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> with IP address and name</p></li>
<li><p>hostname on other system doesn’t matter, the system uses what’s defined in <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>DNS server</strong></dt><dd><ul class="simple">
<li><p>as the environment grows, entries in <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> will also increase</p></li>
<li><p>instead of managing entries on each system, let a single server, DNS server, manage</p></li>
</ul>
<p>all entries
- point all systems to look up on the DNS server if they need to resolve a name to IP
address
- every system has DNS resolution configuration file at <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>
- only need to update on the DNS server if IPs change
- if there is same entry on local and DNS server, the system will first look in local
file and use it
- order that defines which file to look first is defined in <code class="docutils literal notranslate"><span class="pre">/etc/nsswitch.conf</span></code>
- can configure the DNS server to forward all unknown names to the public nameserver</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Domain Names</strong></dt><dd><ul class="simple">
<li><p>root: .</p></li>
<li><p>top-level domains: .com, .net, .edu, .org, .io</p></li>
<li><p>domain name: google</p></li>
<li><p>subdomain: www, drive, mail</p></li>
<li><p>a server can cache the IP for faster resolves</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Record Types</strong></dt><dd><ul class="simple">
<li><p>A: storing IPs</p></li>
<li><p>AAAA: storing IPv6</p></li>
<li><p>CNAME: mapping one name to another name</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>can use tools such as ping, nslookup, dig</p></li>
<li><dl class="simple">
<dt><strong>CoreDNS</strong></dt><dd><ul class="simple">
<li><p>DNS server solution, listens on port 53 by default</p></li>
<li><p>put entries in <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code>, configure CoreDNS to use the file</p></li>
<li><p>CoreDNS loads configurations from a file named Corefile</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="network-namespace">
<h3>Network Namespace<a class="headerlink" href="#network-namespace" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>used by containers for network isolation</p></li>
<li><p>can connect namespaces using virtual ethernet pairs, pipes</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># list network namespaces</span>
ip<span class="w"> </span>netns

<span class="c1"># create network namespace</span>
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>namespace1
ip<span class="w"> </span>netns<span class="w"> </span>add<span class="w"> </span>namespace2

<span class="c1"># view interfaces on the namespace</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>namespace1<span class="w"> </span>ip<span class="w"> </span>link
ip<span class="w"> </span>-n<span class="w"> </span>red<span class="w"> </span>link

<span class="c1"># connect namespace</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>veth-namespace1<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>veth-namespace2

<span class="c1"># attach interface to appropriate namespace</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace1<span class="w"> </span>netns<span class="w"> </span>namespace1
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace2<span class="w"> </span>netns<span class="w"> </span>namespace2

<span class="c1"># assign IP in namespace</span>
ip<span class="w"> </span>-n<span class="w"> </span>namespace1<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.15.1<span class="w"> </span>dev<span class="w"> </span>veth-namespace1
ip<span class="w"> </span>-n<span class="w"> </span>namespace2<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.15.2<span class="w"> </span>dev<span class="w"> </span>veth-namespace2

<span class="c1"># bring up interface</span>
ip<span class="w"> </span>-n<span class="w"> </span>namespace1<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace1<span class="w"> </span>up
ip<span class="w"> </span>-n<span class="w"> </span>namespace2<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace2<span class="w"> </span>up
</pre></div>
</div>
<ul class="simple">
<li><p>create a virtual switch to connect multiple namespaces using solutions such as Linux</p></li>
</ul>
<p>Bridge, Open vSwitch</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># add new interface</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>v-net-0<span class="w"> </span><span class="nb">type</span><span class="w"> </span>bridge

<span class="c1"># bring up interface</span>
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>dev<span class="w"> </span>v-net-0<span class="w"> </span>up

<span class="c1"># delete existing direct link, other end is auto deleted</span>
ip<span class="w"> </span>-n<span class="w"> </span>namespace1<span class="w"> </span>link<span class="w"> </span>del<span class="w"> </span>veth-namespace1

<span class="c1"># connect namespace to the bridge</span>
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>veth-namespace1<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>veth-namespace1-br
ip<span class="w"> </span>link<span class="w"> </span>add<span class="w"> </span>veth-namespace2<span class="w"> </span><span class="nb">type</span><span class="w"> </span>veth<span class="w"> </span>peer<span class="w"> </span>name<span class="w"> </span>veth-namespace2-br
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace1<span class="w"> </span>netns<span class="w"> </span>namespace1
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace1-br<span class="w"> </span>master<span class="w"> </span>v-net-0
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace2<span class="w"> </span>netns<span class="w"> </span>namespace2
ip<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace2-br<span class="w"> </span>master<span class="w"> </span>v-net-0

<span class="c1"># assign IP</span>
ip<span class="w"> </span>-n<span class="w"> </span>namespace1<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.15.1<span class="w"> </span>dev<span class="w"> </span>veth-namespace1
ip<span class="w"> </span>-n<span class="w"> </span>namespace2<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.15.2<span class="w"> </span>dev<span class="w"> </span>veth-namespace2

<span class="c1"># bring up interface</span>
ip<span class="w"> </span>-n<span class="w"> </span>namespace1<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace1<span class="w"> </span>up
ip<span class="w"> </span>-n<span class="w"> </span>namespace2<span class="w"> </span>link<span class="w"> </span><span class="nb">set</span><span class="w"> </span>veth-namespace2<span class="w"> </span>up
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p>can use bridge to connect host and namespaces by assigning IP to the bridge interface</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ip<span class="w"> </span>addr<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.15.5/24<span class="w"> </span>dev<span class="w"> </span>v-net-0
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>for namespaces to reach a network through the host port, the host can be used as a</p></li>
</ul>
<dl>
<dt>gateway</dt><dd><ul class="simple">
<li><p>the host now have two IPs, one on bridge and other on external</p></li>
<li><p>gateway should be the one the namespace can reach, the bridge (192.168.15.5)</p></li>
<li><p>the host must have net functionality for the outside network to know that the</p></li>
</ul>
<p>packets are coming from the host instead of the namespace, which is unknown it
- since the namespace can reach any network the host can, it can be setup so that
the namespace talk to the host to reach any external network
- can use port forwarding for external network to reach the namespace</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># use host as gateway to reach 192.168.1.0</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>namespace1<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span><span class="m">192</span>.168.1.0/24<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.15.5

<span class="c1"># enable net function</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>POSTROUTING<span class="w"> </span>-s<span class="w"> </span><span class="m">192</span>.168.15.0/24<span class="w"> </span>-j<span class="w"> </span>MASQUERADE

<span class="c1"># use host as default gateway to reach any network</span>
ip<span class="w"> </span>netns<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>namespace1<span class="w"> </span>ip<span class="w"> </span>route<span class="w"> </span>add<span class="w"> </span>default<span class="w"> </span>via<span class="w"> </span><span class="m">192</span>.168.15.5

<span class="c1"># forward packets coming to host&#39;s port 80 to the namespace</span>
iptables<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span>-A<span class="w"> </span>PREROUTING<span class="w"> </span>--dport<span class="w"> </span><span class="m">80</span><span class="w"> </span>--to-destination<span class="w"> </span><span class="m">192</span>.168.15.1:80<span class="w"> </span>-j<span class="w"> </span>DNAT
</pre></div>
</div>
</dd>
</dl>
</div></blockquote>
</section>
<section id="container-network-configurations">
<h3>Container Network Configurations<a class="headerlink" href="#container-network-configurations" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl class="simple">
<dt><strong>none</strong></dt><dd><ul class="simple">
<li><p>container is not part of any network</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>host</strong></dt><dd><ul class="simple">
<li><p>container is attached to host network, no network isolation between host and</p></li>
</ul>
<p>container</p>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>bridge</strong></dt><dd><ul class="simple">
<li><p>internal private network is created, which the host and containers attach to and</p></li>
</ul>
<p>containers get their own internal private IPs
- docker calls the default bridge as ‘bridge’, but the host sees it as ‘docker0’
- docker creates a network namespace for a container by default and attach it to the
bridge, naming interfaces as odd/even pairs
- docker provides port mapping for external networks to reach the container</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="container-runtime-interface-cri">
<h3>Container Runtime Interface (CRI)<a class="headerlink" href="#container-runtime-interface-cri" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to communicate with container runtime such as docker, rkt, cri-o</p></li>
</ul>
</div></blockquote>
</section>
<section id="container-storage-interface-csi">
<h3>Container Storage Interface (CSI)<a class="headerlink" href="#container-storage-interface-csi" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>can have custom driver to work with custom storage on K8s such as PortWorx, AWS EBS, EMC</p></li>
<li><p>not just a K8s standard, universal one to allow any container orchestration tool to work</p></li>
</ul>
<p>with storage vendors, K8s, Cloud Foundry and Mesos are on board
* CSI defines sets of RPC</p>
</div></blockquote>
</section>
<section id="container-network-interface-cni">
<h3>Container Network Interface (CNI)<a class="headerlink" href="#container-network-interface-cni" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>set of standards to extend support for different networking solutions</p></li>
<li><p>a plugin is built using the standards</p></li>
<li><p>different container runtimes use the plugin by passing cid and namespace to configure</p></li>
</ul>
<p>network for the container
* <strong>standards for container runtimes</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>container runtime must create network namespace</p></li>
<li><p>identify network the container must attach to</p></li>
<li><p>container runtime to invoke Network Plugin when container is added</p></li>
<li><p>container runtime to invoke Network Plugin when container is deleted</p></li>
<li><p>JSON format of the Network Configuration</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt><strong>standards for plugins</strong></dt><dd><ul>
<li><p>must support command line arguments ADD/DEL/CHECK</p></li>
<li><p>must support parameters such as container id, network ns</p></li>
<li><p>must manage IP address assignment to pods</p></li>
<li><p>must return results in a specific format</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>support bridge, vlan, ipvlan, macvlan, windows, dhcp, host-local</p></li>
<li><p>third-party plugins such as Weave-net, Flannel, Cilium, VMware NSX</p></li>
<li><dl class="simple">
<dt><strong>Container Network Model (CNM)</strong></dt><dd><ul>
<li><p>docker’s own standards, does not use CNI but similar</p></li>
<li><p>cannot use <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--network=cni-bridge</span> <span class="pre">nginx</span></code></p></li>
<li><p>must create container without network and manually invoke the plugin</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="container-sandboxing">
<h3>Container Sandboxing<a class="headerlink" href="#container-sandboxing" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>using Seccomp, AppArmor</p></li>
<li><dl class="simple">
<dt>allowlist</dt><dd><ul class="simple">
<li><p>blocks everything by default</p></li>
<li><p>useful when every syscalls of the application is known</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>denylist</dt><dd><ul class="simple">
<li><p>allows everything by default</p></li>
<li><p>useful when want to make rules not much restricted or want to apply the rules to</p></li>
</ul>
<p>different applications</p>
</dd>
</dl>
</li>
<li><p>writing efficient profiles for hundreds of application is not easy, even with third-party</p></li>
</ul>
<p>tools
* choose which best work for the environment</p>
</div></blockquote>
</section>
<section id="system-calls">
<h3>System Calls<a class="headerlink" href="#system-calls" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>applications and processes, in user space, make system calls to kernel, in kernel space,</p></li>
</ul>
<p>to perform anything
* by default, Linux allows processes to invoke any syscalls from user space
* <strong>strace</strong></p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">strace</span> <span class="pre">touch</span> <span class="pre">/tmp/newfile.log</span></code>, <code class="docutils literal notranslate"><span class="pre">strace</span> <span class="pre">-c</span> <span class="pre">touch</span> <span class="pre">/tmp/newfile.log</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">strace</span> <span class="pre">-p</span> <span class="pre">PID</span></code>, trace a running process</p></li>
</ul>
</div></blockquote>
<ul>
<li><dl>
<dt><strong>Aquasec tracee</strong></dt><dd><ul class="simple">
<li><p>make use of eBPF, which can run programs directly in kernel space without</p></li>
</ul>
<p>interfering with kernel code or loading modules
- need bind mounts when using as container, <code class="docutils literal notranslate"><span class="pre">/tmp/tracee</span></code>, <code class="docutils literal notranslate"><span class="pre">/lib/modules</span></code>, <code class="docutils literal notranslate"><span class="pre">/usr/src</span></code>
- container also needs to privileged
- <code class="docutils literal notranslate"><span class="pre">trace</span> <span class="pre">comm=ls</span></code>, <code class="docutils literal notranslate"><span class="pre">trace</span> <span class="pre">pid=new</span></code>, <code class="docutils literal notranslate"><span class="pre">trace</span> <span class="pre">container=new</span></code></p>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>seccomp</strong></dt><dd><ul class="simple">
<li><p>Secure Computing, kernel level feature to sandbox processes to only use necessary</p></li>
</ul>
<p>syscalls
- <code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">Seccomp</span> <span class="pre">/proc/pid/status</span></code>, Seccomp value 2 means it is implemented
- modes: 0 (disabled), 1 (strict), 2 (filtered)
- docker has built-in seccomp filter used by default, if the host kernel has seccomp
enabled
- using allowlist type will need to know every syscalls made by the application
- denylist type are easier and flexible, but susceptible to attacks
- container with custom seccomp, <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--security-opt</span> <span class="pre">seccomp=/root/custom.json</span></code>
- docker’s default seccomp profile blocks 64 syscalls and mode 2
- cannot restrict a program access to certain objects, such as files or directory</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;defaultAction&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SCMP_ACT_ERRNO&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;architectures&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;SCMP_ARCH_X86_64&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;SCMP_ARCH_X86&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;SCMP_ARCH_X32&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;syscalls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;names&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;syscall-1&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;syscall-2&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;syscall-3&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SCMP_ACT_ALLOW&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;defaultAction&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SCMP_ACT_ALLOW&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;architectures&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="s2">&quot;SCMP_ARCH_X86_64&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;SCMP_ARCH_X86&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s2">&quot;SCMP_ARCH_X32&quot;</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="nt">&quot;syscalls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;names&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">                </span><span class="s2">&quot;syscall-1&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;syscall-2&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s2">&quot;syscall-3&quot;</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SCMP_ACT_ERRNO&quot;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="apparmor">
<h3>AppArmor<a class="headerlink" href="#apparmor" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>Linux security module to confined a program to limited resources</p></li>
<li><p>installed by default on Debian/Ubuntu, <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/sys/module/apparmor/parameters/enabled</span></code></p></li>
<li><p>check loaded profiles, <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/sys/kernel/security/apparmor/profiles</span></code></p></li>
<li><p>[profiles](profiles) are text files that define what resources can be used by application</p></li>
<li><p>check profiles loaded, <code class="docutils literal notranslate"><span class="pre">aa-status</span></code></p></li>
<li><p>modes: enforce, complain, unconfined</p></li>
<li><dl class="simple">
<dt>use <code class="docutils literal notranslate"><span class="pre">apparmor-utils</span></code> to create profiles</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">aa-genprof</span> <span class="pre">/path/to/app</span></code>, need to run the app so that it can scan events</p></li>
<li><p>severity range with 10 being highest</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/etc/apparmor.d/root.app</span></code>, default profile location</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">apparmor_parser</span> <span class="pre">/etc/apparmor.d/root.app</span></code>, load profile</p></li>
<li><p>disable profile, <code class="docutils literal notranslate"><span class="pre">apparmor_parser</span> <span class="pre">-R</span> <span class="pre">/etc/apparmor.d/root.ap</span></code>, and
<code class="docutils literal notranslate"><span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/etc/apparmor.d/root.app</span> <span class="pre">/etc/apparmor.d/disable/</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span># apparmor-deny-write
profile apparmor-deny-write flags=(attach_disconnected) {
    file, # allow access to entire filesystem
    deny /** w, # deny all file writes
}

# apparmor-deny-remount-root
profile apparmor-deny-remount-root flags=(attach_disconnected) {
    deny mount options=(ro, remount) -&gt; /, # deny remount readonly the root filesystem
}
</pre></div>
</div>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#nodes">Nodes</a>, <a class="reference internal" href="#cluster">Cluster</a>, <a class="reference internal" href="#control-plane">Control Plane</a>, <a class="reference internal" href="#worker-nodes">Worker Nodes</a></p></li>
<li><p>many of the component that make up the cluster are actually deployed using K8s itself, which</p></li>
</ul>
<p>are in <cite>kube-system</cite> namespace</p>
<section id="nodes">
<h3>Nodes<a class="headerlink" href="#nodes" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>physical or virtual machine on which K8s tools are installed</p></li>
<li><dl class="simple">
<dt><strong>kubelet</strong></dt><dd><ul>
<li><p>agent that runs on each node in the cluster</p></li>
<li><p>listens for instructions form kube-apiserver</p></li>
<li><p>responsible for making sure that the containers are running on the node as expected</p></li>
<li><p>point of contact for nodes with the control-plane</p></li>
<li><p>monitor and sends back status of the nodes at regular interval</p></li>
<li><p>registers the node with K8s cluster</p></li>
<li><p>requests the CRI a pod needs to be loaded</p></li>
<li><p>kubeadm does not auto depoly kubelet</p></li>
<li><p>must always manually install on worker nodes</p></li>
<li><p>can be searched as a process <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">kubelet</span></code> on the worker node</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>kube-proxy</strong></dt><dd><ul>
<li><p>responsible for routing network traffic to load-balanced services in the cluster</p></li>
<li><p>process that is required to run on each node</p></li>
<li><p>ensures that necessary rules are placed on worker nodes to allow containers to
communicate</p></li>
<li><p>looks for new services and creates appropriate rules on each node to forward traffic
to those services to the backend pods</p></li>
<li><p>create IP table rules on each node and forward IP heading of the service to that of
the actual pod</p></li>
<li><p>can download from K8s releases and run it as a service</p></li>
<li><p>list proxies, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">daemonSets</span> <span class="pre">--namespace=kube-system</span> <span class="pre">kube-proxy</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p><strong>kubeadm</strong> is deployed as pod in kube-system namespace on each node as daemonset</p></li>
</ul>
</div></blockquote>
</section>
<section id="cluster">
<h3>Cluster<a class="headerlink" href="#cluster" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>a group of nodes for high availability</p></li>
</ul>
</div></blockquote>
</section>
<section id="control-plane">
<h3>Control Plane<a class="headerlink" href="#control-plane" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>a node where K8s control plane components are installed</p></li>
<li><p>watches over the nodes in cluster and is responsible for orchestration of containers in
the worker nodes</p></li>
<li><p>has kube-apiserver, etcd, kube-controller-manager, kube-scheduler</p></li>
<li><dl class="simple">
<dt><strong>kube-apiserver</strong></dt><dd><ul>
<li><p>front-end for K8s</p></li>
<li><p>users, devices and interfaces talk to it to interact with K8s cluster</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>etcd</strong></dt><dd><ul>
<li><p>distributed key/value store to store all data used to manage the cluster</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>kube-scheduler</strong></dt><dd><ul>
<li><p>responsible for distributing work or containers across multiple nodes</p></li>
<li><p>look for newly created containers and assign them to appropriate nodes</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>kube-controller-manager</strong></dt><dd><ul>
<li><p>brain behind orchestration</p></li>
<li><p>make decisions to bring up new containers</p></li>
<li><p>processes that monitor objects and respond</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>coredns</strong></dt><dd><ul>
<li><p>provides naming and discovery for the services in the cluster</p></li>
<li><p>DNS server also runs as a replicated service on the cluster,
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">depolyments</span> <span class="pre">--namespace=kube-system</span> <span class="pre">coredns</span></code></p></li>
<li><p>DNS service is runs as a deployment,
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">services</span> <span class="pre">--namespace=kube-system</span> <span class="pre">coredns</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="worker-nodes">
<h3>Worker Nodes<a class="headerlink" href="#worker-nodes" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>worker machines where the containers will be launched</p></li>
<li><p>also called minions before</p></li>
<li><p>container runtime needs to be installed</p></li>
<li><dl class="simple">
<dt><strong>Container Runtime</strong></dt><dd><ul>
<li><p>underlying software to run containers</p></li>
<li><p>eg. Docker, rkt, CRI-O, containerd</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="setting-up-k8s">
<h2>Setting up K8s<a class="headerlink" href="#setting-up-k8s" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#kubeadm">kubeadm</a>, <a class="reference internal" href="#microk8s">MicroK8s</a>, <a class="reference internal" href="#minikube">minikube</a></p></li>
</ul>
<section id="kubeadm">
<h3>kubeadm<a class="headerlink" href="#kubeadm" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to bootstrap and manage production grade K8s clusters</p></li>
<li><dl class="simple">
<dt>setup</dt><dd><ul>
<li><p>setup multiple systems or VMs, use tools such as Vagrant</p></li>
<li><p>designate one system as control-plane node and others as worker nodes</p></li>
<li><p>install container runtime and kubeadm tool on all nodes</p></li>
<li><p>initialize the control-plane node, required components will be installed</p></li>
<li><p>setup a POD network, make sure all network requirements are met</p></li>
<li><p>join the worker nodes to the control-plane</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>[kubeadm](<a class="reference external" href="https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="microk8s">
<h3>MicroK8s<a class="headerlink" href="#microk8s" title="Link to this heading">#</a></h3>
</section>
<section id="minikube">
<h3>minikube<a class="headerlink" href="#minikube" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>easiest way to start K8s on local system</p></li>
<li><p>bundles all components of K8s into an image, providing a single-node K8s cluster</p></li>
<li><p>bundle is available as iso file to download</p></li>
<li><p>provides an executable command line utility to auto download the iso and deploy in
virtualization platform such as VirtualBox, KVM, HyperV</p></li>
<li><p>must have hyper visor and kubectl installed</p></li>
<li><p>[minikube](<a class="reference external" href="https://minikube.sigs.k8s.io/docs/start/">https://minikube.sigs.k8s.io/docs/start/</a>)</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>also has hosted solutions on GCP, AWS, Azure, IBM Cloud</dt><dd><ul>
<li><dl class="simple">
<dt><strong>GKE</strong></dt><dd><ul>
<li><p>need GCP account with billing enabled and <code class="docutils literal notranslate"><span class="pre">gcloud</span> <span class="pre">tool</span></code> installed</p></li>
<li><p>set default zone, <code class="docutils literal notranslate"><span class="pre">gcloud</span> <span class="pre">config</span> <span class="pre">set</span> <span class="pre">compute/zone</span> <span class="pre">us-west1-a</span></code></p></li>
<li><p>create cluster, <code class="docutils literal notranslate"><span class="pre">gcloud</span> <span class="pre">container</span> <span class="pre">clusters</span> <span class="pre">create</span> <span class="pre">my-cluster</span> <span class="pre">--num-nodes-3</span></code></p></li>
<li><p>get credentials, <code class="docutils literal notranslate"><span class="pre">gcloud</span> <span class="pre">container</span> <span class="pre">clusters</span> <span class="pre">get-credentials</span> <span class="pre">my-cluster</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>AKS</strong></dt><dd><ul>
<li><p>can use built-in Azure Cloud Shell in Azure portal or install <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">CLI</span> <span class="pre">tool</span></code></p></li>
<li><p>create resource group, <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">group</span> <span class="pre">create</span> <span class="pre">--name=test</span> <span class="pre">--location=westus</span></code></p></li>
<li><p>create cluster, <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">create</span> <span class="pre">--resource-group=test</span> <span class="pre">--name=my-cluster</span></code></p></li>
<li><p>get credentials, <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">get-credentials</span> <span class="pre">--resource-group=test</span> <span class="pre">--name=my-cluster</span></code></p></li>
<li><p>install kubectl if needed, <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">aks</span> <span class="pre">install-cli</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>EKS</strong></dt><dd><ul>
<li><p>install <code class="docutils literal notranslate"><span class="pre">eksctl</span> <span class="pre">tool</span></code></p></li>
<li><p>create cluster, <code class="docutils literal notranslate"><span class="pre">eksctl</span> <span class="pre">create</span> <span class="pre">cluster</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="kubectl">
<h2>kubectl<a class="headerlink" href="#kubectl" title="Link to this heading">#</a></h2>
<ul>
<li><p><a href="#id39"><span class="problematic" id="id40">`apply`_</span></a>, <a href="#id41"><span class="problematic" id="id42">`proxy`_</span></a>, <a href="#id43"><span class="problematic" id="id44">`port-forward`_</span></a></p></li>
<li><p>tool used to deploy and manage applications, called API objects, on the cluster</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>run<span class="w"> </span>--replicas<span class="o">=</span><span class="m">1000</span><span class="w"> </span>my-app

<span class="c1"># view info about cluster</span>
kubectl<span class="w"> </span>cluster-info
<span class="c1"># verify cluster health</span>
kubectl<span class="w"> </span>get<span class="w"> </span>componentstatuses

<span class="c1"># list all the pods part of the cluster</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods
<span class="c1"># list all pods with more information</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>wide
<span class="c1"># remove headers from output</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>wide<span class="w"> </span>--no-headers
<span class="c1"># monitor the state</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--watch

<span class="c1"># list all the nodes part of the cluster</span>
kubectl<span class="w"> </span>get<span class="w"> </span>nodes

<span class="c1"># create deployment</span>
kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>hello-minikube<span class="w"> </span>--image<span class="o">=</span>k8s.gcr.io/echoserver:1.4

<span class="c1"># view deployment</span>
kubectl<span class="w"> </span>get<span class="w"> </span>deployments

<span class="c1"># expose deployment as a service</span>
kubectl<span class="w"> </span>expose<span class="w"> </span>deployment<span class="w"> </span>hello-node<span class="w"> </span>--type<span class="o">=</span>LoadBalancer<span class="w"> </span>--port<span class="o">=</span><span class="m">8080</span>

<span class="c1"># view services</span>
kubectl<span class="w"> </span>get<span class="w"> </span>services

<span class="c1"># get multiple objects</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods,deployments,services

<span class="c1"># list supported fields</span>
kubectl<span class="w"> </span>explain<span class="w"> </span>pods

<span class="c1"># execute commands in container</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>myapp-pod<span class="w"> </span>--<span class="w"> </span>sh

<span class="c1"># attach to running process</span>
kubectl<span class="w"> </span>attach<span class="w"> </span>-it<span class="w"> </span>myapp-pod

<span class="c1"># copy files from pod to local (tar must be installed in the container)</span>
kubectl<span class="w"> </span>cp<span class="w"> </span>myapp-pod:test.sh<span class="w"> </span>/local/dir/test.sh

<span class="c1"># view latest 10 events on all objects</span>
kubectl<span class="w"> </span>get<span class="w"> </span>events

<span class="c1"># get URL of the service if using minikube</span>
minikube<span class="w"> </span>service<span class="w"> </span>hello-minikube<span class="w"> </span>--url

<span class="c1"># clean up</span>
kubectl<span class="w"> </span>delete<span class="w"> </span>services<span class="w"> </span>hello-minikube
kubectl<span class="w"> </span>delete<span class="w"> </span>deployment<span class="w"> </span>hello-minikube
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<section id="kubectl-apply">
<h3>kubectl apply<a class="headerlink" href="#kubectl-apply" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>consider ‘local config file’, ‘live object definition’ and ‘last applied config’ before</p></li>
</ul>
<p>making changes
* only modify objects that are different from the current objects
* if objects already exist, it will exit successfully without making changes
* create object if not exists and live object config is created within K8s with additional
fields
* local file is converted to json and stored as last applied config
* for any update to the object, all three are compared to identify what changes are to be
made on the live object
* if a field in local is deleted, it is compared with last applied config and the field is
removed in live config
* last applied config is stored on the live object config itself as an annotation
* can add <code class="docutils literal notranslate"><span class="pre">--dry-run</span></code> flag to view changes without modifying the object
* can manipulate records with <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">apply</span> <span class="pre">-f</span> <span class="pre">definition.yml</span> <span class="pre">edit-last-applied</span></code>, or
<code class="docutils literal notranslate"><span class="pre">set-last-applied</span></code>, <code class="docutils literal notranslate"><span class="pre">view-last-applied</span></code>
* <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">create</span></code> and <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">replace</span></code> do no store last applied config
* do not mix imperative and declarative approaches
* useful when using loops to create objects from multiple files</p>
</div></blockquote>
</section>
<section id="kubectl-proxy">
<h3>kubectl proxy<a class="headerlink" href="#kubectl-proxy" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">proxy</span></code> will start a proxy, default on port 8001, which doesn’t need credentials</p></li>
</ul>
<p>to access the cluster
* will use the credentials from config file and forward the requests to kube-apiserver</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://localhost:8001</span> <span class="pre">-k</span></code></p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>can proxy requests to any services, even if the services are not exposed</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://localhost:8001/api/v1/namespaces/default/services/nginx/proxy</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="kubectl-port-forward">
<h3>kubectl port-forward<a class="headerlink" href="#kubectl-port-forward" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>takes pod, deployment, service or replicaset as argument, HOST_PORT:PORT_ON_CLUSTER</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">port-forward</span> <span class="pre">service/nginx</span> <span class="pre">28080:80</span></code></p></li>
<li><p>any request to <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://localhost:28080</span></code> is forwarded to service on port 80 on the</p></li>
</ul>
<p>cluster</p>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">proxy</span></code> and <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">port-forward</span></code> are useful when accessing a remote cluster</p></li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">kubectl</span></code> outputs plain-text format by default</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">-o</span></code> flag allows to different format output</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">json</span></code>, <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">yaml</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">name</span></code>: only resource name</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">wide</span></code>: plain-text format with additional information</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="etcd">
<h2>etcd<a class="headerlink" href="#etcd" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>distributed key-value store that provides a reliable way to store data that needs to be</p></li>
</ul>
<p>accessed by a distributed system or cluster of machines
* etcd service listens on port 2379 by default
* can attach clients to the service
* etcdctl: CLI tool to use to store key/value pairs, has version 2 (default) and 3, with
different commands
* must specify certificate files for etcdctl to authenticate etcd api server</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>etcdctl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>key1<span class="w"> </span>value1
etcdctl<span class="w"> </span>get<span class="w"> </span>key1

<span class="c1"># etcdctl version 2</span>
etcdctl<span class="w"> </span>backup
etcdctl<span class="w"> </span>cluster-health
etcdctl<span class="w"> </span>mk
etcdctl<span class="w"> </span>mkdir
etcdctl<span class="w"> </span><span class="nb">set</span>

<span class="c1"># etcdctl version 3</span>
etcdctl<span class="w"> </span>snapshot<span class="w"> </span>save
etcdctl<span class="w"> </span>endpoint<span class="w"> </span>health
etcdctl<span class="w"> </span>get
etcdctl<span class="w"> </span>put

<span class="c1"># set version</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
<ul>
<li><p>stores information about the cluster</p></li>
<li><p>every info from <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span></code> command is from etcd server</p></li>
<li><p>every change in cluster are updated in etcd server</p></li>
<li><p>the change is complete only if it is updated in etcd server</p></li>
<li><p>can be deployed differently</p></li>
<li><dl>
<dt>manual setup</dt><dd><ul class="simple">
<li><p>download etcd binary and configure etcd as a service on controlplane node</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--advertise-client-urls</span> <span class="pre">https://${INTERNAL_IP}:2379</span></code>, URL that should be configured on</p></li>
</ul>
<p>kube-apiserver</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>using kubeadm</dt><dd><ul class="simple">
<li><p>deploy etcd service as a pod in kube-system namespace</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">exec</span> <span class="pre">etcd-master</span> <span class="pre">-n</span> <span class="pre">kube-system</span> <span class="pre">etcdctl</span> <span class="pre">get</span> <span class="pre">/</span> <span class="pre">--prefix</span> <span class="pre">-keys-only</span></code>, list all keys</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>in high availability environment, set the right parameters to make sure multiple etcd</p></li>
</ul>
<dl class="simple">
<dt>instances know about each other</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--initial-cluster</span></code>, to specify different instances of etcd service</p></li>
</ul>
</dd>
</dl>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
<section id="pods">
<h2>Pods<a class="headerlink" href="#pods" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#creating-pods">Creating Pods</a>, <a class="reference internal" href="#generating-yaml">Generating YAML</a>, <a class="reference internal" href="#editing-pods">Editing Pods</a>, <a class="reference internal" href="#copying-files">Copying Files</a></p></li>
<li><p><a class="reference internal" href="#static-pods">Static Pods</a>, <a class="reference internal" href="#init-containers">Init Containers</a>, <a class="reference internal" href="#multi-container-pods">Multi-Container pods</a></p></li>
<li><p>objects, in nodes, in which containers are encapsulated as K8s does not deploy containers</p></li>
</ul>
<p>directly on the worker nodes
* smallest object in K8s containing single instance of the application
* a new pod with a single instance is created as needed
* one-to-one relationship with containers
* each container in a pod runs in its own cgroup but share a number of Linux namespaces
* single pod can have multiple containers which are not same kind, as in helper containers
* helper container has one-to-one relationship with application container to access data, and
can communicate directly by referring to as <cite>localhost</cite> as they share same network space
* applications in different pods are isolated from each other
* when designing pods, it is necessary to know if containers will work correctly if they land
on different machines</p>
<section id="creating-pods">
<h3>Creating Pods<a class="headerlink" href="#creating-pods" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl>
<dt>using <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">run</span></code></dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--image</span></code> specify image from Docker hub, by default, or private registry</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>run<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>nginx

<span class="c1"># list pods</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods

<span class="c1"># additional info about pods</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-o<span class="w"> </span>wide

<span class="c1"># get info about pod</span>
kubectl<span class="w"> </span>describe<span class="w"> </span>pod<span class="w"> </span>POD_NAME

<span class="c1"># get logs of running instance</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>mypod
<span class="c1"># get logs from previous instance of the container</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>mypod<span class="w"> </span>--previous

<span class="c1"># deleting a pod can take time as it has to send killsig to the process running</span>
kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>POD_NAME
kubectl<span class="w"> </span>delete<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="nv">LABEL_NAME</span><span class="o">=</span>LABEL
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>using manifest (YAML) file, declarative configuration</dt><dd><ul class="simple">
<li><p>can use YAML or JSON</p></li>
<li><p>YAML is more preferred as it is more human-editable and supports comments</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># create pod from yml file, &#39;create&#39; and &#39;apply&#39; works same if creating new pod</span>
kubectl<span class="w"> </span>create<span class="w"> </span>-f<span class="w"> </span>pod-definition.yml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>pod-definition.yml
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<ul>
<li><p>K8s API server accepts and processes pod manifests before storing them in etcd</p></li>
<li><dl>
<dt>the scheduler also uses K8s API to find pods that haven’t been scheduled to a node</dt><dd><ul class="simple">
<li><p>scheduler tries to ensure that pods from same application are distributed onto different</p></li>
</ul>
<p>machines fro reliability
* once scheduled, pods don’t move and must be explicitly destroyed and rescheduled</p>
</dd>
</dl>
</li>
<li><dl>
<dt>by default, all pods have a termination grace period of 30 seconds</dt><dd><ul class="simple">
<li><p>it is important for reliability as it allows the pod to finish any active requests that</p></li>
</ul>
<p>it may be in the middle of processing</p>
</dd>
</dl>
</li>
</ul>
</section>
<section id="generating-yaml">
<h3>Generating YAML<a class="headerlink" href="#generating-yaml" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">run</span> <span class="pre">nginx</span> <span class="pre">--image=nginx</span> <span class="pre">--dry-run</span> <span class="pre">-o</span> <span class="pre">yaml</span></code> will output</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">creationTimestamp</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">run</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
<span class="w">  </span><span class="nt">dnsPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterFirst</span>
<span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="nt">status</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="editing-pods">
<h3>Editing Pods<a class="headerlink" href="#editing-pods" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>can only edit <code class="docutils literal notranslate"><span class="pre">spec.containers[*].image</span></code>, <code class="docutils literal notranslate"><span class="pre">spec.initContainers[*].image</span></code>,</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">spec.tolerations</span></code>, <code class="docutils literal notranslate"><span class="pre">spec.activeDeadlineSeconds</span></code>
* cannot edit env variables, service accounts, resource limits of a running pod</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># run the command and edit the file, delete and create the pod with the edited file</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pod<span class="w"> </span>myapp-pod<span class="w"> </span>-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>pod-definition.yml

<span class="c1"># to edit in text editor, the file will be saved as temp, delete the pod and use the temp</span>
<span class="c1"># file tot create a new pod</span>
kubectl<span class="w"> </span>edit<span class="w"> </span>pod<span class="w"> </span>myapp-pod
<span class="c1"># not recommended in production</span>
kubectl<span class="w"> </span>replace<span class="w"> </span>--force<span class="w"> </span>-f<span class="w"> </span>/tmp/tmp-file.yml

<span class="c1"># to change image of the pod</span>
kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>image<span class="w"> </span>pod/myapp-pod<span class="w"> </span>nginx-container<span class="o">=</span>nginx:NEW_VERSION

<span class="c1"># add labels</span>
kubectl<span class="w"> </span>label<span class="w"> </span>pods<span class="w"> </span>myapp-pod<span class="w"> </span><span class="nv">type</span><span class="o">=</span><span class="nb">test</span>

<span class="c1"># remove labels</span>
kubectl<span class="w"> </span>label<span class="w"> </span>pods<span class="w"> </span>myapp-pod<span class="w"> </span>type-
</pre></div>
</div>
</div></blockquote>
</section>
<section id="copying-files">
<h3>Copying Files<a class="headerlink" href="#copying-files" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>copying files into a container is an antipattern but can be an immediate way to restore</p></li>
</ul>
<p>service health</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>cp<span class="w"> </span>LOCAL_DIR<span class="w"> </span>mypod:POD_DIR
kubectl<span class="w"> </span>cp<span class="w"> </span>namespace/mypod:POD_DIR<span class="w"> </span>LOCAL_DIR
</pre></div>
</div>
</div></blockquote>
</section>
<section id="static-pods">
<h3>Static Pods<a class="headerlink" href="#static-pods" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>pods that are created by kubelet on its own without the intervention of the API server or</p></li>
</ul>
<p>other K8s cluster components
* kubelet can be configured to read the definition files from a directory on a server
designated to store information about pods, <cite>/etc/kubernetes/manifests</cite>
* kubelet will periodically read the files and create pods on the host, ensuring the pods
stay alive
* if the files are removed, the pods will be deleted
* only pods can be created this way as kubelet works at pod level and only understand pods
* can pass the directory in <code class="docutils literal notranslate"><span class="pre">--pod-manifest</span></code> options
* or provide <code class="docutils literal notranslate"><span class="pre">--config=customconfig.yml</span></code> options and define <code class="docutils literal notranslate"><span class="pre">staticPodPath</span></code> in that file,
this approach is used by cluters setup by the kubeadm
* can view the pods with <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">ps</span></code>, as kube-apiserver is not used
* node name is appended at the end of the pod name, e.g etcd-controlplane, podName-node01
* kubelet can create static pods and pods from API server at the same time, as its job is
to create a pod that is given as input
* if both kinds of pods are created, kube-apiserver can detect the static pods but only
view details about the pods, cannot edit or delete them
* if the pod is part of the cluster, kubelet also creates a mirror object of the pod in
kube-apiserver
*  as static pods are not part of the control-plane, they can be used to deploy
control-plane components as pods on a node</p>
</div></blockquote>
</section>
<section id="init-containers">
<h3>Init Containers<a class="headerlink" href="#init-containers" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>configured in a pod like all other containers</p></li>
<li><p>run when a pod is first created and the process in the container must run to a completion</p></li>
</ul>
<p>before the real container hosting the application starts
* can configure multiple initContainers, each init container is run one at a time in
sequential order</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="nt">initContainers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">init-container1</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;some</span><span class="nv"> </span><span class="s">command</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">execute&#39;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">init-container2</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;some</span><span class="nv"> </span><span class="s">command</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">execute&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="multi-container-pods">
<h3>Multi-Container pods<a class="headerlink" href="#multi-container-pods" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>containers in the same pod share same lifecycle, network and storage</p></li>
<li><p>do not need to establish volume sharing or services between the pods to communicate</p></li>
<li><p>each container is expected to run a process that stays alive as long as the pod’s</p></li>
</ul>
<p>lifecycle
* the pod restarts if any of the containers fails</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-agent</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">log-agent</span>
</pre></div>
</div>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="services">
<h2>Services<a class="headerlink" href="#services" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#nodeport">NodePort</a>, <a class="reference internal" href="#clusterip">ClusterIP</a>, <a class="reference internal" href="#loadbalancer">LoadBalancer</a>, <a class="reference internal" href="#headless-services">Headless Services</a></p></li>
<li><p><a class="reference internal" href="#selector-less-services">Selector-less Services</a>, <a class="reference internal" href="#connect-from-external">Connect from External</a></p></li>
<li><p>service-discovery tools help solve the problem of finding which processes are listening at</p></li>
</ul>
<p>which addresses for which services
* services enable communications between applications and users
* are loosely coupled and span across multiple nodes and map the ports to the matching pods in
the cluster
* service objects are at Layer 4, only forward TCP and UDP connections without checking</p>
<section id="nodeport">
<h3>NodePort<a class="headerlink" href="#nodeport" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>the service listens on the node and forwards requests to the pod</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">targetPort</span></code>: port of the pod, omitting will be the same as <code class="docutils literal notranslate"><span class="pre">port</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">port</span></code>: port of the service, only mandatory field</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nodePort</span></code>: port of the node, omitting will be chosen random available free port</p></li>
<li><p>node port can only be in valid range 30000-32767, omitting will default to random valid</p></li>
<li><p>uses Random algorithm and has SessionAffinity</p></li>
<li><p>can use the NodePort without knowing where any of the pods for the service are running</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># service-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30008</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># labels of the pod</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>service-definition.yml
kubectl<span class="w"> </span>get<span class="w"> </span>services

<span class="c1"># if using minikube</span>
minikube<span class="w"> </span>service<span class="w"> </span>myapp-service<span class="w"> </span>--url
</pre></div>
</div>
</div></blockquote>
</section>
<section id="clusterip">
<h3>ClusterIP<a class="headerlink" href="#clusterip" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>default type</p></li>
<li><p>the service creates internal ip inside the cluster to enable communication</p></li>
<li><p>group the pods together and provide single interface to access the pods in the group</p></li>
<li><p>requests are forwarded randomly</p></li>
<li><p>allows to deploy microservices based application on K8s cluster</p></li>
<li><p>each layer can scale without impacting the communication</p></li>
<li><p>each service gets an ip and a name, which are used by pods</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">targetPort</span></code>: port of the layer (e.g back-end)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">port</span></code>: port of the service</p></li>
<li><dl class="simple">
<dt>DNS Service</dt><dd><ul>
<li><p>as cluster IP is virtual, it is stable and appropriate to give it a DNS address</p></li>
<li><p>K8s DNS service is installed as system component when the cluster is created</p></li>
<li><p>it provides DNS names for cluster IPs</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>address range is configured using <code class="docutils literal notranslate"><span class="pre">--service-cluster-ip-range</span></code> flag on the <code class="docutils literal notranslate"><span class="pre">kube-apiserver</span></code></p></li>
</ul>
<p>binary
* older mechanisms inject a set of ENV variables into pods at start up</p>
<blockquote>
<div><ul class="simple">
<li><p>it requires resources to be created in a specific order</p></li>
<li><p>services must be created before the pods that reference them</p></li>
</ul>
</div></blockquote>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># service-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">back-end</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">back-end</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="loadbalancer">
<h3>LoadBalancer<a class="headerlink" href="#loadbalancer" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>distribute load across servers</p></li>
<li><p>will be the same as <code class="docutils literal notranslate"><span class="pre">NodePort</span></code> in an unsupported environment as it is built on the</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">NodePort</span></code> type by additionally configuring the cloud to create a new load balancer
* most cloud-based clusters offer load balancer integration
* external load balancers connect to the public internet
* use internal load balancers to expose application only within private network which is
done in ad hoc manner via object annotations</p>
<blockquote>
<div><ul class="simple">
<li><p>Azure, <code class="docutils literal notranslate"><span class="pre">service.beta.kubernetes.io/azure-load-balancer-internal:</span> <span class="pre">&quot;true&quot;</span></code></p></li>
<li><p>AWS, <code class="docutils literal notranslate"><span class="pre">service.beta.kubernetes.io/aws-load-balancer-internal:</span> <span class="pre">&quot;true&quot;</span></code></p></li>
<li><p>Alibaba, <code class="docutils literal notranslate"><span class="pre">service.beta.kubernetes.io/alibaba-cloud-load-balancer-address-type:</span> <span class="pre">&quot;intranet&quot;</span></code></p></li>
<li><p>GCP, <code class="docutils literal notranslate"><span class="pre">cloud.google.com/load-balancer-type:</span> <span class="pre">&quot;Internal</span></code></p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>user can specify a specific cluster IP but once set, cannot be modified without deleting</p></li>
</ul>
<p>and recreating</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LoadBalancer</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30008</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="headless-services">
<h3>Headless Services<a class="headerlink" href="#headless-services" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>gives DNS entry, created as normal service but does not have IP and does not load balance</p></li>
<li><p>each pod has DNS in <code class="docutils literal notranslate"><span class="pre">podname.headless-servicename.namespace.svc.cluster-domain.example</span></code></p></li>
<li><p>e.g <code class="docutils literal notranslate"><span class="pre">mysql-0.mysql-h.default.svc.cluster.local</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">clusterIP</span></code> is the only difference from normal service</p></li>
<li><p>gives DNS entry to a pod only if it has <code class="docutils literal notranslate"><span class="pre">subdomain</span></code> and <code class="docutils literal notranslate"><span class="pre">hostname</span></code> under <code class="docutils literal notranslate"><span class="pre">spec</span></code></p></li>
<li><p>pods created by StatefulSet gets the right <code class="docutils literal notranslate"><span class="pre">subdomain</span></code> and <code class="docutils literal notranslate"><span class="pre">hostname</span></code> automatically, no</p></li>
</ul>
<p>need to specify in definition file but <cite>serviceName</cite> is required</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># headless-service.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql-h</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3306</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">  </span><span class="nt">clusterIP</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">None</span>

<span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">subdomain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql-h</span>
<span class="w">  </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql-pod</span>

<span class="c1"># deployment-definition.yml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># all 3 pods will have same domain name</span>
<span class="w">      </span><span class="nt">subdomain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql-h</span>
<span class="w">      </span><span class="nt">hostname</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql-pod</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubeclt</span> <span class="pre">expose</span> <span class="pre">deployment</span> <span class="pre">myapp</span></code> will pull both the label selector and relevant ports from</p></li>
</ul>
<p>the deployment definition
* service object track which pods are ready via a readiness check
* for every Service object, Endpoints object is created that contains the IP addresses for that
service
* as services are built on top of label selectors over pods, K8s API can be used for basic
service discovery without using a Service object, <cite>kubectl get pods -o wide</cite>
* <code class="docutils literal notranslate"><span class="pre">kube-proxy</span></code> watches for new services and makes a set of iptables rules in the kernel of the
host to rewrite the destinations of packets to direct them to the endpoints</p>
</section>
<section id="selector-less-services">
<h3>Selector-less Services<a class="headerlink" href="#selector-less-services" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>can be used to declare a K8s service with manually assigned IP address that is outside of</p></li>
</ul>
<p>the cluster
*  service discovery via DNS works as expected
* to create, remove <code class="docutils literal notranslate"><span class="pre">spec.selecotr``field</span> <span class="pre">from</span> <span class="pre">the</span> <span class="pre">resource,</span> <span class="pre">while</span> <span class="pre">leaving</span> <span class="pre">the</span> <span class="pre">``metadata</span></code>
and <cite>ports</cite> section unchanged
* endpoints must be added manually
* will need to update the endpoint resource if the IP address changes</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Endpoints</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-external-server</span>
<span class="nt">subsets</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">addresses</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ip</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.1.1.1</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3000</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</section>
<section id="connect-from-external">
<h3>Connect from External<a class="headerlink" href="#connect-from-external" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>connecting external resources to K8s services is complex</p></li>
<li><dl class="simple">
<dt>if cloud provider supports</dt><dd><p>#. can create an internal load balancer in the virtual private network and deliver
traffic from a fixed IP address into the cluster and then use DNS to make the IP
address available to the external resources
#. can use <code class="docutils literal notranslate"><span class="pre">NodePort</span></code> service to expose the service on the IP addresses of the nodes in
the cluster and program a physical load balancer to serve traffic to the nodes or use
DNS-based load balancing to spread traffic between nodes</p>
</dd>
</dl>
</li>
<li><p>can run <code class="docutils literal notranslate"><span class="pre">kube-proxy</span></code> on the external resource and program it to use the DNS server in the</p></li>
</ul>
<p>cluster
* other open source solutions, such as HashiCorp Consul, can be used to manage connectivity
between in-cluster and out-of-cluster resources</p>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="workloads">
<h2>Workloads<a class="headerlink" href="#workloads" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#replication-controller">Replication Controller</a>, <a class="reference internal" href="#replicaset">ReplicaSet</a>, <a class="reference internal" href="#deployments">Deployments</a>, <a class="reference internal" href="#deployment-strategies">Deployment Strategies</a></p></li>
<li><p><a class="reference internal" href="#statefulsets">StatefulSets</a>, <a class="reference internal" href="#daemonset">Daemonset</a>, <a class="reference internal" href="#jobs">Jobs</a>, <a class="reference internal" href="#cronjobs">CronJobs</a></p></li>
</ul>
<section id="replication-controller">
<h3>Replication Controller<a class="headerlink" href="#replication-controller" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>helps run multiple instances of a single pod in a cluster for high availability</p></li>
<li><p>help renew a single pod if the existing one fails, can have self-healing applications</p></li>
<li><p>ensure the specified number of pods are running</p></li>
<li><p>load balance and scale based on demand across multiple nodes in a cluster</p></li>
<li><p>will not deploy already matching label pods</p></li>
<li><p>replaced by ReplicaSet</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># rc-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReplicationController</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-rc</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>

<span class="w">    </span><span class="c1"># pod</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>

<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>rc-definition.yml

kubectl<span class="w"> </span>get<span class="w"> </span>replicationcontroller

<span class="c1"># will see 3 pods</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods
</pre></div>
</div>
</div></blockquote>
</section>
<section id="replicaset">
<h3>ReplicaSet<a class="headerlink" href="#replicaset" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to manage pods, new recommended way to setup replication, self-healing applications</p></li>
<li><p>ensure the desired number of pods are running</p></li>
<li><p>can have <code class="docutils literal notranslate"><span class="pre">spec.selector</span></code> to identify what pods fall under it and <code class="docutils literal notranslate"><span class="pre">selector</span></code> should be</p></li>
</ul>
<p>a subset of the labels in the pod template
* <code class="docutils literal notranslate"><span class="pre">selector</span></code> is the major difference from <code class="docutils literal notranslate"><span class="pre">ReplicationController</span></code>, helps filter resources
* can make a ReplicaSet to use the existing pod and scale
* can modify the labels on the pod to disassociate from the ReplicaSet for debugging
* <code class="docutils literal notranslate"><span class="pre">annotations</span></code> are used to record details for information purpose
* always add <code class="docutils literal notranslate"><span class="pre">template</span></code> section even if pods are already created to maintain availability
in the future
* will not allow pods with the same label to be created again and terminate them if created
* ReplicaSets are for stateless services and every pod created is homogeneous
* arbitrary pod is selected for scaling and application’s behavior should not change when
scaled
* most use ReplicSets as default instead of pods, even for single pod</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># replicaset-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReplicaSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-replicaset</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">buildVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>

<span class="w">    </span><span class="c1"># pod</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>

<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># labels of pod</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>replicaset-definition.yml

kubectl<span class="w"> </span>get<span class="w"> </span>replicasets

kubectl<span class="w"> </span>get<span class="w"> </span>pods
kubectl<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span>--selector<span class="w"> </span><span class="nv">type</span><span class="o">=</span>front-end<span class="w"> </span>--no-headers<span class="w"> </span><span class="p">|</span><span class="w"> </span>wc<span class="w"> </span>-l
kubectl<span class="w"> </span>get<span class="w"> </span>po<span class="w"> </span>-l<span class="w"> </span><span class="nv">type</span><span class="o">=</span>front-end,app<span class="o">=</span>myapp

<span class="c1"># delete only ReplicaSet object, not the pods</span>
kubectl<span class="w"> </span>delete<span class="w"> </span>rs<span class="w"> </span>myapp-replicaset<span class="w"> </span>--cascade<span class="o">=</span><span class="nb">false</span>
</pre></div>
</div>
<ul>
<li><dl>
<dt>can edit <code class="docutils literal notranslate"><span class="pre">replicas</span></code> in the yml file to update and scale</dt><dd><ul class="simple">
<li><p>always make sure to update changes in yml file if updated with imperative commands</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>replace<span class="w"> </span>-f<span class="w"> </span>replicaset-definition.yml
<span class="c1"># OR (will not update the file)</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>--replicas<span class="o">=</span><span class="m">6</span><span class="w"> </span>-f<span class="w"> </span>replicaset-definition.yml
<span class="c1"># OR (will not update the file)</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>--replicas<span class="o">=</span><span class="m">6</span><span class="w"> </span>replicaset<span class="w"> </span>myapp-replicaset
<span class="c1"># OR (will open temp file to edit config)</span>
kubectl<span class="w"> </span>edit<span class="w"> </span>replicasets<span class="w"> </span>myapp-replicaset

kubectl<span class="w"> </span>describe<span class="w"> </span>replicaset<span class="w"> </span>myapp-replicaset
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">math-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">math-add</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;expr&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;+&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>HPA (Horizontal Pod Autoscaling)</dt><dd><ul class="simple">
<li><p>horizontal scaling: creating more pod replicas</p></li>
<li><p>vertical scaling: increasing resources required for a pod</p></li>
<li><p>need <code class="docutils literal notranslate"><span class="pre">metrics-server</span></code> in the cluster for auto scaling</p></li>
<li><p>scaling based on CPU usage is most common</p></li>
<li><p>not recommended to combine autoscaling with management of number of replicas</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>autoscale<span class="w"> </span>--min<span class="o">=</span><span class="m">2</span><span class="w"> </span>--max<span class="o">=</span><span class="m">4</span><span class="w"> </span>--cpu-percent<span class="o">=</span><span class="m">80</span><span class="w"> </span>rs<span class="w"> </span>myapp-replicaset

<span class="c1"># can use hpa resource</span>
kubectl<span class="w"> </span>get<span class="w"> </span>hpa
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>pod will restart again and again until threshold is reached as the policy is to restart</p></li>
</ul>
<p>always by default</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Always</span>
<span class="w">  </span><span class="c1"># OR</span>
<span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
<span class="w">  </span><span class="c1"># OR</span>
<span class="w">  </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Failure</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>pods created will have <code class="docutils literal notranslate"><span class="pre">ownerReferences</span></code> section and can be used to check which</p></li>
</ul>
<p>ReplicaSet manages</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>my-pod<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.metadata.ownerReferences[0].name}&#39;</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</section>
<section id="deployments">
<h3>Deployments<a class="headerlink" href="#deployments" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>manages ReplicaSets, object above ReplicaSet in hierarchy</p></li>
<li><p>can update underlying instances with rolling-update, undo and resume changes</p></li>
<li><p>uses health checks on new versions and stops if many failures occur</p></li>
<li><dl>
<dt><strong>Creating Deployments</strong></dt><dd><ul class="simple">
<li><p>using YAML file</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># deployment-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-deployment</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>

<span class="w">    </span><span class="c1"># pod</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>

<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># labels of pod</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>deployment-definition.yml

kubectl<span class="w"> </span>get<span class="w"> </span>deployments

<span class="c1"># deployment create replicaset</span>
kubectl<span class="w"> </span>get<span class="w"> </span>rs<span class="w"> </span>--selector<span class="o">=</span><span class="nv">type</span><span class="o">=</span>front-end

<span class="c1"># replicaset create pods</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods

<span class="c1"># get all objects</span>
kubectl<span class="w"> </span>get<span class="w"> </span>all
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Editing Deployments</strong></dt><dd><ul class="simple">
<li><p>can easily edit any field/property of the pod templates</p></li>
<li><p>every change in Deployment will auto delete and create a new pod</p></li>
<li><p>scaling the Deployment also scales the ReplicaSet, but not vice-versa</p></li>
<li><p>need to delete the Deployment with <code class="docutils literal notranslate"><span class="pre">--cascade=false</span></code> to manage the ReplicaSet directly</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>edit<span class="w"> </span>deploy<span class="w"> </span>myapp-deployment

kubeclt<span class="w"> </span>scale<span class="w"> </span>deployments<span class="w"> </span>myapp-deployment<span class="w"> </span>--replicas<span class="o">=</span><span class="m">3</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Rollout</strong></dt><dd><ul class="simple">
<li><p>when new Deployment is created, a new rollout is triggered, which creates a new</p></li>
</ul>
<p>revision
- updating will trigger a new rollout and revision
- <code class="docutils literal notranslate"><span class="pre">OldReplicaSets</span></code> and <code class="docutils literal notranslate"><span class="pre">NewReplicaSet</span></code> fields are set to values in the middle of the
rollout
- annotations can be used to record information about the update
- do not update <code class="docutils literal notranslate"><span class="pre">change-cause</span></code> annotation when simple scaling
- can undo regardless of the rollout stage
- recommended to edit YAML files to revert versions, rather than imperative <code class="docutils literal notranslate"><span class="pre">undo</span></code>
- roll back uses the previous template and renumbers it as the latest revision
- last 10 revisions are kept by default and can set maximum history size with
<code class="docutils literal notranslate"><span class="pre">spec.revisionHistoryLimit</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># record change cause</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>deployment-definition.yml<span class="w"> </span>--record

<span class="c1"># after editing definition file</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>deployment-definition.yml<span class="w"> </span>--record

<span class="c1"># or update from command</span>
kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>image<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span><span class="nv">nginx</span><span class="o">=</span>nginx:1.18

<span class="c1"># current status</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span>status<span class="w"> </span>deployment<span class="w"> </span>myapp-deployment

kubectl<span class="w"> </span>rollout<span class="w"> </span>pause<span class="w"> </span>deployment<span class="w"> </span>myapp-deployment
kubectl<span class="w"> </span>rollout<span class="w"> </span>resume<span class="w"> </span>deployment<span class="w"> </span>myapp-deployment

<span class="c1"># oldest to newest older</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span><span class="nb">history</span><span class="w"> </span>deployment<span class="w"> </span>myapp-deployment
<span class="c1"># specific revision</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span><span class="nb">history</span><span class="w"> </span>deployment<span class="w"> </span>myapp-deployment<span class="w"> </span>--revision<span class="o">=</span><span class="m">1</span>

kubectl<span class="w"> </span>rollout<span class="w"> </span>undo<span class="w"> </span>deployment<span class="w"> </span>myapp-deployment

<span class="c1"># rollback to specific revision</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span>undo<span class="w"> </span>deployment<span class="w"> </span>myapp-deployment<span class="w"> </span>--to-revision<span class="o">=</span><span class="m">3</span>
<span class="c1"># same as &#39;kubectl rollout undo&#39;</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span>undo<span class="w"> </span>deployment<span class="w"> </span>myapp-deployment<span class="w"> </span>--to-revision<span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>health checks</dt><dd><ul class="simple">
<li><p>set <code class="docutils literal notranslate"><span class="pre">spec.minReadySeconds</span></code> to make the Deployment wait to update next pod after</p></li>
</ul>
<p>current pod passes health check
- set <code class="docutils literal notranslate"><span class="pre">spec.progessDeadlineSeconds</span></code> to time out the rollout and mark it as failed when
there’s a bug and to avoid the Deployment being stalled forever
- timeout is defined as the time the Deployment creates or deletes a pod, not overall
length of a Deployment
- check <code class="docutils literal notranslate"><span class="pre">status.conditions</span></code> to check the Deployment state</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="deployment-strategies">
<h3>Deployment Strategies<a class="headerlink" href="#deployment-strategies" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>applications should be able to communicate with slightly older and newer versions</p></li>
<li><p>should maintain backward and forward compatibility for reliable updates</p></li>
<li><dl>
<dt><strong>Recreate</strong></dt><dd><ul class="simple">
<li><p>destroy all old versions first and create new versions</p></li>
<li><p>fast and simple, but workload downtime exists</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># deployment-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Recreate</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>RollingUpdate</strong></dt><dd><ul class="simple">
<li><p>default strategy, recommended for user-facing services</p></li>
<li><p>destroy old versions and create new versions one by one</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Deployment</span></code> create a new <code class="docutils literal notranslate"><span class="pre">replicaset</span></code> and upgrade one after another</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">rs</span></code> will show two <code class="docutils literal notranslate"><span class="pre">replicasets</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maxUnavailable</span></code> sets the max pods that can be unavailable during update and allows</p></li>
</ul>
<p>to trade speed for availability (Recreate strategy can be considered as
<code class="docutils literal notranslate"><span class="pre">maxUnavailable</span></code> set to 100%)
- can set <code class="docutils literal notranslate"><span class="pre">maxUnavailable</span></code> to 0 and use <code class="docutils literal notranslate"><span class="pre">maxSurge</span></code> to maintain 100% capacity and just
use extra resources for rollout
- <code class="docutils literal notranslate"><span class="pre">maxSurge</span></code> controls how many extra resources can be created for a rollout (setting
it to 100% is same a blue/green strategy)
- using percentage to set parameters is good approach</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># deployment-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>
<span class="w">  </span><span class="nt">strategy</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span>
<span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">25%</span>
<span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">25%</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RollingUpdate</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Blue/Green</strong></dt><dd><ul class="simple">
<li><p>new version (Green) is deployed alongside the old version (Blue)</p></li>
<li><p>all traffic is still routed to blue</p></li>
<li><p>deploy the new version first and perform necessary tests</p></li>
<li><p>once all tests are passed on green, all traffic is routed to green all at once</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># blue.yml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchingLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>

<span class="c1"># green.yml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchingLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>

<span class="c1"># service-definition.yml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span><span class="w"> </span><span class="c1"># old version</span>
<span class="w">    </span><span class="c1"># change once new version is ready</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v2</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Canary</strong></dt><dd><ul class="simple">
<li><p>deploy a new version, canary, and route only small % of traffic to it</p></li>
<li><p>most traffic will still be routed to old version, primary</p></li>
<li><p>once all tests passed on new version, deployment will be upgraded</p></li>
<li><p>the canary deployment created earlier is then deleted</p></li>
<li><p>set same label on both primary and canary, and set selector of service to that</p></li>
<li><p>to only route small % of traffic to canary, reduce the number of pods on it</p></li>
<li><p>as service distribute traffic equally, most will still go to primary</p></li>
<li><p>doing this way limits the control of traffic on the deployments</p></li>
<li><p>service meshes, like Istio, comes with better control, exact % can be defined</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># primary.yml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>

<span class="c1"># canary.yml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span>

<span class="c1"># service-definition.yml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">front-end</span><span class="w"> </span><span class="c1"># use same label on both</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># edit deployment-definition.yml file, will trigger new rollout</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>deployment-definition.yml

<span class="c1"># will make new rollout but the deployment-definition.yml file will not be updated</span>
kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>image<span class="w"> </span>deployment/myapp-deployment<span class="w"> </span>nginx-container<span class="o">=</span>nginx:NEW_VERSION

<span class="c1"># will also show deployment strategy</span>
kubectl<span class="w"> </span>describe<span class="w"> </span>myapp-deployment
</pre></div>
</div>
</div></blockquote>
</section>
<section id="statefulsets">
<h3>StatefulSets<a class="headerlink" href="#statefulsets" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>similar to Deployments, create pods based on templates, scale, rollingupdate and rollback</p></li>
<li><p>main feature is that pods are created in sequential order</p></li>
<li><p>first pod must be in running and ready state before next one is deployed</p></li>
<li><p>assigns unique ordinal index to each pod</p></li>
<li><p>each pod gets a unique name, combining index and statefulset name, no more random names</p></li>
<li><p>always has same name even if the pod is restarted</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">serviceName</span></code>: name of headless service</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">podManagementPolicy</span></code>: change ordering policy, <code class="docutils literal notranslate"><span class="pre">OrderedReady</span></code> (default), <code class="docutils literal notranslate"><span class="pre">Parallel</span></code></p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># statefulset-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StatefulSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql</span>
<span class="w">  </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mysql-h</span>
<span class="w">  </span><span class="nt">podManagementPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Parallel</span><span class="w"> </span><span class="c1"># will not scale or delete in order</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># create pods one after another</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>statefulset-definition.yml

<span class="c1"># scale up in order</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>statefulset<span class="w"> </span>mysql<span class="w"> </span>--replicas<span class="o">=</span><span class="m">5</span>

<span class="c1"># scale down in reverse order</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>statefulset<span class="w"> </span>mysql<span class="w"> </span>--replicas<span class="o">=</span><span class="m">3</span>

<span class="c1"># delete in reverse order</span>
kubectl<span class="w"> </span>delete<span class="w"> </span>statefulset<span class="w"> </span>mysql
</pre></div>
</div>
<ul>
<li><p>if volume is specified, all pods created by StatefulSet will try to use that volume</p></li>
<li><dl>
<dt><strong>volumeClaimTemplates</strong></dt><dd><ul class="simple">
<li><p>is a PVC (Persistent Volume), ensure each pod created by StatefulSet gets a</p></li>
</ul>
<p>individual PVC (Persistent Volume Claim)
- defined in statefulset-definition.yml file under <code class="docutils literal notranslate"><span class="pre">spec</span></code>
- during the creation of a pod, PVC is created and associated to a SC (Storage Class),
the SC creates PV and binds the PVC to the PV
- StatefulSet do not auto delete the PVC and volume if the associated pod fails
- instead makes sure that the restarted pod is attached to the same PVC before</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># statefulset-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">volumeClaimTemplates</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-volume</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">accessModes</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<span class="w">      </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">google-storage</span>
<span class="w">      </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">        </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">          </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500Mi</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="daemonset">
<h3>Daemonset<a class="headerlink" href="#daemonset" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>like replica set, helps to deploy multiple instances of pod, created by DaemonSet</p></li>
</ul>
<p>controller through kube-apiserver
* ensures one copy of the pod is always present on all nodes in the cluster
* when a new node is added to the cluster, a replica of the pod is auto added to that node
* the pod is removed when the node removes
* e.g deploying monitoring and logging agents, kube-proxy, networking solutions like
Weave-net
* from v1.12, uses nodeAffinity and default scheduler to schedule pods
* definition file is similar to ReplicaSets</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># daemon-set-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DaemonSet</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-daemon</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-agent</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-agent</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-agent</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitoring-agent</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>daemon-set-definition.yml
kubectl<span class="w"> </span>get<span class="w"> </span>daemonsets
kubectl<span class="w"> </span>describe<span class="w"> </span>ds<span class="w"> </span>monitoring-daemon
</pre></div>
</div>
</div></blockquote>
</section>
<section id="jobs">
<h3>Jobs<a class="headerlink" href="#jobs" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>in batch processing, pods need perform the task in parallel and exit once done</p></li>
<li><p>need a manager to create number of desired pods and ensure the task is done successfully</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ReplicaSets</span></code> only make sure specified number of pods are running at all time</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Job</span></code> is used to run a set of pods to perform the task to completion</p></li>
<li><p>output of a job is in stdout for simple tasks</p></li>
<li><p>tasks such as image processing will need a volume to store the output</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># job-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Job</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">math-add-job</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">math-add</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;expr&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;+&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># create job</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>job-definition.yml

kubectl<span class="w"> </span>get<span class="w"> </span><span class="nb">jobs</span>

<span class="c1"># see output</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>math-add-job-pod
</pre></div>
</div>
<ul>
<li><dl>
<dt>run multiple jobs</dt><dd><ul class="simple">
<li><p>second pod is created only after first finishes</p></li>
<li><p>will create new pods until desired completions is met</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># job-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>create pods in parallel</dt><dd><ul class="simple">
<li><p>will create new pods until desired completions is met</p></li>
<li><p>intelligent enough to know how many pods will have to be created</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># job-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">parallelism</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="cronjobs">
<h3>CronJobs<a class="headerlink" href="#cronjobs" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>scheduled a job and run periodically</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># cron-job-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">batch/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CronJob</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cron-job</span>
<span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c1"># CronJob spec</span>
<span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*/1</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*</span><span class="nv"> </span><span class="s">*&quot;</span>
<span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c1"># Job spec</span>
<span class="w">      </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">      </span><span class="nt">parallelism</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">      </span><span class="nt">template</span><span class="p">:</span>
<span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c1"># Pod spec</span>
<span class="w">          </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">math-add</span>
<span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
<span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;expr&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;3&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;+&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;2&#39;</span><span class="p p-Indicator">]</span>
<span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Never</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># create cron job</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>job-definition.yml

kubectl<span class="w"> </span>get<span class="w"> </span>cronjobs
</pre></div>
</div>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="storage-volumes">
<h2>Storage &amp; Volumes<a class="headerlink" href="#storage-volumes" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#recommended-patterns">Recommended Patterns</a>, <a href="#id45"><span class="problematic" id="id46">`Persistent Volume`_</span></a>, <a href="#id47"><span class="problematic" id="id48">`Persistent Volume Claims`_</span></a>, <a class="reference internal" href="#storage-classes">Storage Classes</a></p></li>
<li><p>containers and pods are transient by nature</p></li>
<li><p>to have data persistence, volumes must be created and mounted to a pod</p></li>
</ul>
<section id="recommended-patterns">
<h3>Recommended Patterns<a class="headerlink" href="#recommended-patterns" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl>
<dt>Communication/Synchronization</dt><dd><ul class="simple">
<li><p>e.g using <code class="docutils literal notranslate"><span class="pre">emptyDir</span></code> volume which only has the scope of pod’s lifespan but can be</p></li>
</ul>
<p>shared between two containers</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Cache</dt><dd><ul class="simple">
<li><p>cache must survive a container restart and <code class="docutils literal notranslate"><span class="pre">emptyDir</span></code> can also be used</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Persistent data</dt><dd><ul class="simple">
<li><p>independent of the lifespan of a pod</p></li>
<li><p>e.g NFS, iSCSI, cloud provider storage</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>Mounting the host filesystem</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">hostPath</span></code> volume, which can mount arbitrary locations on the worker node into the</p></li>
</ul>
<p>container
- not recommended unless there are specific reasons</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>external replicated cluster storage solutions: NFS, GlusterFS, Flocker, Ceph, ScaleIO,</p></li>
</ul>
<p>AWS EBS, Azuer Disk, GCE Persistence Disk</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;echo&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">/tmp/hello.txt&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-volume</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">data-volume</span>
<span class="w">    </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"> </span><span class="c1"># not ideal for multiple nodes</span>
<span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/data</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Directory</span>
<span class="w">    </span><span class="nt">awsElasticBlockStore</span><span class="p">:</span>
<span class="w">      </span><span class="nt">volumeID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VOLUME_ID</span>
<span class="w">      </span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ext4</span>
</pre></div>
</div>
<ul class="simple">
<li><p>putting volume configurations in a pod-definition.yml raises the issue to add volume</p></li>
</ul>
<p>configuration in every pod definition file</p>
</section>
<section id="persistent-volume-pv">
<h3>Persistent Volume (PV)<a class="headerlink" href="#persistent-volume-pv" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>can manage volume centrally, configured by an admin</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">accessModes</span></code>: how a volume should be mounted on a host, <code class="docutils literal notranslate"><span class="pre">ReadOnlyMany</span></code>, <code class="docutils literal notranslate"><span class="pre">ReadWriteOnce</span></code>,</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">ReadWriteMany</span></code>
* <code class="docutils literal notranslate"><span class="pre">persistentVolumeReclaimPolicy</span></code>: define what to do when the PVC is deleted, <code class="docutils literal notranslate"><span class="pre">Retain</span></code>,
<code class="docutils literal notranslate"><span class="pre">Delete</span></code>, <code class="docutils literal notranslate"><span class="pre">Recycle</span></code></p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pv-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolume</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pv-vol1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
<span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
<span class="w">  </span><span class="nt">hostPath</span><span class="p">:</span><span class="w"> </span><span class="c1"># not for production</span>
<span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp/data</span>
<span class="w">  </span><span class="nt">awsElasticBlockStore</span><span class="p">:</span>
<span class="w">    </span><span class="nt">volumeID</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">VOLUME_ID</span>
<span class="w">    </span><span class="nt">fsType</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ext4</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>pv-definition.yml
kubectl<span class="w"> </span>get<span class="w"> </span>persistentvolume
</pre></div>
</div>
</div></blockquote>
</section>
<section id="persistent-volume-claims-pvc">
<h3>Persistent Volume Claims (PVC)<a class="headerlink" href="#persistent-volume-claims-pvc" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to use from a PV, configured by a user</p></li>
<li><p>every PVC is bound to a PV, one-to-one relationship between claim and volume</p></li>
<li><p>K8s binds the PV based on requests and properties set on the volumes such as sufficient</p></li>
</ul>
<p>capacity, access modes, volume modes, storage class, selector
* smaller claims can be bound to larger volumes if no other matches available, other claims
cannot use the remaining volume
* PVC will remain pending until new volumes are available
* will stuck in terminating state if the pvc is deleted while the pod is using</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pvc-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myclaim</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500Mi</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>pvc-definition.yml
kubectl<span class="w"> </span>get<span class="w"> </span>persistentvolumeclaim
kubectl<span class="w"> </span>delete<span class="w"> </span>pvc<span class="w"> </span>myclaim
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mypd</span>
<span class="w">    </span><span class="nt">persistentVolumeClaim</span><span class="p">:</span>
<span class="w">      </span><span class="nt">claimName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myclaim</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>static provisioning: when creating pvc from cloud, the volume has to be manually configured</p></li>
</ul>
<p>on the cloud first</p>
</section>
<section id="storage-classes">
<h3>Storage Classes<a class="headerlink" href="#storage-classes" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>auto provision storage when needed, dynamic provisioning</p></li>
<li><p>PV definition file is not needed as it will be auto created by SC</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># sc-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">StorageClass</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">google-storage</span>
<span class="nt">provisioner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes.io/gce-pd</span>
<span class="nt">parameters</span><span class="p">:</span><span class="w"> </span><span class="c1"># provider specific</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pd-standard</span>
<span class="w">  </span><span class="nt">replication-type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">none</span>

<span class="c1"># pvc-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myclaim</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">accessModes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
<span class="w">  </span><span class="nt">storageClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">google-storage</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500Mi</span>
</pre></div>
</div>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="controller">
<h2>Controller<a class="headerlink" href="#controller" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#kube-controller-manager">Kube Controller Manager</a>, <a class="reference internal" href="#node-controller">Node Controller</a>, <a class="reference internal" href="#admission-controller">Admission Controller</a></p></li>
<li><p><a class="reference internal" href="#webhook">Webhook</a>, <a class="reference internal" href="#custom-controllers">Custom Controllers</a>, <a class="reference internal" href="#operator-framework">Operator Framework</a></p></li>
</ul>
<section id="kube-controller-manager">
<h3>Kube Controller Manager<a class="headerlink" href="#kube-controller-manager" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>single process that manages various controllers in K8s</p></li>
<li><p>can download from K8s release page</p></li>
<li><p>kubeadm deploy as pod in kube-system namespace, definition file in</p></li>
</ul>
<p>‘etc/kubernetes/manifests/kube-controller-manager.yml’
* can be searched as a process <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">kube-controller-manager</span></code> on the controlplane node
* in non kubeadm setup, ‘/etc/systemd/system/kube-controller-manager.service’</p>
</div></blockquote>
</section>
<section id="node-controller">
<h3>Node Controller<a class="headerlink" href="#node-controller" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>responsible for monitoring status of the nodes</p></li>
<li><p>take necessary actions to keep the applications running through kube-apiserver</p></li>
<li><p>get status of the nodes every 5s</p></li>
<li><p>wait for 40s before marking a node unreachable</p></li>
<li><p>gives a node 5 min to comeback up</p></li>
<li><p>if the node doesn’t comeback, it removes the pod on that node and assign it to the</p></li>
</ul>
<p>healthy node if the pod is part of replicaset</p>
</div></blockquote>
</section>
<section id="admission-controller">
<h3>Admission Controller<a class="headerlink" href="#admission-controller" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>most rules created with RBAC are at API level</p></li>
<li><p>Admission Controllers can enforce how a cluster is used, can do more than authorization</p></li>
<li><p>built-ins such AlwaysPullImages, DefaultStorageClass, EventRateLimit, NamespaceExists</p></li>
<li><dl class="simple">
<dt>NamespaceExists</dt><dd><ul>
<li><p>check if the specified namespace exists in the request</p></li>
<li><p>enabled by default</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>NamespaceAutoProvision</dt><dd><ul>
<li><p>not enabled by default</p></li>
<li><p>auto create namespace if it doesn’t exist</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>can perform operations in the backend and change the request</p></li>
<li><p>NamespaceExists and NamespaceAutoProvision are deprecated and replaced by</p></li>
</ul>
<p>NamespaceLifecycle
* <code class="docutils literal notranslate"><span class="pre">--disable-admission-plugins</span></code> to disable</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># view enabled admission controllers</span>
kube-apiserver<span class="w"> </span>-h<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>enable-admission-plugins
grep<span class="w"> </span>enable-admission-plugins<span class="w"> </span>/etc/kubernetes/manifests/kube-apiserver.yaml

<span class="c1"># if using kubeadm setup</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>kube-apiserver-controlplane<span class="w"> </span>-n<span class="w"> </span>kube-system<span class="w"> </span>--<span class="w"> </span>kube-apiserver<span class="w"> </span>-h
ps<span class="w"> </span>-ef<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kube-apiserver<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>admission-plugins
</pre></div>
</div>
<ul class="simple">
<li><dl class="simple">
<dt>validating admission controller</dt><dd><ul>
<li><p>validates the request and allow or deny</p></li>
<li><p>e.g <code class="docutils literal notranslate"><span class="pre">NamespaceExists</span></code> controller</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>mutating admission controller</dt><dd><ul>
<li><p>mutates the request and performs it</p></li>
<li><p>e.g <code class="docutils literal notranslate"><span class="pre">DefaultStorageClass</span></code> controller</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>mutate first, then validate</p></li>
</ul>
</div></blockquote>
</section>
<section id="webhook">
<h3>Webhook<a class="headerlink" href="#webhook" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>custom admission controller</p></li>
<li><p>e.g MutatingAdmission Webhook, ValidatingAdmission Webhook</p></li>
<li><p>can be configured to point a server within or outside the cluster</p></li>
<li><p>after the request go through all built-in controllers, it gets to the Webhook and makes</p></li>
</ul>
<p>a call to admission webhook server by passing object in json
* Admission Webhook server responds with Admission Review object
* requirement to be a Webhook is to accept the mutate, validate and respond with json object
* need a webhook service if deployed in K8s cluster</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># webhook.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admissionregistration.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ValidatingWebhookConfiguration</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pod-policy.example.com&quot;</span>
<span class="nt">webhooks</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;pod-policy.example.com&quot;</span>
<span class="w">  </span><span class="nt">clientConfig</span><span class="p">:</span><span class="w"> </span><span class="c1"># location of webhook server</span>
<span class="w">    </span><span class="nt">url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://external-server.com&quot;</span><span class="w"> </span><span class="c1"># if deployed external</span>
<span class="w">    </span><span class="nt">service</span><span class="p">:</span><span class="w"> </span><span class="c1"># if in the cluster</span>
<span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;webhook-namespace&quot;</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;webhook-service&quot;</span>
<span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;fdsafdsafsaf...TLS&quot;</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">apiVersions</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;v1&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">operations</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;CREATE&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;pods&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Namespaced&quot;</span>
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</section>
<section id="custom-controllers">
<h3>Custom Controllers<a class="headerlink" href="#custom-controllers" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>monitor custom objects in etcd and handle them</p></li>
<li><p>can use Python but will be hard to configure such as queuing, caching</p></li>
<li><p>developing in K8s Go client have support for other libraries</p></li>
<li><p>can package the controller in docker image and run it inside K8s cluster</p></li>
<li><p>[sample controller](<a class="github reference external" href="https://github.com/kubernetes/sample-controller">kubernetes/sample-controller</a>)</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>go<span class="w"> </span>build<span class="w"> </span>-o<span class="w"> </span>sample-controller<span class="w"> </span>.

<span class="c1"># to authenticate to K8s API</span>
./sample-controller<span class="w"> </span>--kubeconfig<span class="o">=</span><span class="nv">$HOME</span>/.kube/config
</pre></div>
</div>
</div></blockquote>
</section>
<section id="operator-framework">
<h3>Operator Framework<a class="headerlink" href="#operator-framework" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>package CRD and Custom Controller and deploy as single entity</p></li>
<li><dl>
<dt>etcd operator</dt><dd><ul class="simple">
<li><p>popular operator framework to deploy and manage etcd cluster within K8s</p></li>
<li><p>has EtcdCluster CRD and ETCD Controller</p></li>
<li><p>can also take backup (EtcdBackup, Backup Operator), restore (EtcdRestore, Restore</p></li>
</ul>
<p>Operator)</p>
</dd>
</dl>
</li>
<li><p>[OperatorHub](<a class="reference external" href="https://operatorhub.io/">https://operatorhub.io/</a>)</p></li>
</ul>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="scheduler">
<h2>Scheduler<a class="headerlink" href="#scheduler" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#binding">Binding</a>, <a href="#id49"><span class="problematic" id="id50">`Multiple Schedulers`_</span></a></p></li>
<li><p>looks at each pod and try to find the best node</p></li>
<li><p>first filter the nodes that do not fit the pod</p></li>
<li><p>from the remaining nodes, it calculates amount of resources that will be free on the</p></li>
</ul>
<p>node after the pod is placed
* place the pod on the node that will leave more free resource
* can make custom scheduler
* can download from K8s releases and run it as a service
* kubeadm deploy as pod in kube-system namespace, definition file in
‘etc/kubernetes/manifests/kube-scheduler.yml’
* can be searched as a process <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">kube-scheduler</span></code> on the controlplane node
* in non kubeadm setup, ‘/etc/systemd/system/kube-scheduler.service’
* every pod has a <code class="docutils literal notranslate"><span class="pre">nodeName</span></code> field under <code class="docutils literal notranslate"><span class="pre">spec</span></code> that is not set by default
* the scheduler looks for candidate pods, that do not have <code class="docutils literal notranslate"><span class="pre">nodeName</span></code> field, to schedule
* then schedule the pods by setting the <code class="docutils literal notranslate"><span class="pre">nodeName</span></code> to the name of the node, creating binding
object
* the pods will be in pending state if there is no scheduler
* easiest way to schedule a pod is to set the <code class="docutils literal notranslate"><span class="pre">nodeName</span></code> field to the name of the node
* can only specify <code class="docutils literal notranslate"><span class="pre">nodeName</span></code> at creation time
* cannot modify the <code class="docutils literal notranslate"><span class="pre">nodeName</span></code> property of a created pod</p>
<section id="binding">
<h3>Binding<a class="headerlink" href="#binding" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to assign a node to an existing pod and manually schedule a pod</p></li>
<li><p>create the object and send a request to the pod’s binding API</p></li>
<li><p>same method as the scheduler does</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-bind-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Binding</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="nt">target</span><span class="p">:</span>
<span class="w">  </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Node</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node02</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># YAML must be converted to JSON format first</span>
curl<span class="w"> </span>--header<span class="w"> </span><span class="s2">&quot;Content-Type:application/json&quot;</span><span class="w"> </span>--request<span class="w"> </span>POST<span class="w"> </span>--data<span class="w"> </span><span class="s1">&#39;{YAML data in JSON}&#39;</span><span class="se">\</span>
http://<span class="nv">$SERVER</span>/api/v1/namespaces/default/pods/<span class="nv">$PODNAME</span>/binding
</pre></div>
</div>
</div></blockquote>
<ul>
<li><dl>
<dt>can have <strong>multiple schedulers</strong> at the same time &lt;a id=”multiple-schedulers”&gt;&lt;/a&gt;</dt><dd><ul class="simple">
<li><p>can pass <code class="docutils literal notranslate"><span class="pre">--scheduler-name</span></code> options in kube-scheduler</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">leader-elect</span></code>, use when multiple copies of the scheduler on different controlplane nodes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">lock-object-name</span></code>, to differentiate custom scheduler from the default one during leader</p></li>
</ul>
<p>election process
* pod will be in pending state if the scheduler is not configured correctly</p>
<p><a href="#id11"><span class="problematic" id="id12">``</span></a><a href="#id13"><span class="problematic" id="id14">`</span></a>custom-scheduler.yml
apiVersion: v1
kind: Pod
metadata:</p>
<blockquote>
<div><p>name: custom-scheduler
namespace: kube-system</p>
</div></blockquote>
<dl>
<dt>spec:</dt><dd><p>containers:
* command:</p>
<blockquote>
<div><ul class="simple">
<li><p>kube-scheduler</p></li>
<li><p>–address=127.0.0.1</p></li>
<li><p>–kubeconfig=/etc/kubernetes/scheduler.conf</p></li>
<li><p>–leader-elect=true</p></li>
<li><p>–scheduler-name=custom-scheduler</p></li>
<li><p>–lock-object-name=custom-scheduler</p></li>
</ul>
<p>image: k8s.gcr.io/kube-scheduler-amdd64
name: kube-scheduler</p>
</div></blockquote>
</dd>
</dl>
<p># pod-definition.yml
apiVersion: v1
kind: Pod
metadata:</p>
<blockquote>
<div><p>name: myapp-pod
labels:</p>
<blockquote>
<div><p>app: myapp
type: front-end</p>
</div></blockquote>
</div></blockquote>
<dl>
<dt>spec:</dt><dd><p>containers:
* name: nginx-container</p>
<blockquote>
<div><p>image: nginx</p>
</div></blockquote>
<p>schedulerName: custom-scheduler</p>
</dd>
</dl>
</dd>
</dl>
</li>
<li><p><a href="#id51"><span class="problematic" id="id52">`Scheduler code hierarchy overview`_</span></a>, <a href="#id53"><span class="problematic" id="id54">`Advanced Scheduling`_</span></a></p></li>
<li><p>How the Scheduler works: [jvns](<a class="reference external" href="https://jvns.ca/blog/2017/07/27/how-does-the-kubernetes-scheduler-work/">https://jvns.ca/blog/2017/07/27/how-does-the-kubernetes-scheduler-work/</a>), [stack over flow](<a class="reference external" href="https://stackoverflow.com/questions/28857993/how-does-kubernetes-scheduler-work">https://stackoverflow.com/questions/28857993/how-does-kubernetes-scheduler-work</a>)</p></li>
</ul>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="networking">
<h2>Networking<a class="headerlink" href="#networking" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#ports">Ports</a>, <a class="reference internal" href="#implementing-network-model">Implementing Network Model</a>, <a class="reference internal" href="#cni-in-k8s">CNI in K8s</a>, <a class="reference internal" href="#service-networking">Service Networking</a></p></li>
<li><p><a class="reference internal" href="#dns-in-k8s">DNS in K8s</a>, <a class="reference internal" href="#network-policies">Network Policies</a>, <a class="reference internal" href="#ingress">Ingress</a>, <a class="reference internal" href="#mtls">mTLS</a></p></li>
<li><p>IP addresses are assigned to pods, each pod has its own IP address</p></li>
<li><p>K8s creates internal private network when configured initially</p></li>
</ul>
<section id="ports">
<h3>ports<a class="headerlink" href="#ports" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>kube-apiserver: 6443</p></li>
<li><p>kubelet: 10250</p></li>
<li><p>kube-scheduler: 10251</p></li>
<li><p>kube-controller-manager: 10252</p></li>
<li><p>etcd: 2379 (also need 2380 if multiple control-plane nodes)</p></li>
<li><p>worker nodes expose servcies on 30000-32767</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>accessing a pod with its internal IP is not ideal</p></li>
<li><p>internal network addresses of different nodes, which are not in a cluster, can be same</p></li>
<li><dl class="simple">
<dt>K8s does not auto setup for IP conflicts, users must setup on their own</dt><dd><ul>
<li><p>all containers/pods must be able to communicate one another without NAT</p></li>
<li><p>all nodes must be able to communicate with all containers and vice-versa without NAT</p></li>
<li><p>the IP that a container sees itself as is the same IP that others see it as</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>can use [prebuilt](<a class="reference external" href="https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy">https://kubernetes.io/docs/concepts/cluster-administration/addons/#networking-and-network-policy</a>) solutions to setup network</dt><dd><ul>
<li><p>e.g Flannel or Calico for setting up from scratch, NSX for VMware environment</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="implementing-network-model">
<h3>Implementing Network Model<a class="headerlink" href="#implementing-network-model" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>K8s creates network namespaces for containers automatically</p></li>
<li><p>create bridge network on each node, bring them up</p></li>
<li><p>assign IP addresses to bridge interfaces/networks, by choosing any private address range</p></li>
<li><p>create a script to be used every time a container is created, with necessary parameters</p></li>
<li><p>use a router as default gateway for all hosts to use and manage the routing table on it,</p></li>
</ul>
<p>no need to configure routes on each container</p>
<p># net-script.sh</p>
<p># create veth pair
ip link add …</p>
<p># attach veth pair
ip link set …
ip link set …</p>
<p># assign IP address
ip -n … addr add …
ip -n … addr add …</p>
<p># bring up interface
ip -n … link set …</p>
<ul class="simple">
<li><p>CNI tells K8s to call the script as soon as the container is created</p></li>
<li><p>the script should meet CNI standards</p></li>
<li><p>when a container is created, kubelet looks for script name in <code class="docutils literal notranslate"><span class="pre">--cni-conf-dir</span></code> and</p></li>
</ul>
<p>find the script in <cite>–cin-bin-dir</cite> and run it with <cite>./net-script.sh add cid ns</cite></p>
<blockquote>
<div><p># net-script.sh</p>
<dl class="simple">
<dt>ADD)</dt><dd><p># create veth pair
# attach veth pair
# assign ip address
# bring up interface</p>
</dd>
<dt>DEL)</dt><dd><p># delete veth pari
ip link del …</p>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
</section>
<section id="cni-in-k8s">
<h3>CNI in K8s<a class="headerlink" href="#cni-in-k8s" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>CNI plugin must be invoke by the component that is responsible for creating containers</p></li>
<li><p>plugin is configured in <code class="docutils literal notranslate"><span class="pre">kubelet.service</span></code> on each node in the cluster</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--cni-bin-dir=/opt/cni/bin</span></code> has all executable plugins</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--cni-conf-dir=/etc/cni/net.d</span></code> has configuration files which kubelet looks for</p></li>
<li><dl class="simple">
<dt>host-local</dt><dd><ul>
<li><p>plugin that manages IP addresses locally on each host</p></li>
<li><p>can be specified in <code class="docutils literal notranslate"><span class="pre">ipam</span></code> of <code class="docutils literal notranslate"><span class="pre">bridge.conf</span></code> file</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p># bridge.conf</p>
<dl>
<dt>{</dt><dd><p>“cniVersion”:,
“name”:,
“type”:,
“bridge”:,
“isGateway”:,
“ipMasq”:,
“ipam”: {</p>
<blockquote>
<div><p>“type”:,
“subnet”:,
“routes”: [{}]</p>
</div></blockquote>
<p>},</p>
</dd>
</dl>
<p>}</p>
</div></blockquote>
</section>
<section id="service-networking">
<h3>Service Networking<a class="headerlink" href="#service-networking" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>when a service is created, it is accessible by all pods on the cluster</p></li>
<li><p>there are no processes, namespaces or interfaces for services</p></li>
<li><p>service is just a virtual object, assigned with IP address within predefined range, in</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">--service-cluster-ip-range</span></code>, which defaults to 10.0.0.0/24
* kube-proxy gets the IP address and creates forwarding rules in the cluster
* the rules has same lifecycle as the services
* kube-proxy create rules using userspace, ipvs or iptables (default)
* entries can be found in <code class="docutils literal notranslate"><span class="pre">/var/log/kube-proxy.log</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># check ip range</span>
ps<span class="w"> </span>-aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>kube-apiserver

<span class="c1"># check the rules created</span>
iptables<span class="w"> </span>-L<span class="w"> </span>-t<span class="w"> </span>nat<span class="w"> </span><span class="p">|</span><span class="w"> </span>gre<span class="w"> </span>my-service
</pre></div>
</div>
</div></blockquote>
</section>
<section id="dns-in-k8s">
<h3>DNS in K8s<a class="headerlink" href="#dns-in-k8s" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>K8s deploy built-in DNS server by default</p></li>
<li><p>coredns is recommended, kube-dns was used before</p></li>
<li><dl>
<dt><strong>services</strong></dt><dd><ul class="simple">
<li><p>when a service is created, DNS service auto creates a record for it so that any pod</p></li>
</ul>
<p>can reach the service using the service name
- <code class="docutils literal notranslate"><span class="pre">cluster.local</span></code>: domain name
- <code class="docutils literal notranslate"><span class="pre">svc</span></code>: sub domain for service
- <code class="docutils literal notranslate"><span class="pre">dev</span></code>: namespace
- <code class="docutils literal notranslate"><span class="pre">my-service</span></code>: service name
- if same namespace, the service can be easily reached by using its name, <code class="docutils literal notranslate"><span class="pre">myservice</span></code>
- for separate namespace, <code class="docutils literal notranslate"><span class="pre">my-service.namespace1</span></code>
- all services are grouped together into <code class="docutils literal notranslate"><span class="pre">svc</span></code> subdomain
- all services and pods are grouped together into <code class="docutils literal notranslate"><span class="pre">cluster.local</span></code> root domain
- full domain name of a service, <code class="docutils literal notranslate"><span class="pre">my-service.namespace1.svc.cluster.local</span></code></p>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>pods</strong></dt><dd><ul class="simple">
<li><p>records for pods are not created by default</p></li>
<li><p>full domain name of a pod, <code class="docutils literal notranslate"><span class="pre">10-244-2-5.namespace1.type.cluster.local</span></code>, dots in pod’s</p></li>
</ul>
<p>IP are replaced by dashes</p>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>coredns</strong></dt><dd><ul class="simple">
<li><p>deployed as pod which runs Coredns executable</p></li>
<li><p>K8s uses <code class="docutils literal notranslate"><span class="pre">/etc/coredns/Corefile</span></code> for configuration file</p></li>
<li><p>multiple plugins are enabled in the file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubernetes</span></code> plugin makes CoreDNS work with K8s, where top level domain name of the</p></li>
</ul>
<p>cluster is set
- <code class="docutils literal notranslate"><span class="pre">pods</span></code> options in the file is responsible for creating records for pods
- any record that the DNS server can’t solve is forwarded to the nameserver specified
in <code class="docutils literal notranslate"><span class="pre">proxy</span></code> in the Corefile
- the Corefile is also passed in to the pods as configmap object
- when coredns is deployed as pod, a service called <code class="docutils literal notranslate"><span class="pre">kube-dns</span></code> is also deployed
- IP of kube-dns is configured as nameserver and default search entry is also added in
<code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code> on pods, which is done by kubelet automatically
- IP of DNS server and domain can be found in <code class="docutils literal notranslate"><span class="pre">/var/lib/kubelet/config.yml</span></code></p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="network-policies">
<h3>Network Policies<a class="headerlink" href="#network-policies" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>K8s allow all traffic from all pods to all destinations by default</p></li>
<li><p>only look the direction in which the traffic originated when defining Ingress (incoming</p></li>
</ul>
<p>traffic) and Egress (outgoing traffic)
* attach a policy to one or more pods, defining rules within the policy
* e.g allow ingress traffic from API pod on port 3306
* Kube-router, Calico, Romana and Weave-net support network policies
* Flannel does not support network policies
* omitting <code class="docutils literal notranslate"><span class="pre">ingress:</span></code> or <code class="docutils literal notranslate"><span class="pre">egress:</span></code> fields under <code class="docutils literal notranslate"><span class="pre">policyTypes</span></code> will block all traffic
* allowing ingress will auto allow the db-pod to be able to respond back but does not allow
it to make requests to the api-pod, as it is egress rule</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># network-policy.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NetworkPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db-policy</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod</span><span class="w"> </span><span class="c1"># policy for prod namespace</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">role</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">db</span>
<span class="w">  </span><span class="nt">policyTypes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Egress</span>
<span class="w">  </span><span class="nt">ingress</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-pod</span>
<span class="w">      </span><span class="nt">namespaceSelector</span><span class="p">:</span><span class="w"> </span><span class="c1"># omit if same namespace as policy</span>
<span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod</span><span class="w"> </span><span class="c1"># allow from api-pod on prod</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ipBlock</span><span class="p">:</span><span class="w"> </span><span class="c1"># allow from outside the cluster</span>
<span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.5.10/32</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"> </span><span class="c1"># port on db-pod</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3306</span>
<span class="w">  </span><span class="nt">egress</span><span class="p">:</span><span class="w"> </span><span class="c1"># allow to make requests</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">to</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ipBlock</span><span class="p">:</span>
<span class="w">        </span><span class="nt">cidr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">192.168.5.10/32</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w"> </span><span class="c1"># port to which the request will be made</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>
</div>
<ul class="simple">
<li><p>important to understand how to define rules based on requirements</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># allow when podSelector AND namespaceSelector are true</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-pod</span>
<span class="w">  </span><span class="nt">namespaceSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod</span>

<span class="c1"># allow when podSelector OR namespaceSelector is true</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">podSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">api-pod</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">namespaceSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>network-policy.yml
kubectl<span class="w"> </span>get<span class="w"> </span>networkpolicies
kubectl<span class="w"> </span>describe<span class="w"> </span>netpol
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>virtual hosting: host HTTP sites on single IP address using a load balancer or reverse proxy</p></li>
</ul>
</section>
<section id="ingress">
<h3>Ingress<a class="headerlink" href="#ingress" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>helps users access the application using single accessible URL, HTTP-based load balancing</p></li>
<li><p>built-in layer 7 loadbalancer and standardizes using K8s primitives and merging multiple</p></li>
</ul>
<p>Ingress objects into single config
* route within the K8s cluster and implement SSL security
* only need to expose once
* <strong>Ingress Controller</strong></p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Ingress proxy</strong>: exposed outside the cluster using <code class="docutils literal notranslate"><span class="pre">LoadBalancer</span></code> type service</p></li>
<li><p><strong>Ingress reconciler/operator</strong>: read and monitor ingress objects and reconfigure</p></li>
</ul>
<p>Ingress proxy to route traffic
- the solution deployed, does not come with K8s by default
- must be deployed using third-party as no single load balancer can be set as standard
and Ingress was added to K8s before other extensibility capabilities
- GCE and Nginx are supported and maintained by K8s
- need a service to expose the ingress controller
- intelligent enough to monitor cluster’s ingress resources and configure underlying
nginx server if needed, but requires a <code class="docutils literal notranslate"><span class="pre">ServiceAccount</span></code> with right permissions</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># nginx-ingress-controller.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress-controller</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">containersc</span>
<span class="w">      </span><span class="l l-Scalar l-Scalar-Plain">- name</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress-controller</span>
<span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">image</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">registry.k8s.io/ingress-nginx/controller:v1.3.1</span>
<span class="w">      </span><span class="nt">args</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/nginx-ingress-controller</span>
<span class="w">      </span><span class="c1"># creating ConfigMap object makes easier to manage configuration data</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">--configmap=$(POD_NAMESPACE)/nginx-configuration</span>
<span class="w">      </span><span class="nt">env</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POD_NAME</span>
<span class="w">      </span><span class="w w-Error"> </span><span class="nt">valueFrom</span><span class="p">:</span>
<span class="w">         </span><span class="nt">fieldRef</span><span class="p">:</span>
<span class="w">           </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.name</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">POD_NAMESPACE</span>
<span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span>
<span class="w">          </span><span class="nt">fieldRef</span><span class="p">:</span>
<span class="w">            </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.namespace</span>
<span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w"> </span><span class="c1"># ports used by controller</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">        </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
<span class="w">        </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>

<span class="c1"># nginx-ingress-configmap.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-configuration</span>

<span class="c1"># nginx-ingress-service.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NodePort</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">443</span>
<span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">TCP</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress</span>

<span class="c1"># nginx-ingress-serviceaccount.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-ingress-serviceaccount</span>
<span class="c1"># with correct Roles, ClusterRoles and RoleBindings</span>
</pre></div>
</div>
</div></blockquote>
<ul>
<li><p>neeed to configure DNS entries to external address for load balancer</p></li>
<li><p>can map multiple hostnames to single external endpoint</p></li>
<li><p>can just pass everything to an upstream service</p></li>
<li><dl>
<dt><strong>Ingress Resources</strong></dt><dd><ul class="simple">
<li><p>set of rules applied on ingress controller</p></li>
<li><p>can set rules on each pod based on URL</p></li>
<li><p>has a <code class="docutils literal notranslate"><span class="pre">Default</span> <span class="pre">backend</span></code> where the user will be routed to if rules are not matched</p></li>
<li><p>should deploy a service for <code class="docutils literal notranslate"><span class="pre">Default</span> <span class="pre">backend</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">paths</span></code>: to direct traffic based on the path in HTTP request, can be used to host</p></li>
</ul>
<p>multiple services on different paths of single domain, longest prefix matches if
multiple paths are on the same host
- add <code class="docutils literal notranslate"><span class="pre">host:</span></code> in each rule to split traffic by domain name and route appropriately
- <code class="docutils literal notranslate"><span class="pre">rewrite-target</span></code>: to write and forward internally to the correct URL on the
application, rewrites the URL by replacing the defined <code class="docutils literal notranslate"><span class="pre">rule-&gt;http-&gt;paths-&gt;path</span></code>
- <code class="docutils literal notranslate"><span class="pre">spec.ingressClassName</span></code>: to enable single Ingress resource to request particular
implementation and allowing to run multiple Ingress controllers on single cluster,
default controller will be used if not specified
- <code class="docutils literal notranslate"><span class="pre">nginx.ingress.kubernetes.io/rewrite-target</span></code>, modify/rewrite path in the proxied
request with an annotation on the Ingress object, which applies to all requests
specified by that object and can make upstream services work on a subpath
- can also use regular expressions when rewriting path
- better to avoid path rewriting complicated applications as it can lead to bugs</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Ingress-wear.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">networking.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ingress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ingress-wear</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">nginx.ingress.kubernetes.io/rewrite-target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain1.com</span><span class="w"> </span><span class="c1"># split traffic by domain name</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/route1</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w"> </span><span class="c1"># where traffic will be routed to</span>
<span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">route1-service</span>
<span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/route2</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span>
<span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">route2-service</span>
<span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">host</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">domain2.com</span>
<span class="w">    </span><span class="nt">http</span><span class="p">:</span>
<span class="w">      </span><span class="nt">paths</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/route1</span><span class="w"> </span><span class="c1"># /route1 will be replaced with /</span>
<span class="w">        </span><span class="nt">backend</span><span class="p">:</span><span class="w"> </span><span class="c1"># where traffic will be routed to</span>
<span class="w">          </span><span class="nt">serviceName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">route1-service</span>
<span class="w">          </span><span class="nt">servicePort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>Ingress-wear.yml
kubect<span class="w"> </span>get<span class="w"> </span>ingress
kubectl<span class="w"> </span>describe<span class="w"> </span>ingress<span class="w"> </span>ingress-wear

<span class="c1"># Imperative method</span>
kubectl<span class="w"> </span>create<span class="w"> </span>ingress<span class="w"> </span>ingree-wear<span class="w"> </span>--rule<span class="o">=</span><span class="s2">&quot;domain1.com/route1=route1-service:80&quot;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>supported features differ based on the Ingress controller implementation</p></li>
<li><p>most features are exposed via annotations which apply to the entire Ingress object</p></li>
<li><p>can split single Ingress object into multiple to have different annotation scopes</p></li>
<li><p>Ingress controller should read multiple Ingress objects and merge together</p></li>
<li><p>will have undefined behavior for duplicate and conflicting configurations, and single</p></li>
</ul>
<p>implementation may behave differently
* Ingress object can only refer to an upstream service in the same namespace, and can’t use
to point a subpath to a service in another
* multiple objects in different namespaces can specify subpaths for the same host but
Ingress must be coordinated globally across the cluster
* no restrictions about which namespaces are allowed to specify which hostnames and paths
* using TLS and HTTPS</p>
<blockquote>
<div><ul class="simple">
<li><p>need to specify a <code class="docutils literal notranslate"><span class="pre">Secret</span></code> with certificate and keys</p></li>
<li><p>undefined behavior if multiple objects specify certificates for the same hostname</p></li>
<li><p>can use API-driven [Let’s Encrypt](<a class="reference external" href="https://letsencrypt.org/">https://letsencrypt.org/</a>) and [cer-manager](<a class="reference external" href="https://cert-manager.io/">https://cert-manager.io/</a>)</p></li>
</ul>
</div></blockquote>
<ul>
<li><dl>
<dt>implementations</dt><dd><ul class="simple">
<li><p>each provider has cloud-based L7 load balancer Ingress implementation that take</p></li>
</ul>
<p>Ingress objects and configure via API
- reduces the cluster and management load for the operators
- GCE, Nginx, Contour, HAProxy, Traefik, Istio
- NGINX Ingress controller has many features exposed via annotations
- Envoy-based Emissary and Gloo focus on being API gateways, which includes resources
for controlling Layer 4 balancing</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="mtls">
<h3>mTLS<a class="headerlink" href="#mtls" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>pod to pod encryption</p></li>
<li><p>instead of application level encryption, use third-party tools such as Istio, Linkerd,</p></li>
</ul>
<p>that uses mTLS
* the tools provide service to service communication without depending on applications
* capable of more than encryption, all related to connecting services in microservice
architecture, known as service mesh
* Istio insert a sidecar container into each pod
* whenever a pod needs to send a message, Istio sidecar intercepts it and encrypts it
* Istio sidecar on the receiver decrypts the message and passes to the target container
* can configure Istio to use mTLS only if available
* Permissive/Opportunistic mode: does not use mTLS if the external app does not support,
sends the message only in the form the external app can interpret
* Enforced/Strict mode: only mTLS is allowed, secure but can cause application to break</p>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="security">
<h2>Security<a class="headerlink" href="#security" title="Link to this heading">#</a></h2>
<ul>
<li><p><a class="reference internal" href="#authentication">Authentication</a>, <a class="reference internal" href="#kubeconfig">kubeconfig</a>, <a class="reference internal" href="#authorization">Authorization</a>, <a class="reference internal" href="#tls-in-k8s">TLS in K8s</a>, <a class="reference internal" href="#certificates-api">Certificates API</a>, <a class="reference internal" href="#image-security">Image Security</a></p></li>
<li><p><a class="reference internal" href="#k8s-attack-surface">K8s Attack Surface</a>, <a class="reference internal" href="#kubelet-security">Kubelet Security</a>, <a class="reference internal" href="#pod-security-policies">Pod Security Policies</a>, <a class="reference internal" href="#opa-in-k8s">OPA in K8s</a></p></li>
<li><dl>
<dt>can configure security at container or pod level</dt><dd><ul class="simple">
<li><p>pod level security configuration is carried to all containers in it</p></li>
<li><p>configuration at container level will override that of the pod level</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># security.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">myapp-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># pod level</span>
<span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">    </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="c1"># container level</span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">      </span><span class="nt">runAsUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1001</span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span>
<span class="w">        </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;MAC_ADMIN&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># to view user</span>
kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>myapp-pod<span class="w"> </span>--<span class="w"> </span>whoami
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
<section id="authentication">
<h3>Authentication<a class="headerlink" href="#authentication" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>kube-apiserver can authenticate using username, password, token, certificate, LDAP and</p></li>
</ul>
<p>service account
* different authorizations such as RBAC, ABAC, Node, Webhook Mode
* communication with other components is secured using TLS certificates
* all user access is managed by kube-apiserver
* all requests, from kubectl or direct access to api, goes through kube-apiserver
* using csv file</p>
<blockquote>
<div><ul class="simple">
<li><p>a csv file with <code class="docutils literal notranslate"><span class="pre">password,user,userID</span></code> columns</p></li>
<li><p>pass it to authenticate using <code class="docutils literal notranslate"><span class="pre">--basic-auth-file=users.csv</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kube-apiserver.service</span></code> needs to be restarted</p></li>
<li><p>can have optional fourth column <code class="docutils literal notranslate"><span class="pre">group</span></code></p></li>
<li><p>can use tokens instead of passwords, use <code class="docutils literal notranslate"><span class="pre">--token-auth-file</span></code></p></li>
</ul>
</div></blockquote>
<ul>
<li><dl>
<dt>using kubeadm</dt><dd><ul class="simple">
<li><p>the kube-apiserver pod will be restarted once the <code class="docutils literal notranslate"><span class="pre">kube-apiserver.yml</span></code> file is</p></li>
</ul>
<p>modified</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>using curl</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-v</span> <span class="pre">-k</span> <span class="pre">https://main-node-ip:6443/api/v1/pods</span> <span class="pre">-u</span> <span class="pre">&quot;user1:password</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>using static file is deprecated</p></li>
</ul>
</div></blockquote>
</section>
<section id="kubeconfig">
<h3>kubeconfig<a class="headerlink" href="#kubeconfig" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>stores how to find and authenticate to cluster</p></li>
<li><p>to authenticate using a file instead of long command</p></li>
<li><p>by default, kubectl look for config under <code class="docutils literal notranslate"><span class="pre">$HOME/.kube/config</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pods</span> <span class="pre">--kubeconfig</span> <span class="pre">config</span></code>, no need to specify if config file exists</p></li>
<li><p>the file has three sections: clusters, contexts, users</p></li>
<li><dl class="simple">
<dt>clusters</dt><dd><ul class="simple">
<li><p>clusters that will be accessed</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>users</dt><dd><ul class="simple">
<li><p>user accounts which have access to the clusters</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>contexts</dt><dd><ul class="simple">
<li><p>define which user account will be used to access a cluster</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>example file</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Config</span>
<span class="nt">current-context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin@my-cluster</span><span class="w"> </span><span class="c1"># kubectl will use this context</span>
<span class="nt">clusters</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-cluster</span>
<span class="w">  </span><span class="nt">cluster</span><span class="p">:</span>
<span class="w">  </span><span class="nt">certificate-authority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
<span class="w">  </span><span class="nt">certificate-authority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CERT_DATA</span><span class="w"> </span><span class="c1"># not using a file</span>
<span class="w">  </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://my-cluster:6443</span>
<span class="nt">contexts</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin@my-cluster</span>
<span class="w">  </span><span class="nt">context</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cluster</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-cluster</span>
<span class="w">    </span><span class="nt">user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
<span class="w">    </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ns1</span>
<span class="l l-Scalar l-Scalar-Plain">users</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
<span class="w">  </span><span class="nt">user</span><span class="p">:</span>
<span class="w">  </span><span class="nt">client-certificate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin.crt</span>
<span class="w">  </span><span class="nt">client-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin.key</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>doesn’t need to create any object, file will be automatically used by kubectl</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>config<span class="w"> </span>view
kubectl<span class="w"> </span>config<span class="w"> </span>view<span class="w"> </span>--kubeconfig<span class="o">=</span>my-custom-config

<span class="c1"># change context to use user2 to access cluster1</span>
kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>user2@cluster1
</pre></div>
</div>
</div></blockquote>
</section>
<section id="authorization">
<h3>Authorization<a class="headerlink" href="#authorization" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>authorization modes are set using <code class="docutils literal notranslate"><span class="pre">--authorization-mode</span></code> on kube-apiserver</p></li>
<li><p>set to <code class="docutils literal notranslate"><span class="pre">AlwaysAllow</span></code> by default</p></li>
<li><p>can provide multiple modes and requests are authorized in order specified, forwarded to</p></li>
</ul>
<p>the next if the first one denies
* <strong>AlwaysAllow</strong> allows all without checking
* <strong>AlwaysDeny</strong> denies all requests
* <strong>Node</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>handles requests from users and kubelet</p></li>
<li><p>authorizes requests from users with the name ‘system:node’ and part of the ‘system:node’</p></li>
</ul>
</div></blockquote>
<ul>
<li><dl class="simple">
<dt><strong>ABAC</strong></dt><dd><ul class="simple">
<li><p>Attribute-Based Access Control</p></li>
<li><p>associates users with permissions</p></li>
<li><p>permissions are created using json file passed to the kube-apiserver</p></li>
<li><p>must manually edit the file and restart kube-apiserver if permissions change</p></li>
<li><p>difficult to manage</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Webhook</strong></dt><dd><ul class="simple">
<li><p>manage authorizations using third-party tools</p></li>
<li><p>e.g Open Policy Agent</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>RBAC</strong></dt><dd><ul class="simple">
<li><p>Role-Based Access Control</p></li>
<li><p>create a role with permissions and associate it to the users</p></li>
<li><p>only need to modify the role instead of modifying user</p></li>
<li><p>provide more standard approach</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># developer-role.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">developer</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;pods&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">resouceNames</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;web-app&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># only allow to access web-app pods</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;ConfigMap&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">]</span>

<span class="c1"># devuser-developer-role-binding.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">devuser-developer-binding</span>
<span class="nt">subjects</span><span class="p">:</span><span class="w"> </span><span class="c1"># user details</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">User</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev-user</span>
<span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class="nt">roleRef</span><span class="p">:</span><span class="w"> </span><span class="c1"># created role details</span>
<span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">developer</span>
<span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>developer-role.yml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>devuser-developer-role-binding.yml
kubectl<span class="w"> </span>get<span class="w"> </span>roles
kubectl<span class="w"> </span>get<span class="w"> </span>rolebindings
kubectl<span class="w"> </span>describe<span class="w"> </span>roles<span class="w"> </span>developer

<span class="c1"># Imperative method</span>
kubectl<span class="w"> </span>create<span class="w"> </span>role<span class="w"> </span>developer<span class="w"> </span>--namespace<span class="o">=</span>default<span class="w"> </span>--verb<span class="o">=</span>list,get,create<span class="w"> </span>--resource<span class="o">=</span>pods
kubectl<span class="w"> </span>create<span class="w"> </span>rolebinding<span class="w"> </span>dev-user-binding<span class="w"> </span>--namespace<span class="o">=</span>default<span class="w"> </span>--role<span class="o">=</span>developer<span class="w"> </span>--user<span class="o">=</span>dev-user
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>can check current access</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># yes if allowed</span>
kubectl<span class="w"> </span>auth<span class="w"> </span>can-i<span class="w"> </span>create<span class="w"> </span>deployments

<span class="c1"># no if not allowed</span>
kubectl<span class="w"> </span>auth<span class="w"> </span>can-i<span class="w"> </span>delete<span class="w"> </span>nodes

kubectl<span class="w"> </span>auth<span class="w"> </span>can-i<span class="w"> </span>delete<span class="w"> </span>nodes<span class="w"> </span>--as<span class="w"> </span>dev-user
kubectl<span class="w"> </span>auth<span class="w"> </span>can-i<span class="w"> </span>delete<span class="w"> </span>nodes<span class="w"> </span>--as<span class="w"> </span>dev-user<span class="w"> </span>--namespace<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">roles</span></code> and <code class="docutils literal notranslate"><span class="pre">rolebindings</span></code> are for authorizing users to namespaced resources</p></li>
<li><dl>
<dt>Namespace scoped</dt><dd><ul class="simple">
<li><p>resources that can specify namespace</p></li>
<li><p>pods, replicasets, jobs, deployments, services, sercrets, roles, rolebindings,</p></li>
</ul>
<p>configmaps, PVC</p>
</dd>
</dl>
</li>
<li><dl>
<dt>Cluster scoped</dt><dd><ul class="simple">
<li><p>resources that don’t need to specify namespace</p></li>
<li><p>such as nodes, PV, clusterroles, clusterrolebindings, certificatesigningrequests,</p></li>
</ul>
<p>namespaces</p>
</dd>
</dl>
</li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># list namespace scoped resources</span>
kubectl<span class="w"> </span>api-resources<span class="w"> </span>--namespaced<span class="o">=</span><span class="nb">true</span>

<span class="c1"># list non-namespace scoped resources</span>
kubectl<span class="w"> </span>api-resources<span class="w"> </span>--namespaced<span class="o">=</span><span class="nb">false</span>
</pre></div>
</div>
<ul>
<li><dl>
<dt>to authorize users for cluster scoped, use <code class="docutils literal notranslate"><span class="pre">clusterroles</span></code> and <code class="docutils literal notranslate"><span class="pre">clusterrolesbindings</span></code></dt><dd><ul class="simple">
<li><p>but can also be used to create namespaced resources</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># cluster-admin-role.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;nodes&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;list&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;get&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;create&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span>

<span class="c1"># cluster-admin-role-binding.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRoleBinding</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin-binding</span>
<span class="nt">subjects</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">User</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
<span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class="nt">roleRef</span><span class="p">:</span>
<span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster-admin</span>
<span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>cluster-admin.yml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>cluster-admin-role-binding.yml
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="tls-in-k8s">
<h3>TLS in K8s<a class="headerlink" href="#tls-in-k8s" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>communication between all components in K8s need to be secured</p></li>
<li><p>all servers within the cluster must use server certificates and all clients must use</p></li>
</ul>
<p>client certificates
* keys can be generated tools such as easyrsa, openssl, cfssl
* CA certificates</p>
<blockquote>
<div><ul class="simple">
<li><p>K8s requires to have at least one CA for the cluster</p></li>
<li><p>the CA have its own <code class="docutils literal notranslate"><span class="pre">ca.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">ca.key</span></code></p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># CA</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>ca.key<span class="w"> </span><span class="m">2048</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>ca.key<span class="w"> </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=KUBERNETES-CA&quot;</span><span class="w"> </span>-out<span class="w"> </span>ca.csr
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-in<span class="w"> </span>ca.csr<span class="w"> </span>-signkey<span class="w"> </span>ca.key<span class="w"> </span>-out<span class="w"> </span>ca.crt
</pre></div>
</div>
</div></blockquote>
<ul>
<li><dl>
<dt>client certificates</dt><dd><ol class="arabic simple">
<li><p>admin user requires <code class="docutils literal notranslate"><span class="pre">admin.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">admin.key</span></code> to communicate with kube-apiserver</p></li>
<li><p>kube-scheduler requires <code class="docutils literal notranslate"><span class="pre">scheduler.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">scheduler.key</span></code></p></li>
<li><p>kube-controller-manager requires <code class="docutils literal notranslate"><span class="pre">controller-manager.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">controller-manager.key</span></code></p></li>
<li><p>kube-proxy requires <code class="docutils literal notranslate"><span class="pre">kube-proxy.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">kube-proxy.key</span></code></p></li>
</ol>
<p>#. kube-apiserver is also a client from etcdserver point of view, as it is the only
component that communicates to it, kube-apiserver can use the keys generated or
generate <code class="docutils literal notranslate"><span class="pre">apiserver-etcd-client.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">apiserver-etcd-client.key</span></code>
#. kube-apiserver is also a client from kubelet server point of view, as it
communicates to it, kube-apiserver can use the keys generated or
generate <code class="docutils literal notranslate"><span class="pre">apiserver-kubelet-client.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">apiserver-kubelet-client.key</span></code>
#. kubelet-server is also a client from kube-apiserver point of view, as it
communicates to it, kubelet-server can use the keys generated or
generate <code class="docutils literal notranslate"><span class="pre">kubelet-client.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">kubelet-client.key</span></code>
- kube-apiserver needs to know which node is authenticating
- certificates are named <code class="docutils literal notranslate"><span class="pre">system:node:NODE_NAME</span></code>
- group names must be added, <code class="docutils literal notranslate"><span class="pre">system:nodes</span></code>, for API server to give right permissions</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Admin</span>
<span class="c1"># admin must add group details in the certificate to differentiate from other users</span>
<span class="c1"># &quot;system:masters&quot; group, with admin privileges, exists on K8s</span>
<span class="c1"># use same process to generate all client certificates</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>admin.key<span class="w"> </span><span class="m">2048</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>admin.key<span class="w"> </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=kube-admin/O=system:masters&quot;</span><span class="w"> </span>-out<span class="w"> </span>admin.csr
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-in<span class="w"> </span>admin.csr<span class="w"> </span>-CA<span class="w"> </span>ca.crt<span class="w"> </span>-CAkey<span class="w"> </span>ca.key<span class="w"> </span>-out<span class="w"> </span>admin.crt

<span class="c1"># kube-scheduler, kube-controller-manager, kube-proxy</span>
<span class="c1"># names must be prefixed with the keyword &quot;system&quot; as they are a system component part</span>
<span class="c1"># of K8s control-plane</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><dl>
<dt>server certificates</dt><dd><p>#. kube-apiserver exposes https service, so <code class="docutils literal notranslate"><span class="pre">apiserver.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">apiserver.key</span></code> must be
generated
- kube-apiserver is also called kubernetes, kubernetes.default, kubernetes.default.svc
kubernetes.default.svc.cluster.local or IP address of the host running kube-apiserver
or that of the pod running it
- all the names must be present in certificate generated
- <code class="docutils literal notranslate"><span class="pre">--etcd-cafile</span></code>, <code class="docutils literal notranslate"><span class="pre">--etcd-certfile</span></code>, <code class="docutils literal notranslate"><span class="pre">--etcd-keyfile</span></code>, <code class="docutils literal notranslate"><span class="pre">--client-ca-file</span></code>,
<code class="docutils literal notranslate"><span class="pre">--tls-cert-file</span></code>, <code class="docutils literal notranslate"><span class="pre">--tls-private-key-file</span></code>, <code class="docutils literal notranslate"><span class="pre">--kubelet-certificate-authority</span></code>,
<code class="docutils literal notranslate"><span class="pre">--kubelet-client-certificate</span></code>, <code class="docutils literal notranslate"><span class="pre">--kubelet-client-key</span></code>
#. etcd server also requires <code class="docutils literal notranslate"><span class="pre">etcdserver.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">etcdserver.key</span></code>
- since etcdserver can be deployed as cluster across multiple servers,
additional peer certificates, <code class="docutils literal notranslate"><span class="pre">etcdpeer1.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">etcdpeer1.key</span></code>, must be
generated to secure communication between each other
- require CA root certificate to verify clients are valid
- specify them while starting the server, <code class="docutils literal notranslate"><span class="pre">--key-file</span></code>, <code class="docutils literal notranslate"><span class="pre">--cert-file</span></code>,
<code class="docutils literal notranslate"><span class="pre">--peer-cert-file</span></code>, <code class="docutils literal notranslate"><span class="pre">--peer-client-cert</span></code>, <code class="docutils literal notranslate"><span class="pre">--peer-key-file</span></code>,
<code class="docutils literal notranslate"><span class="pre">--peer-trusted-ca-file</span></code>, <code class="docutils literal notranslate"><span class="pre">--trusted-ca-file</span></code>
#. kubelet server also requires <code class="docutils literal notranslate"><span class="pre">kubelet.crt</span></code> and <code class="docutils literal notranslate"><span class="pre">kubelet.key</span></code>
- need certificates for each in the node of the cluster
- certificates will be named after nodes
- must use the certificates in definition file for each node</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># etcdserver</span>
<span class="c1"># use same methods to generate</span>

<span class="c1"># kube-apiserver</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>apiserver.key<span class="w"> </span><span class="m">2048</span>

<span class="c1"># must create to openssl.cnf specify all alternate names</span>
<span class="c1"># openssl.cnf</span>
<span class="c1"># [req]</span>
<span class="c1"># req_extensions = v3_req</span>
<span class="c1"># distinguished_name = req_distinguished_name</span>
<span class="c1"># [ v3_req ]</span>
<span class="c1"># basicConstraints = CA:FALSE</span>
<span class="c1"># keyUsage = nonRepudiation,</span>
<span class="c1"># subjectAltName = @alt_names</span>
<span class="c1"># [alt_names]</span>
<span class="c1"># DNS.1 = kubernetes</span>
<span class="c1"># DNS.2 = kubernetes.default</span>
<span class="c1"># DNS.3 = kubernetes.default.svc</span>
<span class="c1"># DNS.4 = kubernetes.default.svc.cluster.local</span>
<span class="c1"># DNS.5 = HOST_IP</span>
<span class="c1"># DNS.6 = POD_IP</span>

openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>apiserver.key<span class="w"> </span>-subj<span class="w"> </span><span class="s2">&quot;/CN=kube-apiserver&quot;</span><span class="w"> </span><span class="se">\</span>
-out<span class="w"> </span>apiserver.csr<span class="w"> </span>-config<span class="w"> </span>openssl.cnf
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-in<span class="w"> </span>apiserver.csr<span class="w"> </span>-CA<span class="w"> </span>ca.crt<span class="w"> </span>-CAkey<span class="w"> </span>ca.key<span class="w"> </span>-CAcreateserial<span class="w"> </span><span class="se">\</span>
-out<span class="w"> </span>apiserver.crt<span class="w"> </span>-extensions<span class="w"> </span>v3_req<span class="w"> </span>-extfile<span class="w"> </span>openssl.cnf<span class="w"> </span>-days<span class="w"> </span><span class="m">1000</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># kubelet-config-node01.yaml</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KubeletConfiguration</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet.config.k8s.io/v1beta1</span>
<span class="nt">authentication</span><span class="p">:</span>
<span class="w">  </span><span class="nt">x509</span><span class="p">:</span>
<span class="w">    </span><span class="nt">clientCAFile</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/lib/kubernetes/ca.pem&quot;</span>
<span class="nt">authorization</span><span class="p">:</span>
<span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Webhook</span>
<span class="nt">clusterDomain</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;cluster.local&quot;</span>
<span class="nt">clusterDNS</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;10.32.0.10&quot;</span>
<span class="nt">podCIDR</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${POD_CIDR}&quot;</span>
<span class="nt">resolvConf</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/run/systemd/resolve/resolv.conf&quot;</span>
<span class="nt">runtimeRequestTimeout</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;15m&quot;</span>
<span class="nt">tlsCertFile</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/lib/kubelet/kubelet-node01.crt&quot;</span>
<span class="nt">tlsPrivateKeyFile</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/lib/kubelet/kubelet-node01.key&quot;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>generated certificates can be used for API calls</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>https://kube-apiserver:6443/api/v1/pods<span class="w"> </span><span class="se">\</span>
--key<span class="w"> </span>admin.key<span class="w"> </span>--cert<span class="w"> </span>admin.crt<span class="w"> </span>--cacert<span class="w"> </span>ca.crt
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>or move all the parameters into kube-config</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># kube-config.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">clusters</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">clusters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">certificate-authority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ca.crt</span>
<span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://kube-apiserver:6443</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Config</span>
<span class="nt">users</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubernetes-admin</span>
<span class="w">  </span><span class="nt">user</span><span class="p">:</span>
<span class="w">    </span><span class="nt">client-certificate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin.crt</span>
<span class="w">    </span><span class="nt">client-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin.key</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</section>
<section id="certificates-api">
<h3>Certificates API<a class="headerlink" href="#certificates-api" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>CA files for K8s are stored in CA server</p></li>
<li><p>can only sign a certificate by logging in into the CA server</p></li>
<li><p>since the files are stored in the control-plane node, it is the CA server</p></li>
<li><p>can send CSR directly to K8s through Certificates API call, no need to login to the server</p></li>
<li><p>admin can create CertificateSigningRequest object</p></li>
<li><p>once the object is created, all CSR can be seen by admins, review, approve and share</p></li>
</ul>
<p>with the users
* all certificate related operations are carried out by the kube-controller-manager
* <code class="docutils literal notranslate"><span class="pre">signerName:</span> <span class="pre">kubernetes.io/kube-apiserver-client</span></code>, for client authentication</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># user1-csr.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">certificates.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CertificateSigningRequest</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user1</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">system:authenticated</span>
<span class="w">  </span><span class="nt">usages</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">digital signature</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">key encipherment</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server auth</span>
<span class="w">  </span><span class="nt">request</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">userCSRinEncodedForm</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>user1-csr.yml
kubectl<span class="w"> </span>get<span class="w"> </span>csr
kubectl<span class="w"> </span>certificate<span class="w"> </span>approve<span class="w"> </span>user1
kubectl<span class="w"> </span>get<span class="w"> </span>csr<span class="w"> </span>user1<span class="w"> </span>-o<span class="w"> </span>yaml
</pre></div>
</div>
<ul>
<li><dl>
<dt><strong>Viewing Certificate Details</strong></dt><dd><ul class="simple">
<li><p>look for <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes/manifests/kube-apiserver.yml</span></code> file</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">command:</span></code> under <code class="docutils literal notranslate"><span class="pre">containers:</span></code> has all the information</p></li>
<li><p>after decoding the certificate, start by looking <code class="docutils literal notranslate"><span class="pre">subject:</span></code>, which has certificate</p></li>
</ul>
<p>name, then look for <code class="docutils literal notranslate"><span class="pre">X509v3</span> <span class="pre">Subject</span> <span class="pre">Alternative</span> <span class="pre">Name</span></code>, <code class="docutils literal notranslate"><span class="pre">Not</span> <span class="pre">After</span></code>, <code class="docutils literal notranslate"><span class="pre">Issuer</span></code>
- when built from scratch, view logs with <code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">etcd.service</span> <span class="pre">-l</span></code>
- in kubeadm, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span> <span class="pre">etcd-controlplane</span></code>
- if the core components are down, <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">logs</span> <span class="pre">CONTAINER_ID</span></code></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/kubernetes/pki/apiserver.crt</span>
<span class="c1"># decode and view details</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-in<span class="w"> </span>/etc/kubernetes/pki/apiserver.crt<span class="w"> </span>-text<span class="w"> </span>-noout
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="image-security">
<h3>Image Security<a class="headerlink" href="#image-security" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">image:</span> <span class="pre">nginx</span></code> is equal to <code class="docutils literal notranslate"><span class="pre">image:</span> <span class="pre">docker.io/library/nginx</span></code></p></li>
<li><p>docker.io: registry</p></li>
<li><p>library: user/account</p></li>
<li><p>nginx: image/repository</p></li>
<li><p>can use private registries</p></li>
<li><p>to pass credentials for private registry, first create secret object</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>docker-registry<span class="w"> </span>regcred<span class="w"> </span><span class="se">\</span>
--docker-server<span class="o">=</span>private-registry.io<span class="w"> </span><span class="se">\</span>
--docker-username<span class="o">=</span>registry-user<span class="w"> </span><span class="se">\</span>
--docker-password<span class="o">=</span>registry-password<span class="w"> </span><span class="se">\</span>
--docker-email<span class="o">=</span>registry-user@org.com
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># custom-image-pod.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app1</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">private-registry.io/apps/app1</span>
<span class="w">  </span><span class="nt">imagePullSecrets</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">regcred</span><span class="w"> </span><span class="c1"># secret object name</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="k8s-attack-surface">
<h3>K8s Attack Surface<a class="headerlink" href="#k8s-attack-surface" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl>
<dt>example attack</dt><dd><ul class="simple">
<li><p>attacker tries to find the IP address of the application, <code class="docutils literal notranslate"><span class="pre">ping</span> <span class="pre">www.site.com</span></code> and</p></li>
</ul>
<p>the site responds with IP
- then port scan the server and one port is opened, e.g docker port
- run docker command with the hostname, <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">-H</span> <span class="pre">www.site.com</span> <span class="pre">ps</span></code>, and success
- run a new privileged container in the environment,
<code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">-H</span> <span class="pre">www.site.com</span> <span class="pre">run</span> <span class="pre">--privileged</span> <span class="pre">-it</span> <span class="pre">ubuntu</span> <span class="pre">bash</span></code>
- from the container, install the necessary utilities and download the attack script
- runs the script to escape from the container onto the host
- run various commands on the host to get more information about the infrastructure
- find out about K8s dashboard, <code class="docutils literal notranslate"><span class="pre">iptables</span> <span class="pre">-L</span> <span class="pre">-t</span> <span class="pre">nat</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">kubernetes-dashboard</span></code>
- can visit the K8s dashboard as it is setup without security
- information about the whole cluster is now exposed</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>4C’s of Cloud Native Security</dt><dd><ol class="arabic simple">
<li><p>Cloud: security of the entire infrastructure, e.g data center, network, servers</p></li>
<li><p>Cluster: e.g authentication, authorization, admission, network policy</p></li>
<li><p>Container: e.g restrict images, supply chain, sandboxing, privileged</p></li>
<li><p>Code: code with security best practices</p></li>
</ol>
</dd>
</dl>
</li>
<li><p>[Security Overview](<a class="reference external" href="https://kubernetes.io/docs/concepts/security/overview/">https://kubernetes.io/docs/concepts/security/overview/</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="kubelet-security">
<h3>Kubelet Security<a class="headerlink" href="#kubelet-security" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>kubelet must be installed manually if using kubeadm</p></li>
<li><p>most parameters for <code class="docutils literal notranslate"><span class="pre">kubelet.service</span></code> startup are moved into <code class="docutils literal notranslate"><span class="pre">kubelet-config.yaml</span></code></p></li>
<li><p>pass the file as argument <code class="docutils literal notranslate"><span class="pre">--config=/var/lib/kubelet/kubelet-config.yaml</span></code></p></li>
<li><p>kubeadm auto configure kubelet configuration file on each node when <code class="docutils literal notranslate"><span class="pre">kubeadm</span> <span class="pre">join</span></code></p></li>
<li><p>view kubelet options, <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">kubelet</span></code></p></li>
<li><dl class="simple">
<dt>serves on two ports</dt><dd><ul>
<li><p>10250: serves API that allows full access</p></li>
<li><p>10255: serves API that allows unauthenticated read-only access</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>allows anonymous access to its API by default</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-sk</span> <span class="pre">https://localhost:10250/pods</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-sk</span> <span class="pre">https://localhost:10255/metrics</span></code></p></li>
<li><p>set <code class="docutils literal notranslate"><span class="pre">--anonymous-auth=false</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>certificate authentication (x509)</strong></dt><dd><ul>
<li><p>default approach by kubeadm</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--client-ca-file=/path/to/ca.crt</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-sk</span> <span class="pre">https://localhost:10250/pods/</span> <span class="pre">--key</span> <span class="pre">key.pem</span> <span class="pre">--cart</span> <span class="pre">cert.pem</span></code></p></li>
<li><p>from kube-apiserver, <code class="docutils literal notranslate"><span class="pre">--kubelet-client-certificate</span></code>, <code class="docutils literal notranslate"><span class="pre">--kubelet-client-key</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>also bearer token authentication is available</p></li>
<li><p>if both authentication methods explicitly reject a request, by default will allow</p></li>
</ul>
<p>anonymous request of user, <cite>system-anonymous</cite>, with group, <cite>system-unauthenticated</cite>
* <strong>authorization</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>default mode, <code class="docutils literal notranslate"><span class="pre">--authorization-mode=AlwaysAllow</span></code></p></li>
<li><p>disable <code class="docutils literal notranslate"><span class="pre">localhost:10255/metrics</span></code>, <code class="docutils literal notranslate"><span class="pre">--read-only-port=0</span></code>, default is set to 10255</p></li>
<li><p>if kubelet config file is in use, <code class="docutils literal notranslate"><span class="pre">readOnlyPort</span></code> defaults to 0</p></li>
</ul>
</div></blockquote>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># kubelet-config.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet.config.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">KubeletConfiguration</span>
<span class="nt">clusterDomain</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cluster.local</span>
<span class="nt">fileCheckFrequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
<span class="nt">healthzPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10248</span>
<span class="nt">clusterDNS</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.86.0.10</span>
<span class="nt">httpCheckFrequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
<span class="nt">sysncFrequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0s</span>
<span class="c1"># --read-only-port=0</span>
<span class="nt">readOnlyPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
<span class="nt">authentication</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># --anonymous-auth</span>
<span class="w">  </span><span class="nt">anonymous</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="c1"># --client-ca-file</span>
<span class="w">  </span><span class="nt">x509</span><span class="p">:</span>
<span class="w">    </span><span class="nt">clientCAFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/ca.crt</span>
<span class="nt">authorization</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># --authorization-mode=Webhook</span>
<span class="w">  </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Webhook</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>always verify platform binaries before applying</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">shasum</span> <span class="pre">-a</span> <span class="pre">512</span> <span class="pre">kubernetes.tar.gz</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shasum512</span> <span class="pre">kubernetes.tar.gz</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="pod-security-policies">
<h3>Pod Security Policies<a class="headerlink" href="#pod-security-policies" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>deprecated in v1.21, removed in v1.25, use [Pod Security Admission](<a class="reference external" href="https://kubernetes.io/docs/concepts/security/pod-security-admission/">https://kubernetes.io/docs/concepts/security/pod-security-admission/</a>) or third-party</p></li>
</ul>
<p>admission plugin
* restrict pods from being created with specific capabilities
* one of admission controllers, <code class="docutils literal notranslate"><span class="pre">PodSecurityPolicy</span></code>
* not enabled by default, <code class="docutils literal notranslate"><span class="pre">kube-apiserver</span> <span class="pre">-h</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">enable-admission-plugins</span></code>
* observes all pod creation requests and validate against the policy
* both enable the plugin and be authorized to policy API
* create a role and bind it to a pod to be authorized to API</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># psp.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy/v1beta1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PodSecurityPolicy</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-psp</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># reject containers with true</span>
<span class="w">  </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">  </span><span class="nt">seLinux</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RunAsAny</span>
<span class="w">  </span><span class="nt">supplementalGroups</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RunAsAny</span>
<span class="w">  </span><span class="nt">runAsUser</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RunAsAny</span>
<span class="w">  </span><span class="nt">fsGroup</span><span class="p">:</span>
<span class="w">    </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RunAsAny</span>

<span class="c1"># psp-role.yml</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">psp-role</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;policy&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;podsecuritypolicies&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">resroucesNames</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;example-psp&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;use&quot;</span><span class="p p-Indicator">]</span>

<span class="c1"># psp-rolebinding.yml</span>
<span class="nt">subjects</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">roleRef</span><span class="p">:</span>
<span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Role</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">psp-role</span>
<span class="w">  </span><span class="nt">apiGroup</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="opa-in-k8s">
<h3>OPA in K8s<a class="headerlink" href="#opa-in-k8s" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>can connect Webhook controllers to OPA instead of custom server</p></li>
<li><dl class="simple">
<dt><strong>kube-mgmt</strong></dt><dd><ul>
<li><p>deployed as sidecar alongside OPA</p></li>
<li><p>used to replicate resource definitions from K8s to be cached in OPA</p></li>
<li><p>the cached info can be imported to be used in policies</p></li>
<li><p>also used to load policies into OPA by creating configmaps, no need to manually add</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kube-mgmt</span></code> auto identifies the policies in the configmap and load them into OPA</p></li>
<li><p>or <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">create</span> <span class="pre">configmap</span> <span class="pre">policy-podname</span> <span class="pre">--from-file=kubernetes.rego</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>deploy OPA and kube-mgmt in <code class="docutils literal notranslate"><span class="pre">opa</span></code> namespace with necessary roles and rolebindings and</p></li>
</ul>
<p>have a service for OPA</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># opa-validate-webhook.yml</span>
<span class="nt">webhooks</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">clientConfig</span><span class="p">:</span>
<span class="w">    </span><span class="c1"># since OPA is deployed in cluster as service</span>
<span class="w">    </span><span class="nt">caBundle</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$(cat ca.crt | base64 | tr -d &#39;\n&#39;)</span>
<span class="w">    </span><span class="nt">service</span><span class="p">:</span>
<span class="w">      </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opa</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opa</span>
</pre></div>
</div>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="c1">// kubernetes.rego</span>
<span class="kr">package</span><span class="w"> </span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">admission</span>
<span class="c1">// get information about all pods in the cluster</span>
<span class="k">import</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">kubernetes</span><span class="p">.</span><span class="nx">pods</span>
<span class="nx">deny</span><span class="p">[</span><span class="nx">msg</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">input</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">kind</span><span class="p">.</span><span class="nx">kind</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">&quot;Pod&quot;</span>
<span class="w">    </span><span class="nx">image</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">input</span><span class="p">.</span><span class="nx">request</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">spec</span><span class="p">.</span><span class="nx">containers</span><span class="p">[</span><span class="nx">_</span><span class="p">].</span><span class="nx">image</span>
<span class="w">    </span><span class="nx">startswith</span><span class="p">(</span><span class="nx">image</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;hooli.com/&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">msg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sprintf</span><span class="p">(</span><span class="s2">&quot;image &#39;%v&#39; from untrusted registry&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">image</span><span class="p">])</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># using kube-mgmt</span>
<span class="c1"># kubernetes.rego</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">policy-podname</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">opa</span>
<span class="w">  </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">openpolicyagent.org/policy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">rego</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">main</span><span class="p">:</span>
<span class="w">   </span><span class="c1"># rego policy added here</span>
</pre></div>
</div>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#declarative">Declarative</a>, <a class="reference internal" href="#imperative">Imperative</a>, <a class="reference internal" href="#namespaces">Namespaces</a>, <a class="reference internal" href="#labels">Labels</a>, <a class="reference internal" href="#annotations">Annotations</a></p></li>
<li><p><a class="reference internal" href="#specify-arguments-and-commands">Specify arguments and commands</a>, <a class="reference internal" href="#configmaps">ConfigMaps</a>, <a class="reference internal" href="#secrets">Secrets</a></p></li>
<li><p><a class="reference internal" href="#setting-env-variables">Setting ENV variables</a>, <a class="reference internal" href="#resource-requirements">Resource Requirements</a>, <a class="reference internal" href="#service-accounts">Service Accounts</a>, <a class="reference internal" href="#taints-tolerations">Taints &amp; Tolerations</a></p></li>
<li><p><a class="reference internal" href="#node-selectors">Node Selectors</a>, <a class="reference internal" href="#node-affinity">Node Affinity</a>, <a class="reference internal" href="#custom-resource-definition">Custom Resource Definition</a></p></li>
</ul>
<section id="declarative">
<h3>Declarative<a class="headerlink" href="#declarative" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>everything in K8s is a declarative configuration object that represents the desired state</p></li>
<li><p>create set of definition/manifest files</p></li>
<li><p>storing declarative configuration in source control is often referred to as IaC</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># creating, deleting, updating object</span>
<span class="c1"># will create if doesn&#39;t exist</span>
<span class="c1"># will look at the existing configuration and figure out what changes need to be made</span>
<span class="c1"># never throws an error</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>definition.yml
</pre></div>
</div>
</div></blockquote>
</section>
<section id="imperative">
<h3>Imperative<a class="headerlink" href="#imperative" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>state is defined by the execution of a series of instructions</p></li>
<li><p>use imperative commands to do one time tasks quickly</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--dry-run</span></code>: resource will be created as soon as the command is run</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--dry-run=client</span></code>: just test the command without creating the resource</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">yaml</span></code>: output the resource definition in YAML format on screen</p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">expose</span></code> for most commands to auto set selectors</p></li>
<li><p>generate a definition file if need to specify a node port</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># generate deployment with 4 replicas</span>
kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>--replicas<span class="o">=</span><span class="m">4</span>

<span class="c1"># scale a deployment</span>
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span>--replicas<span class="o">=</span><span class="m">4</span>

<span class="c1"># create pod with exposed port 80 and service of the same name</span>
kubectl<span class="w"> </span>run<span class="w"> </span>httpd<span class="w"> </span>--image<span class="o">=</span>httpd<span class="w"> </span>--port<span class="o">=</span><span class="m">80</span><span class="w"> </span>--expose<span class="o">=</span><span class="nb">true</span>

<span class="c1"># generate YAML files</span>
kubectl<span class="w"> </span>run<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml

kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>nginx<span class="w"> </span>--dry-run<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># create YAML file and edit replicas to scale</span>
kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span><span class="se">\</span>
-o<span class="w"> </span>yaml<span class="w"> </span>&gt;<span class="w"> </span>nginx-deployment.yaml

<span class="c1"># service type of ClusterIP and expose pod on port 6379, use pod&#39;s label as selector</span>
<span class="c1"># cannot pass in selectors as option</span>
kubectl<span class="w"> </span>expose<span class="w"> </span>pod<span class="w"> </span>redis<span class="w"> </span>--port<span class="o">=</span><span class="m">6379</span><span class="w"> </span>--name<span class="w"> </span>redis-service<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># will not use pod&#39;s label as selectors, assume selector as &#39;app=redis&#39;</span>
kubectl<span class="w"> </span>create<span class="w"> </span>service<span class="w"> </span>clusterip<span class="w"> </span>redis<span class="w"> </span>--tcp<span class="o">=</span><span class="m">6379</span>:6379<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># service of type NodePort, use pod&#39;s labels as selectors, cannot specify the node port</span>
kubectl<span class="w"> </span>expose<span class="w"> </span>pod<span class="w"> </span>nginx<span class="w"> </span>--port<span class="o">=</span><span class="m">80</span><span class="w"> </span>--name<span class="w"> </span>nginx-service<span class="w"> </span>--type<span class="o">=</span>NodePort<span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1"># will not use pods labels as selectors</span>
kubectl<span class="w"> </span>create<span class="w"> </span>service<span class="w"> </span>nodeport<span class="w"> </span>nginx<span class="w"> </span>--tcp<span class="o">=</span><span class="m">80</span>:80<span class="w"> </span>--node-port<span class="o">=</span><span class="m">30080</span><span class="w"> </span>--dry-run<span class="o">=</span>client<span class="w"> </span>-o<span class="w"> </span>yaml

<span class="c1">###############</span>
<span class="c1"># create objects</span>
kubectl<span class="w"> </span>run<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>nginx
kubectl<span class="w"> </span>create<span class="w"> </span>deployment<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>nginx
kubectl<span class="w"> </span>expose<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span>--port<span class="w"> </span><span class="m">80</span>

<span class="c1"># object cannot exist</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>nginx.yml

<span class="c1"># update objects</span>
kubectl<span class="w"> </span>edit<span class="w"> </span>deployment<span class="w"> </span>nginx
kubectl<span class="w"> </span>scale<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span>--replicas<span class="o">=</span><span class="m">5</span>
kubectl<span class="w"> </span><span class="nb">set</span><span class="w"> </span>image<span class="w"> </span>deployment<span class="w"> </span>nginx<span class="w"> </span><span class="nv">nginx</span><span class="o">=</span>nginx:1.18

<span class="c1"># after editing local definition file, update the object and changes made are recorded</span>
kubectl<span class="w"> </span>replace<span class="w"> </span>-f<span class="w"> </span>nginx.yml

<span class="c1"># delete and recreate, object needs to exists first</span>
kubectl<span class="w"> </span>replace<span class="w"> </span>--force<span class="w"> </span>-f<span class="w"> </span>nginx.yml
</pre></div>
</div>
</div></blockquote>
</section>
<section id="namespaces">
<h3>Namespaces<a class="headerlink" href="#namespaces" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>isolate resources, each namespace has policies and quota of resources</p></li>
<li><dl class="simple">
<dt><strong>default</strong></dt><dd><ul>
<li><p>everything is done in <code class="docutils literal notranslate"><span class="pre">default</span></code> namespace</p></li>
<li><p>created at when cluster is setup</p></li>
<li><p>isolate users from interacting with internal resources</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>kube-system</strong></dt><dd><ul>
<li><p>for internal resources required by K8s</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>kube-public</strong></dt><dd><ul>
<li><p>for resources that are available for all users</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>can have <code class="docutils literal notranslate"><span class="pre">namespace</span></code> under <code class="docutils literal notranslate"><span class="pre">metadata</span></code> section in pod-definition.yml to set the pod be always</p></li>
</ul>
<p>created in <cite>dev</cite></p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># list the pods in other namespace</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--namespace<span class="o">=</span>kube-system

<span class="c1">#list pods in all namespaces</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--all-namespaces

<span class="c1"># create the pod in `dev` namespace</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>pod-definition.yml<span class="w"> </span>--namespace<span class="o">=</span>dev

<span class="c1"># create new namespace `dev`</span>
kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>dev

<span class="c1"># get all namespaces</span>
kubectl<span class="w"> </span>get<span class="w"> </span>namespaces

<span class="c1"># run nginx pod in `dev` namespace</span>
kubectl<span class="w"> </span>run<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>-n<span class="o">=</span>dev
</pre></div>
</div>
<ul>
<li><p>create new namespace using YAML</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># namespace-dev.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespace</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><dl class="simple">
<dt><strong>Switching namespace</strong></dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">config</span> <span class="pre">set-context</span> <span class="pre">$(kubectl</span> <span class="pre">config</span> <span class="pre">current-context)</span> <span class="pre">--namespace=dev</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Resource Quota</strong></dt><dd><ul class="simple">
<li><p>to limit resources in a namespace</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># compute-quota.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ResourceQuota</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">compute-quota</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">dev</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">hard</span><span class="p">:</span>
<span class="w">    </span><span class="nt">pods</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
<span class="w">    </span><span class="nt">requests.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;4&quot;</span>
<span class="w">    </span><span class="nt">requests.memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5Gi</span>
<span class="w">    </span><span class="nt">limits.cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10&quot;</span>
<span class="w">    </span><span class="nt">limits.memory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10Gi</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="labels">
<h3>Labels<a class="headerlink" href="#labels" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>key/value pairs for identifying metadata for objects</p></li>
<li><p>used for grouping, viewing and operating of the object</p></li>
<li><dl class="simple">
<dt>key</dt><dd><ul>
<li><p>optional prefix and name, separated by a slash</p></li>
<li><p>prefix: must be a DNS subdomain with 253 characters max</p></li>
<li><p>name: required, 63 characters max</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>value</dt><dd><ul>
<li><p>strings with 63 characters max</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>e.g <code class="docutils literal notranslate"><span class="pre">kubernetes.io/cluster-service:</span> <span class="pre">&quot;true&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">label</span></code> command only changes the label on the deployment itself and won’t affect</p></li>
</ul>
<p>any objects it creates
* label selectors are used to filter objects
* <code class="docutils literal notranslate"><span class="pre">pod-template-hash</span></code> label is applied by the deployment to track which pods were generated
from which template versions</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>run<span class="w"> </span>myapp-pod<span class="w"> </span>--labels<span class="o">=</span><span class="s2">&quot;type=web,env=prod&quot;</span>

<span class="c1"># show labels</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--show-labels

<span class="c1"># edit labels</span>
kubectl<span class="w"> </span>label<span class="w"> </span>pods<span class="w"> </span>myapp-pod<span class="w"> </span><span class="s2">&quot;env=test&quot;</span>

<span class="c1"># remove labels</span>
kubectl<span class="w"> </span>label<span class="w"> </span>deployments<span class="w"> </span>myapp<span class="w"> </span><span class="s2">&quot;env-&quot;</span>

<span class="c1"># list pods that has specific label</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--selector<span class="o">=</span><span class="s2">&quot;type=web&quot;</span>
<span class="c1"># NOT</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--selector<span class="o">=</span><span class="s2">&quot;type!=web&quot;</span>
<span class="c1"># AND</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--selector<span class="o">=</span><span class="s2">&quot;type=web,env=test&quot;</span>
<span class="c1"># one of the values</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--selector<span class="o">=</span><span class="s2">&quot;env in (test,prod)&quot;</span>
<span class="c1"># not of the values</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--selector<span class="o">=</span><span class="s2">&quot;env notin (test,prod)&quot;</span>
<span class="c1"># key is set</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--selector<span class="o">=</span><span class="s2">&quot;env&quot;</span>
<span class="c1"># key is not set</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--selector<span class="o">=</span><span class="s2">&quot;!env&quot;</span>
<span class="c1"># combinations</span>
kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-l<span class="w"> </span><span class="s2">&quot;type=web,!env&quot;</span>
</pre></div>
</div>
<ul>
<li><p>most objects support newer set of selector operators that can be used in YAML</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">selector</span><span class="p">:</span>
<span class="w">  </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<span class="w">  </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="p p-Indicator">{</span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="nv">env</span><span class="p p-Indicator">,</span><span class="nt"> operator</span><span class="p">:</span><span class="w"> </span><span class="nv">In</span><span class="p p-Indicator">,</span><span class="nt"> values</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">test</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">prod</span><span class="p p-Indicator">]}</span><span class="w"> </span><span class="c1"># evaluated as AND</span>

<span class="c1"># older form</span>
<span class="nt">selector</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">web</span>
<span class="w">  </span><span class="nt">env</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prod</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</section>
<section id="annotations">
<h3>Annotations<a class="headerlink" href="#annotations" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>not meant for querying, filtering or differentiating pods from each other</p></li>
<li><p>a place to store additional metadata only to assist tools and libraries</p></li>
<li><p>can be used for the tool itself or pass information between external systems</p></li>
<li><p>add information as annotation and change to label if it will be used as selector</p></li>
<li><dl>
<dt>use cases</dt><dd><ul class="simple">
<li><p>track/detect change cause, communicate policy to specialized scheduler</p></li>
<li><p>attach build, release, or image information</p></li>
<li><p>provide extra data for a UI</p></li>
<li><p>encode parameters for alpha functionality</p></li>
<li><p>enable Deployment object to keep track of ReplicaSet for rollout status and provide</p></li>
</ul>
<p>necessary data to roll back</p>
</dd>
</dl>
</li>
<li><p>good for small bits of data that are associated with specific resource</p></li>
<li><dl>
<dt>key</dt><dd><ul class="simple">
<li><p>‘namespace’ part is more important as they are used to communicate information</p></li>
</ul>
<p>between tools</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>value</dt><dd><ul class="simple">
<li><p>free-form string field to store arbitrary data of any format</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>when domain names are used in labels and annotations, they are expected to be aligned to that</p></li>
</ul>
<p>particular entity</p>
</section>
<section id="specify-arguments-and-commands">
<h3>Specify arguments and commands<a class="headerlink" href="#specify-arguments-and-commands" title="Link to this heading">#</a></h3>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-sleeper-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;sleep&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;100&quot;</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">args</span></code> overrides CMD, <code class="docutils literal notranslate"><span class="pre">command</span></code> overrides ENTRYPOINT in Dockerfile</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-sleeper-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep2.0&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;10&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># create pod with custom args</span>
kubectl<span class="w"> </span>run<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>--<span class="w"> </span>CUSTOM_ARGUMENT

<span class="c1"># create pod with custom args and commands</span>
kubectl<span class="w"> </span>run<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>--command<span class="w"> </span>--<span class="w"> </span>COMMAND<span class="w"> </span>ARGUMENT
</pre></div>
</div>
</div></blockquote>
</section>
<section id="configmaps">
<h3>ConfigMaps<a class="headerlink" href="#configmaps" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>separate env variables from definition file</p></li>
<li><p>in key/value pairs</p></li>
<li><p>name appropriately as it can be associated with pods</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># config-map.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConfigMap</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-config</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ENV_NAME1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENV_VALUE1</span>
<span class="w">  </span><span class="nt">ENV_NAME2</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENV_VALUE2</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1">## Imperative method</span>
<span class="c1"># &#39;--from-literal&#39; specifies key/value pair, specify &#39;--from-literal&#39; multiple times</span>
kubectl<span class="w"> </span>create<span class="w"> </span>configmap<span class="w"> </span>app-config<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">ENV_NAME</span><span class="o">=</span>ENV_VALUE

<span class="c1"># get from a file</span>
kubectl<span class="w"> </span>create<span class="w"> </span>cm<span class="w"> </span>app-config<span class="w"> </span>--from-file<span class="o">=</span>app_config.properties


<span class="c1">## Declarative method</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>config-map.yml

<span class="c1"># configmaps info</span>
kubectl<span class="w"> </span>get<span class="w"> </span>configmaps
kubectl<span class="w"> </span>describe<span class="w"> </span>configmaps
</pre></div>
</div>
</div></blockquote>
</section>
<section id="secrets">
<h3>Secrets<a class="headerlink" href="#secrets" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to store env variables in encrypted format, in key/value pairs</p></li>
<li><p>do not check secret definition files in SCM</p></li>
<li><p>[enable encryption at rest](<a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/">https://kubernetes.io/docs/tasks/administer-cluster/encrypt-data/</a>) to be stored encrypted in etcd</p></li>
<li><p>a secret is only send to a node if a pod on that node requires it</p></li>
<li><p>kubelet stores the secret into a tmpfs</p></li>
<li><p>kubelet deletes local copy of secret if the pod is deleted</p></li>
<li><p>can use tools like Helm Secrets, HashiCorp Vault</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># secret-data.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-secret</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">DB_HOST</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">iNenCodeDforMaT</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1">## Imperative method</span>

kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>generic<span class="w"> </span>app-secret<span class="w"> </span>--from-literal<span class="o">=</span><span class="nv">DB_HOST</span><span class="o">=</span>mysql

<span class="c1"># get from a file</span>
kubectl<span class="w"> </span>create<span class="w"> </span>secret<span class="w"> </span>app-secret<span class="w"> </span>--from-file<span class="o">=</span>app_secret.properties

<span class="c1"># secrets must be encoded first to store in YAML file</span>
<span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;mysql&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64
<span class="c1"># decode sercrets</span>
<span class="nb">echo</span><span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;iNenCodeDforMaT&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span>--decode

<span class="c1">## Declarative method</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>secret-data.yml

<span class="c1"># secrets info</span>
kubectl<span class="w"> </span>get<span class="w"> </span>secrets

<span class="c1"># hides the value, only show size</span>
kubectl<span class="w"> </span>describe<span class="w"> </span>secrets

<span class="c1"># show in encoded format</span>
kubectl<span class="w"> </span>get<span class="w"> </span>secrets<span class="w"> </span>app-secret<span class="w"> </span>-o<span class="w"> </span>yaml
</pre></div>
</div>
</div></blockquote>
</section>
<section id="setting-env-variables">
<h3>Setting ENV variables<a class="headerlink" href="#setting-env-variables" title="Link to this heading">#</a></h3>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>run<span class="w"> </span>nginx<span class="w"> </span>--image<span class="o">=</span>nginx<span class="w"> </span>--env<span class="o">=</span><span class="s2">&quot;ENV_NAME1=ENV_VALUE1&quot;</span>
</pre></div>
</div>
<ul>
<li><p>plain key/value format</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ubuntu-sleeper-pod</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx-container</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">conatinerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">    </span><span class="nt">env</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENV_NAME</span>
<span class="w">      </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENV_VALUE</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>using configmaps and secrets</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-container</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-container</span>
<span class="w">      </span><span class="nt">envFrom</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">configMapRef</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-config</span>
<span class="w">      </span><span class="c1"># OR</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-secret</span>
<span class="w">          </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DB_PASSWORD</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><p>injecting single env to a pod</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-container</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-container</span>
<span class="w">      </span><span class="nt">env</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENV_NAME1</span>
<span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span>
<span class="w">          </span><span class="nt">configMapKeyRef</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-config</span>
<span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ENV_NAME1</span>
<span class="w">      </span><span class="c1"># OR</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DB_PASSWORD</span>
<span class="w">        </span><span class="nt">valueFrom</span><span class="p">:</span>
<span class="w">          </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<span class="w">            </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-secre</span>
<span class="w">            </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DB_PASSWORD</span>
</pre></div>
</div>
</div></blockquote>
</li>
<li><dl>
<dt>injecting as files in a volume to a pod</dt><dd><ul class="simple">
<li><p>each attribute in a secret is created as a file with the value as content</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-container</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-container</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-config-volume</span>
<span class="w">        </span><span class="nt">configMap</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-config</span>
<span class="w">      </span><span class="c1"># OR</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-secret-volume</span>
<span class="w">        </span><span class="nt">secret</span><span class="p">:</span>
<span class="w">          </span><span class="nt">secretName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">app-secret</span>
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>efficiency is measure in utilization, the amount of resource actively being used divided by</p></li>
</ul>
<p>the amount of resource that has been purchased</p>
</section>
<section id="resource-requirements">
<h3>Resource Requirements<a class="headerlink" href="#resource-requirements" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>scheduler move pods to another node if the current is insufficient of resources</p></li>
<li><p>scheduler holds the pod in pending state if all nodes are out of resources</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requests</span></code>: minimum amount of resource required to run the application</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">limits</span></code>: maximum amount of resource that an application can consume</p></li>
<li><p>can use <code class="docutils literal notranslate"><span class="pre">MB/GB/PB</span></code> or <code class="docutils literal notranslate"><span class="pre">MiB/GiB/PiB</span></code></p></li>
<li><p>resources are requested per container, not per pod</p></li>
<li><p>K8s limits 1 vCPU, 512 Mi per pod by default</p></li>
<li><p>K8s throttles the pod if cpu limit is reached and the pod is terminated if memory limit</p></li>
</ul>
<p>is reached
* scheduler will ensure the sum of all requests of all pods on a node does not exceed the
capacity of the node
* if a container is over its memory request, the OS can’t remove memory from the process as
it has been allocated
* when the system runs out of memory, <code class="docutils literal notranslate"><span class="pre">kubelet</span></code> terminates containers whose memory usage is
greater than their requested memory and containers are auto restarted but with less
available memory
* can modify resource values in definition file</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">      </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1Gi&quot;</span>
<span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">        </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2Gi&quot;</span>
<span class="w">        </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cpu:</span> <span class="pre">1</span></code> equals 1 AWS vCPU, 1 GCP Core, 1 Azure Core, 1 Hyperthread</p></li>
</ul>
</div></blockquote>
</section>
<section id="service-accounts">
<h3>Service Accounts<a class="headerlink" href="#service-accounts" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>used by applications to interact with K8s cluster</p></li>
<li><p>e.g used by Jenkins to deploy on the cluster</p></li>
<li><dl>
<dt><strong>token</strong></dt><dd><ul class="simple">
<li><p>auto created when a service account is created</p></li>
<li><p>must be used by external applications to authenticate</p></li>
<li><p>stored as secret object which is linked to the service account</p></li>
<li><p>token can be mounted as volume to the pod if the third-party application is also</p></li>
</ul>
<p>hosted on K8s cluster</p>
</dd>
</dl>
</li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>create<span class="w"> </span>serviceaccount<span class="w"> </span>my-svc-account
kubectl<span class="w"> </span>get<span class="w"> </span>serviceaccounts
kubectl<span class="w"> </span>describe<span class="w"> </span>sa<span class="w"> </span>my-svc-account
kubectl<span class="w"> </span>describe<span class="w"> </span>secret<span class="w"> </span>my-svc-account-token
kubectl<span class="w"> </span>get<span class="w"> </span>roles
kubectl<span class="w"> </span>get<span class="w"> </span>rolesbinding
</pre></div>
</div>
<ul class="simple">
<li><p>each namespace has its own default service account</p></li>
<li><p>when a pod is created, the default service account and the token are auto mounted</p></li>
<li><p>default service account can only run basic K8s API queries</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-svc-account</span>
<span class="w">  </span><span class="c1"># OR</span>
<span class="w">  </span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="taints-tolerations">
<h3>Taints &amp; Tolerations<a class="headerlink" href="#taints-tolerations" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>to set restrictions on what pods can be scheduled on a node</p></li>
<li><p>pods do not have toleration by default</p></li>
<li><p>must specify which pods are tolerant to a taint</p></li>
<li><p>taints are set on nodes, tolerations are set on pods</p></li>
<li><dl>
<dt>taint effects</dt><dd><ul class="simple">
<li><p>NoSchedule, PreferNoSchedule</p></li>
<li><p>NoExecute: new pods will not be scheduled, existing pods on the node will be evicted</p></li>
</ul>
<p>if they do not tolerate</p>
</dd>
</dl>
</li>
<li><p>taints and tolerations do not tell the pod to go to a particular node</p></li>
<li><p>a taint is set on control-plane node automatically to not accept any pods</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># add taint</span>
kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>node-name<span class="w"> </span><span class="nv">key</span><span class="o">=</span>value:taint-effect
kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>node1<span class="w"> </span><span class="nv">app</span><span class="o">=</span>nginx:NoSchedule

<span class="c1"># remove taint</span>
kubectl<span class="w"> </span>taint<span class="w"> </span>nodes<span class="w"> </span>node1<span class="w"> </span><span class="nv">app</span><span class="o">=</span>nginx:NoSchedule-
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">tolerations</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;app&quot;</span>
<span class="w">    </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Equal&quot;</span>
<span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nginx&quot;</span>
<span class="w">    </span><span class="nt">effect</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;NoSchedule&quot;</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="node-selectors">
<h3>Node Selectors<a class="headerlink" href="#node-selectors" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>limitation on a pod to only run on particular node</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">nodeSelector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">size</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Large</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">size:</span> <span class="pre">Large</span></code> is key/value pair assigned to a node, so the scheduler can match the label</p></li>
</ul>
<p>to match the pod on the right node
* nodes must be labelled before a pod is created</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># label a node</span>
kubectl<span class="w"> </span>label<span class="w"> </span>nodes<span class="w"> </span>node01<span class="w"> </span><span class="nv">size</span><span class="o">=</span>large
</pre></div>
</div>
<ul class="simple">
<li><p>can only use exact label to achieve the requirement</p></li>
</ul>
</div></blockquote>
</section>
<section id="node-affinity">
<h3>Node Affinity<a class="headerlink" href="#node-affinity" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>ensure pods run on particular nodes using advanced expressions</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">affinity</span><span class="p">:</span>
<span class="w">    </span><span class="nt">nodeAffinity</span><span class="p">:</span>
<span class="w">      </span><span class="nt">requiredDuringSchedulingIgnoredDuringExecution</span><span class="p">:</span>
<span class="w">        </span><span class="nt">nodeSelectorTerms</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">matchExpressions</span><span class="p">:</span>
<span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">size</span>
<span class="w">            </span><span class="nt">operator</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">In</span>
<span class="w">            </span><span class="nt">values</span><span class="p">:</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Large</span>
<span class="w">            </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Medium</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">operator:</span> <span class="pre">In</span></code> makes sure that the pod will be placed on a node whose label <code class="docutils literal notranslate"><span class="pre">size</span></code> has</p></li>
</ul>
<p>any value specified in <cite>values:</cite>
* <code class="docutils literal notranslate"><span class="pre">operator:</span> <span class="pre">NotIn</span></code> set the pod on the node whose label <code class="docutils literal notranslate"><span class="pre">size</span></code> is not <code class="docutils literal notranslate"><span class="pre">Large</span></code> or <code class="docutils literal notranslate"><span class="pre">Medium</span></code>
* <code class="docutils literal notranslate"><span class="pre">operator:</span> <span class="pre">Exists</span></code> set the pod on the node if label <code class="docutils literal notranslate"><span class="pre">size</span></code> exists, does not compare values
* node affinity types</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">requiredDuringSchedulingIgnoredDuringExecution</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">preferredDuringSchedulingIgnoredDuringExecution</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">requiredDuringSchedulingRequiredDuringExecution</span></code></p></li>
</ul>
</div></blockquote>
<ul>
<li><dl>
<dt><strong>DuringScheduling</strong></dt><dd><ul class="simple">
<li><p>state where a pod does not exist and created for the first time</p></li>
<li><p>“Required”: scheduler mandates that the pod be placed on a node with the given</p></li>
</ul>
<p>affinity rules, pod will not be scheduled if cannot match the label, used when the
placement of the pod is important
- “Preferred”: if no matching node is found, scheduler ignores the affinity rules and
place the pod on any available node</p>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>DuringExecution</strong></dt><dd><ul class="simple">
<li><p>state where a pod is running and a change is made that affect the node affinity</p></li>
<li><p>“Ignored”: pod will still run and node affinity changes will not affect once they</p></li>
</ul>
<p>are scheduled
- “Required”: running pods will be evicted if they do not match</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>using Taints/Tolerations and Node Affinity together give more control over nodes and pods</p></li>
</ul>
</section>
<section id="custom-resource-definition">
<h3>Custom Resource Definition<a class="headerlink" href="#custom-resource-definition" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>built-in resources have built-in controllers to handle them</p></li>
<li><p>CRD tells K8s objects of custom kind to be created</p></li>
<li><p>CRD only will store custom objects to be stored in etcd, needs a controller</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># custom-object.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">custom.com/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomObject</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-custom-object</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">  </span><span class="nt">attr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hello</span>

<span class="c1"># custom-definition.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apiextensions.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomResourceDefinition</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">test.custom.com</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">scope</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Namespaced</span>
<span class="w">  </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">custom.com</span>
<span class="w">  </span><span class="nt">names</span><span class="p">:</span>
<span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">CustomObject</span>
<span class="w">    </span><span class="nt">singular</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">customobject</span><span class="w"> </span><span class="c1"># to be output of kubectl</span>
<span class="w">    </span><span class="nt">plural</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">customobjects</span><span class="w"> </span><span class="c1"># use by API resource</span>
<span class="w">    </span><span class="nt">shortNames</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cobj</span>
<span class="w">  </span><span class="nt">versions</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="w">    </span><span class="nt">served</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">schema</span><span class="p">:</span><span class="w"> </span><span class="c1"># parameters under spec in object definition file</span>
<span class="w">    </span><span class="nt">openAPIV3Schema</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">      </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">        </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">          </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
<span class="w">          </span><span class="nt">properties</span><span class="p">:</span>
<span class="w">            </span><span class="nt">value</span><span class="p">:</span>
<span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">integer</span>
<span class="w">              </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2</span>
<span class="w">              </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">            </span><span class="nt">attr</span><span class="p">:</span>
<span class="w">              </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</pre></div>
</div>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># create CRD first</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>custom-definition.yml

<span class="c1"># can now create custom object</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>custom-object.yml
</pre></div>
</div>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="observability">
<h2>Observability<a class="headerlink" href="#observability" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#health-checks">Health Checks</a>, <a class="reference internal" href="#readiness-probes">Readiness Probes</a>, <a class="reference internal" href="#liveness-probes">Liveness Probes</a>, <a class="reference internal" href="#startup-probes">Startup Probes</a>, <a class="reference internal" href="#exec-probes">Exec Probes</a></p></li>
<li><p><a class="reference internal" href="#logging">Logging</a>, <a class="reference internal" href="#monitoring">Monitoring</a></p></li>
<li><p><a class="reference internal" href="#application-failure">Application Failure</a>, <a class="reference internal" href="#controlplane-failure">Controlplane Failure</a>, <a class="reference internal" href="#node-failure">Node Failure</a>, <a class="reference internal" href="#network-failure">Network Failure</a></p></li>
<li><p><a class="reference internal" href="#auditing">Auditing</a>, <a class="reference internal" href="#k8s-dashboard">K8s Dashboard</a>, <a class="reference internal" href="#json-path">JSON Path</a></p></li>
</ul>
<section id="health-checks">
<h3>Health Checks<a class="headerlink" href="#health-checks" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>health checks ensure that the main process of application is always running and will be</p></li>
</ul>
<p>restarted if it isn’t
* by default, K8s assumes the container is ready to serve user traffic as soon as it is
created and so sets the condition of container’s Ready status to true
* sometimes the application might take time to load and the service is unaware of that the
application is not ready
* liveness health checks are application-specific and have to define in pod manifest
* K8s also supports <code class="docutils literal notranslate"><span class="pre">tcpSocket</span></code> health checks which are useful for non-HTTP applications
such as databases</p>
</div></blockquote>
</section>
<section id="readiness-probes">
<h3>Readiness Probes<a class="headerlink" href="#readiness-probes" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to tie the Ready condition to the actual state of the application</p></li>
<li><p>e.g run http test to check if the API server responds, test to check if a TCP socket is</p></li>
</ul>
<p>listening in a database, execute a command in the container that exits if application is
running successfully
* when <code class="docutils literal notranslate"><span class="pre">readinessProbe</span></code> is configured, K8s does not immediately set the Ready condition to
true when the container is created
* instead it tests the API to check if it responds correctly
* if the readiness checks fail, the container is removed from service load balancers
* <code class="docutils literal notranslate"><span class="pre">periodSeconds</span></code>: how often to probe
* the probe will stop if the application is not ready after 3 attempts
* <code class="docutils literal notranslate"><span class="pre">failureThreshold</span></code>: to make more attempts</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webapp</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">webapp</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">    </span><span class="nt">readinessProbe</span><span class="p">:</span>
<span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/api/ready</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">      </span><span class="c1"># OR</span>
<span class="w">      </span><span class="nt">tcpSocket</span><span class="p">:</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3306</span>
<span class="w">      </span><span class="c1"># OR</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;hello&quot;</span>
<span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">      </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="liveness-probes">
<h3>Liveness Probes<a class="headerlink" href="#liveness-probes" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to test if the application in the container is healthy</p></li>
<li><p>defined per container, each container inside a pod is health checked separately</p></li>
<li><p>HTTP status code must be equal to or greater than 200 and less than 400 to be cosidered</p></li>
</ul>
<p>successful</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">livenessProbe</span><span class="p">:</span>
<span class="w">      </span><span class="nt">httpGet</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/api/ready</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8080</span>
<span class="w">      </span><span class="c1"># OR</span>
<span class="w">      </span><span class="nt">tcpSocket</span><span class="p">:</span>
<span class="w">        </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3306</span>
<span class="w">      </span><span class="c1"># OR</span>
<span class="w">      </span><span class="nt">exec</span><span class="p">:</span>
<span class="w">        </span><span class="nt">command</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">echo</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;hello&quot;</span>
<span class="w">      </span><span class="nt">initialDelaySeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">      </span><span class="nt">periodSeconds</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">      </span><span class="nt">failureThreshold</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8</span>
</pre></div>
</div>
</div></blockquote>
<ul class="simple">
<li><p>combining readiness and liveness probes helps ensure only healthy containers are in cluster</p></li>
</ul>
</section>
<section id="startup-probes">
<h3>Startup Probes<a class="headerlink" href="#startup-probes" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>run before any other probes when a pod is started</p></li>
<li><p>proceeds until it either times out or succeeds,after which the liveness probe takes over</p></li>
</ul>
</div></blockquote>
</section>
<section id="exec-probes">
<h3>Exec Probes<a class="headerlink" href="#exec-probes" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>execute a script or program in the context of the container</p></li>
<li><p>if the script returns a zero exit code, the probe succeeds</p></li>
<li><p>useful for custom application validation logic that doesn’t fit an HTTP call</p></li>
</ul>
</div></blockquote>
</section>
<section id="logging">
<h3>Logging<a class="headerlink" href="#logging" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>must specify container name explicitly in a multi-container pod</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>myapp-pod

<span class="c1"># log specific container running in a pod</span>
kubectl<span class="w"> </span>logs<span class="w"> </span>-f<span class="w"> </span>myapp-pod<span class="w"> </span>-c<span class="w"> </span>container1
</pre></div>
</div>
</div></blockquote>
</section>
<section id="monitoring">
<h3>Monitoring<a class="headerlink" href="#monitoring" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>K8s doesn’t have built-in full feature monitoring solution</p></li>
<li><p>third-party tools such as Metrics Server, Prometheus, Elastic Stack, Datadog, Dynatrace</p></li>
<li><dl class="simple">
<dt>cAdvisor</dt><dd><ul class="simple">
<li><p>sub component of kubelet</p></li>
<li><p>retrieves performance metrics from pods and expose them through kubelet api</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>Metrics Server</strong></dt><dd><ul class="simple">
<li><p>slimmed-down version of Heapster, in-memory monitoring</p></li>
<li><p>retrieves metrics from each node and pod, aggregates and stores them</p></li>
<li><p>get metrics from cAdvisor</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># for minikube</span>
minikube<span class="w"> </span>addons<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>metrics-server

<span class="c1"># others</span>
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

<span class="c1"># check metrics</span>
kubectl<span class="w"> </span>top<span class="w"> </span>nodes
kubectl<span class="w"> </span>top<span class="w"> </span>pods
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="application-failure">
<h3>Application Failure<a class="headerlink" href="#application-failure" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl class="simple">
<dt>check accessibility</dt><dd><ul class="simple">
<li><p>draw a map or chart of the application depending on information of failure</p></li>
<li><p>check every object in the map until the root cause of issue is found</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check front-end</dt><dd><ul class="simple">
<li><p>use standard testings if accessible</p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://web-service-ip:node-port</span></code> if web application</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>check services</dt><dd><ul class="simple">
<li><p>check the service, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">describe</span> <span class="pre">service</span> <span class="pre">web-service</span></code>, to see if endpoints are</p></li>
</ul>
<p>reached
- compare the selectors and labels on pod and service</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check pod</dt><dd><ul class="simple">
<li><p>make sure the pod is in a running state, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pod</span></code></p></li>
<li><p>check if there are any restarts</p></li>
<li><p>check the events, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">describe</span> <span class="pre">pod</span> <span class="pre">web</span></code></p></li>
<li><p>check the logs, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span> <span class="pre">web</span> <span class="pre">-f</span></code> or <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span> <span class="pre">web</span> <span class="pre">-f</span> <span class="pre">--previous</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>check dependent service</p></li>
<li><p>check dependent applications</p></li>
</ul>
</div></blockquote>
</section>
<section id="controlplane-failure">
<h3>Controlplane Failure<a class="headerlink" href="#controlplane-failure" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>check node status</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check control-plane components, if deployed as pods</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pods</span> <span class="pre">-n</span> <span class="pre">kube-system</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check control-plane components, if setup with kubeadm</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">service</span> <span class="pre">kube-apiserver</span> <span class="pre">status</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">service</span> <span class="pre">kube-controller-manager</span> <span class="pre">status</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">service</span> <span class="pre">kube-scheduler</span> <span class="pre">status</span></code></p></li>
<li><p>on worker node, <code class="docutils literal notranslate"><span class="pre">service</span> <span class="pre">kubelet</span> <span class="pre">status</span></code></p></li>
<li><p>on worker node, <code class="docutils literal notranslate"><span class="pre">service</span> <span class="pre">kube-proxy</span> <span class="pre">status</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check service logs</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">logs</span> <span class="pre">kube-apiserver-controlplane</span> <span class="pre">-n</span> <span class="pre">kube-system</span></code></p></li>
<li><p>or <code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">kube-apiserver</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>[Debug service issues](<a class="reference external" href="https://kubernetes.io/docs/tasks/debug/debug-application/debug-service/">https://kubernetes.io/docs/tasks/debug/debug-application/debug-service/</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="node-failure">
<h3>Node Failure<a class="headerlink" href="#node-failure" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>check node status</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">describe</span> <span class="pre">node</span> <span class="pre">node01</span></code></p></li>
<li><p>make sure Type <code class="docutils literal notranslate"><span class="pre">Ready</span></code> is set to <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check for possible memory, cpu and disk space on the node</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">top</span></code>, <code class="docutils literal notranslate"><span class="pre">df</span> <span class="pre">-h</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check kubelet status</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">service</span> <span class="pre">kubelet</span> <span class="pre">status</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-u</span> <span class="pre">kubelet</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check certificates</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">openssl</span> <span class="pre">x509</span> <span class="pre">-in</span> <span class="pre">/var/lib/kubelet/node01.crt</span> <span class="pre">-text</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="network-failure">
<h3>Network Failure<a class="headerlink" href="#network-failure" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>CoreDNS memory usage is affected by the number of pods and services in the cluster</p></li>
<li><p>other factors such as size of the filled DNS answer cache, rate of queries received (QPS)</p></li>
</ul>
<p>per CoreDNS instance
* K8s resources for coreDNS</p>
<blockquote>
<div><ul class="simple">
<li><p>service account named <code class="docutils literal notranslate"><span class="pre">coredns</span></code></p></li>
<li><p>clusterroles named <code class="docutils literal notranslate"><span class="pre">coredns</span></code> and <code class="docutils literal notranslate"><span class="pre">kube-dns</span></code></p></li>
<li><p>clusterrolebindings named <code class="docutils literal notranslate"><span class="pre">coredns</span></code> and <code class="docutils literal notranslate"><span class="pre">kube-dns</span></code></p></li>
<li><p>deployment named <code class="docutils literal notranslate"><span class="pre">coredns</span></code></p></li>
<li><p>config map named <code class="docutils literal notranslate"><span class="pre">coredns</span></code></p></li>
<li><p>service named <code class="docutils literal notranslate"><span class="pre">kube-dns</span></code></p></li>
</ul>
</div></blockquote>
<ul>
<li><p>port 53 is used for DNS resolution</p></li>
<li><p>if coredns pods are in pending state, check network plugin is installed or not</p></li>
<li><dl>
<dt>if coredns pods have <code class="docutils literal notranslate"><span class="pre">CrashLoopBackOff</span></code> or <code class="docutils literal notranslate"><span class="pre">Error</span> <span class="pre">state</span></code></dt><dd><ul class="simple">
<li><p>check or add <code class="docutils literal notranslate"><span class="pre">resolvConf</span></code> in kubelet config yaml</p></li>
<li><p>disable local DNS cache on host nodes and restore <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code></p></li>
<li><p>edit the <code class="docutils literal notranslate"><span class="pre">Corefile</span></code>, replacing forward <code class="docutils literal notranslate"><span class="pre">./etc/resolv.conf</span></code> with the IP address of</p></li>
</ul>
<p>upstream DNS</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>check kube-dns service endpoints</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">-n</span> <span class="pre">kube-system</span> <span class="pre">get</span> <span class="pre">ep</span> <span class="pre">kube-dns</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>check kube-proxy pod in kube-system namespace</p></li>
<li><p>check kube-proxy logs</p></li>
<li><p>check configmap is correctly defined and config file for running kube-proxy binary is</p></li>
</ul>
<p>correct
* check kube-config is defined in the config map
* check kube-proxy inside the container</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">netstat</span> <span class="pre">-plan</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">kube-proxy</span></code></p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>[Debugging DNS Resolution](<a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/">https://kubernetes.io/docs/tasks/administer-cluster/dns-debugging-resolution/</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="auditing">
<h3>Auditing<a class="headerlink" href="#auditing" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>K8s provides auditing events handled by kube-apiserver</p></li>
<li><p>stages: <code class="docutils literal notranslate"><span class="pre">RequestReceived</span></code>, <code class="docutils literal notranslate"><span class="pre">ResponseStarted</span></code>, <code class="docutils literal notranslate"><span class="pre">ResponseComplete</span></code>, <code class="docutils literal notranslate"><span class="pre">Panic</span></code></p></li>
<li><p>each stage generates events that can be recorded by kube-apiserver, but not by default</p></li>
<li><p>make sure to record only specific events by making use of policy objects</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">level</span></code>: logs verbose level, <code class="docutils literal notranslate"><span class="pre">None</span></code>, <code class="docutils literal notranslate"><span class="pre">Metadata</span></code>, <code class="docutils literal notranslate"><span class="pre">Request</span></code>, <code class="docutils literal notranslate"><span class="pre">RequestResponse</span></code></p></li>
<li><dl class="simple">
<dt>need to enable backends</dt><dd><ul>
<li><p>log backend: store audit events to a file on control-plane node</p></li>
<li><p>webhook backend: writes to a remote webhook such as Falco</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>in <code class="docutils literal notranslate"><span class="pre">/etc/kubernetes/manifests/kube-apiserver.yaml</span></code>, <code class="docutils literal notranslate"><span class="pre">--audit-log-path</span></code> and</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">--audit-policy-file</span></code>
* <code class="docutils literal notranslate"><span class="pre">--audit-log-maxage</span></code>, maximum days to keep audit records
* <code class="docutils literal notranslate"><span class="pre">--audit-log-maxbackup</span></code>, <code class="docutils literal notranslate"><span class="pre">--audit-log-maxsize=100</span></code> in megabytes</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># audit-policy.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">audit.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Policy</span>
<span class="nt">omitStages</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;RequestReceived&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">namespaces</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;namespace1&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># not mandatory, all by default</span>
<span class="w">  </span><span class="nt">verbs</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;delete&quot;</span><span class="p p-Indicator">]</span><span class="w"> </span><span class="c1"># not mandatory, every action by default</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="c1"># default to core group</span>
<span class="w">    </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;pods&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">resourceName</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;webapp-pod&quot;</span><span class="p p-Indicator">]</span>
<span class="w">  </span><span class="nt">level</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RequestResponse</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="k8s-dashboard">
<h3>K8s Dashboard<a class="headerlink" href="#k8s-dashboard" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>one of K8s sub-project</p></li>
<li><p>graphical representation of the cluster, monitor activities and provision new resources</p></li>
<li><p>not deployed by default</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">apply</span> <span class="pre">-f</span> <span class="pre">https://raw.githubusercontent.com/kubernetes/dashboard/v2.7.0/aio/deploy/recommended.yaml</span></code></p></li>
<li><p>when deployed, a namespace, deployment and service called <code class="docutils literal notranslate"><span class="pre">kubernetes-dashboard</span></code> are</p></li>
</ul>
<dl class="simple">
<dt>created, and a configmap is also created</dt><dd><ul class="simple">
<li><p>do not use <code class="docutils literal notranslate"><span class="pre">--disable-filter</span></code> as it can be vulnerable to XSRF attacks</p></li>
</ul>
</dd>
</dl>
<ul class="simple">
<li><p>service is set to <code class="docutils literal notranslate"><span class="pre">ClusterIP</span></code>, only accessible within the cluster</p></li>
<li><dl class="simple">
<dt>using <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">proxy</span></code> to access from outside the cluster</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">https://localhost:8001/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy</span></code></p></li>
<li><p>cannot make the dashboard accessible across the team</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>can expose as a NodePort, exposing as LoadBalancer is not recommended</p></li>
<li><p>use auth proxy like OAuth</p></li>
<li><dl class="simple">
<dt>using token to login</dt><dd><ul>
<li><p>must create a user and gives necessary permissions using roles and role bindings</p></li>
<li><p>retrieve token, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">describe</span> <span class="pre">secrete</span> <span class="pre">kubernetes-dashboard-token</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>can also use kubeconfig file to login</p></li>
<li><p>[K8s Dashboard](<a class="github reference external" href="https://github.com/kubernetes/dashboard">kubernetes/dashboard</a>), [Dashboard Documentation](<a class="reference external" href="https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/">https://kubernetes.io/docs/tasks/access-application-cluster/web-ui-dashboard/</a>)</p></li>
<li><p>Dashboard Security: [YouTube](<a class="reference external" href="https://www.youtube.com/watch?v=od8TnIvuADg">https://www.youtube.com/watch?v=od8TnIvuADg</a>), [blog post](<a class="reference external" href="https://blog.heptio.com/on-securing-the-kubernetes-dashboard-16b09b1b7aca">https://blog.heptio.com/on-securing-the-kubernetes-dashboard-16b09b1b7aca</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="json-path">
<h3>JSON Path<a class="headerlink" href="#json-path" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>makes filtering data across large data sets using complex queries easier</p></li>
<li><p>kube-apiserver responds in JSON format and kubectl convert it to human readable format</p></li>
<li><p>during the conversion, a lot of information is hidden to make readable</p></li>
<li><p>hierarchy same as in definition files</p></li>
<li><dl>
<dt>using JSON Path</dt><dd><ul class="simple">
<li><p>identify kubectl commands</p></li>
<li><p>familiarize with JSON output, <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pods</span> <span class="pre">-o</span> <span class="pre">json</span></code></p></li>
<li><p>form JSON Path query, <code class="docutils literal notranslate"><span class="pre">.items[0].spec.containers[0].image</span></code> (kubectl auto add ‘$’)</p></li>
<li><p>use the JSON Path query with kubectl command</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pods</span> <span class="pre">-o=jsonpath='{</span> <span class="pre">.items[0].spec.containers[0].image</span> <span class="pre">}'</span></code></p>
</dd>
</dl>
</li>
<li><dl>
<dt>examples</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pods</span> <span class="pre">nginx</span> <span class="pre">-o=jsonpath={.status.podIP}</span></code> or</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pods</span> <span class="pre">nginx</span> <span class="pre">-o</span> <span class="pre">jsonpath</span> <span class="pre">--template={.status.podIP}</span></code> or
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">pods</span> <span class="pre">nginx</span> <span class="pre">-o</span> <span class="pre">jsonpath={.status.podIP}</span></code>, get IP of a pod
- <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">-o=jsonpath='{.items[*].metadata.name}'</span></code>, returns the names of
the nodes in the cluster
- <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">-o=jsonpath='{.items[*].status.nodeInfo.architecture}'</span></code>, returns
hardware architecture of the nodes
- <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">-o=jsonpath='{.items[*].status.capacity.cpu}'</span></code>, returns cpu
counts on the nodes
- can combine queries,
<code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">-o=jsonpath='{.items[*].metadata.name}{.items[*].status.capacity.cpu}'</span></code>,
returns the names of the nodes and cpu counts
- can add <code class="docutils literal notranslate"><span class="pre">{&quot;\n&quot;}</span></code>, <code class="docutils literal notranslate"><span class="pre">{&quot;\t&quot;}</span></code> between queries for better output</p>
</dd>
</dl>
</li>
<li><dl>
<dt>using loop, <code class="docutils literal notranslate"><span class="pre">range</span></code></dt><dd><ul class="simple">
<li><p>for each item in the node, print the node name, insert a tab, print cpu count, print</p></li>
</ul>
<p>new line character
- <code class="docutils literal notranslate"><span class="pre">'{range</span> <span class="pre">.items[*]}</span> <span class="pre">{.metadata.name}{&quot;\t&quot;}{.status.capacity.cpu}{&quot;\n&quot;}</span> <span class="pre">{end}'</span></code></p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>can print custom columns</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">-o=custom-columns=&lt;COLUMN</span> <span class="pre">NAME&gt;:&lt;JSON</span> <span class="pre">PATH&gt;</span></code></p></li>
<li><p>can sometimes be easier approach compare to loop method</p></li>
<li><p>must exclude <code class="docutils literal notranslate"><span class="pre">.items</span></code> as the custom-columns assume the query is for each item</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">-o=custom-columns=NODE:.metadata.name,CPU:.status.capacity.cpu</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>can sort the output</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span> <span class="pre">--sort-by=.metadata.name</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="cluster-maintenance">
<h2>Cluster Maintenance<a class="headerlink" href="#cluster-maintenance" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#draining-the-node">Draining the node</a>, <a class="reference internal" href="#k8s-versions">K8s Versions</a>, <a class="reference internal" href="#k8s-api">K8s API</a>, <a class="reference internal" href="#backup">Backup</a></p></li>
<li><p>if a node is down, K8s gives a node 5 min to comeback up</p></li>
<li><p>if the node comeback up, kubectl process starts and the pods become online</p></li>
<li><p>but if a node is down for more than 5 min, the pods are terminated from that node</p></li>
<li><p>if the pods are part of the replicaset, they are recreated on other nodes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pod-eviction-timeout</span></code>, time it waits for a pod to comeback online</p></li>
<li><p>if the node comeback online after pod-eviction-timeout, it has no pods on it</p></li>
<li><p>can make a quick upgrade if it is sure that the node down time will be less than 5 min</p></li>
</ul>
<section id="draining-the-node">
<h3>Draining the node<a class="headerlink" href="#draining-the-node" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>a safer way, so that the workloads are terminated and recreated on</p></li>
</ul>
<p>other nodes
* when the node is drain, it is cordon or marked as unschedulable until the restriction is removed
specifically
* when uncordon, the pods from other nodes do not auto move back, only newly created
or recreated pods will be on it
* when a node is cordon, the pods on it do not auto move to other nodes, only make
sure that the new pods are not scheduled on the node
* cannot drain if pods are not managed by ReplicationController, ReplicaSet, Job,
DaemonSet or StatefulSet, as pods will have to be recreated by a controller</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>drain<span class="w"> </span>node-1
<span class="c1"># OR</span>
kubectl<span class="w"> </span>drain<span class="w"> </span>node-1<span class="w"> </span>--ignore-daemonsets
kubectl<span class="w"> </span>uncordon<span class="w"> </span>node-1

<span class="c1"># pods do not move</span>
kubectl<span class="w"> </span>cordon<span class="w"> </span>node-2
</pre></div>
</div>
</div></blockquote>
</section>
<section id="k8s-versions">
<h3>K8s Versions<a class="headerlink" href="#k8s-versions" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>major.minor.patch, e.g v1.24.4</p></li>
<li><p>minor: every few months with new features</p></li>
<li><p>patch: more often with bug fixes</p></li>
<li><p>all bug fixes and improvements first go in alpha release</p></li>
<li><p>new features are well tested on beta versions</p></li>
<li><p>different components have their own versions</p></li>
<li><p>no other component can have higher version than kube-apiserver as it is the primary</p></li>
</ul>
<p>component others talk to
* kube-controller-manager and kube-scheduler can be at one version lower than the API server
* kubelet and kube-proxy can be at two versions lower than the API server
* but kubectl can be higher, same or lower than the API server
* can upgrade each component if required
* K8s support only up to the recent three minor versions
* upgrade one minor version at a time
* upgrade process depends on how the cluster is setup
* easy to upgrade on cloud and if using kubeadm
* have to manually upgrade different components if setup from scratch
* first upgrade the controlplane node, then the worker nodes
* components in the controlplane go down while upgrading</p>
<blockquote>
<div><ul class="simple">
<li><p>does not impact applications on worker nodes</p></li>
<li><p>cannot use <code class="docutils literal notranslate"><span class="pre">kubectl</span></code> command as all management tools also go down</p></li>
<li><p>but if a pod fails, new pods will not be auto created</p></li>
</ul>
</div></blockquote>
<ul>
<li><dl>
<dt>after the controlplane is upgraded, upgrade the worker nodes</dt><dd><ol class="arabic simple">
<li><p>upgrade all worker nodes at the same time</p></li>
<li><p>upgrade one node at a time</p></li>
</ol>
<p>#. add new nodes with newer version to the cluster and remove the old ones, strategy
easy to use if on cloud</p>
</dd>
</dl>
</li>
<li><dl>
<dt><strong>upgrading with kubeadm</strong></dt><dd><ul class="simple">
<li><p>does not install or upgrade kubelet on the nodes</p></li>
<li><p>upgrade the kubeadm tool first</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">VERSION</span></code> output from <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">nodes</span></code> is the version kubelet is registered to</p></li>
</ul>
<p>the API server, not the version of the API server
- upgrade kubelet on controlplane, if exists
- move the workloads on worker node to another with <code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">drain</span> <span class="pre">node-1</span></code>, and
upgrade the necessary components
- do the same on other nodes, one after another</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># on controlplane node</span>
kubectl<span class="w"> </span>drain<span class="w"> </span>controlplane<span class="w"> </span>--ignore-daemonsets
kubeadm<span class="w"> </span>upgrade<span class="w"> </span>plan
apt-get<span class="w"> </span>update
apt-get<span class="w"> </span>upgrade<span class="w"> </span>-y<span class="w"> </span>--allow-change-held-packages<span class="w"> </span><span class="nv">kubeadm</span><span class="o">=</span><span class="m">1</span>.24.5-00
kubeadm<span class="w"> </span>upgrade<span class="w"> </span>plan
kubeadm<span class="w"> </span>upgrade<span class="w"> </span>apply<span class="w"> </span>v1.24.5
apt-get<span class="w"> </span>upgrade<span class="w"> </span>-y<span class="w"> </span>--allow-change-held-packages<span class="w"> </span><span class="nv">kubelet</span><span class="o">=</span><span class="m">1</span>.24.5-00<span class="w"> </span><span class="nv">kubectl</span><span class="o">=</span><span class="m">1</span>.24.5-00
systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet
kubectl<span class="w"> </span>uncordon<span class="w"> </span>controlplane

<span class="c1"># must drain from control-plane node, do the same on other nodes one by one</span>
kubectl<span class="w"> </span>drain<span class="w"> </span>node-1<span class="w"> </span>--ignore-daemonsets

apt-get<span class="w"> </span>update
apt-get<span class="w"> </span>upgrade<span class="w"> </span>-y<span class="w"> </span>--allow-change-held-packages<span class="w"> </span><span class="nv">kubeadm</span><span class="o">=</span><span class="m">1</span>.24.5-00
kubeadm<span class="w"> </span>upgrade<span class="w"> </span>node
apt-get<span class="w"> </span>upgrade<span class="w"> </span>-y<span class="w"> </span>--allow-change-held-packages<span class="w"> </span><span class="nv">kubelet</span><span class="o">=</span><span class="m">1</span>.24.5-00<span class="w"> </span><span class="nv">kubectl</span><span class="o">=</span><span class="m">1</span>.24.5-00
systemctl<span class="w"> </span>restart<span class="w"> </span>kubelet

<span class="c1"># from controlplane node</span>
kubectl<span class="w"> </span>uncordon<span class="w"> </span>node-1
</pre></div>
</div>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="k8s-api">
<h3>K8s API<a class="headerlink" href="#k8s-api" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>the only component that interact directly with etcd</p></li>
<li><p>has multiple groups for different purposes</p></li>
<li><p>/metrics, /healthz, /version, /api, /apis, /logs</p></li>
<li><dl>
<dt><strong>/api</strong></dt><dd><ul class="simple">
<li><p>core group, /v1</p></li>
<li><p>such as namespaces, pods, rc, events, endpoints, nodes, bindings, PV, PVC,</p></li>
</ul>
<p>configmaps, secrets, services</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>/apis</strong></dt><dd><ul class="simple">
<li><p>named group, more organized</p></li>
<li><p>new features will be placed in named group</p></li>
<li><p>/apps/v1/deployments (/replicasets, /statefulsets)</p></li>
<li><p>/networking.k8s.io/v1/networkpolicies</p></li>
<li><p>/certificates.k8s.io/v1/certificatesigningrequests</p></li>
<li><p>/extensions, /storage.k8s.io, /authentication.k8s.io</p></li>
<li><p>top level are API groups</p></li>
<li><p>each group has resources (/deployments, /replicasets)</p></li>
<li><p>each resource has actions or verbs (list, get, create)</p></li>
</ul>
</dd>
</dl>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://localhost:6443</span></code> to view groups and resources, which needs credentials</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">proxy</span></code> will start a kubectl proxy, which doesn’t need credentials</p></li>
<li><p>kubectl proxy is not same as kube proxy, which is used to proxy pods</p></li>
<li><p>can enable API groups by editing <code class="docutils literal notranslate"><span class="pre">--runtime-config</span></code></p></li>
<li><dl>
<dt>versions</dt><dd><ul class="simple">
<li><p>major.minor.patch</p></li>
<li><p>v1alpha1: not enabled by default, have bugs, lack e2e tests, may be dropped later,</p></li>
</ul>
<p>for expert users
- v1beta1: minor bugs, has e2e tests, for beta testers
- v1: GA/Stable, conformance tests, highly reliable, for all users
- objects with different versions can run at the same time
- only one can be <code class="docutils literal notranslate"><span class="pre">preferredVersion</span></code>, to which API commands will be run on (can
check by viewing groups and resources with API URL)
- only one can be <code class="docutils literal notranslate"><span class="pre">storageVersion</span></code>, to be stored in etcd (can only check by
querying etcd database)</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>API Deprecation Policies</strong></dt><dd><p>#. API elements may only be removed by incrementing the version of the API group
- e.g element in v1alpha1 can only be removed in v1alpha2, still present in v1alpha1
#. API objects must be able to round-trip between API versions in a given release
without information loss, with the exception of whole REST resources that do not exist
in some versions
- e.g objects converted from v1alpha1 to v1alpha2, then back to v1alpha1, should be
the same as v1alpha1 version
#. API version in a given track may not be deprecated until a new API version at
least as stable is released
4a. Other than the most recent API versions in each track, older API versions must
be supported after their announced deprecation for a duration of no less than:
GA: 12 months or 3 releases, Beta: 9 months or 3 releases, Alpha: 0 releases
4b. The “preferred” API version and the “storage version” for a given group may not
advance until after a release has been made that supports both the new version and the
previous version</p>
</dd>
</dl>
</li>
<li><p>converting API versions with Kubectl Convert (a plugin)</p>
<blockquote>
<div><div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># apiVersion: apps/v1beta1 in old.yml</span>
kubectl<span class="w"> </span>convert<span class="w"> </span>-f<span class="w"> </span>old.yml<span class="w"> </span>--output-version<span class="w"> </span>apps/v1

<span class="c1"># check resource API group</span>
kubectl<span class="w"> </span>explain<span class="w"> </span>pod

<span class="c1"># create pod object without assigning to a node</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>https://k8s_IP/api/v1/namespaces/default/pods
</pre></div>
</div>
</div></blockquote>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">--etcd-servers</span></code>, specify location of etcd server</p></li>
<li><p>kubeadm deploy kube-apiserver as pod in kube-system namespace, definition file in</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">etc/kubernetes/manifests/kube-apiserver.yml</span></code>
* can be searched as a process <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">-aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">kube-apiserver</span></code> on the controlplane node
* in non kubeadm setup, <code class="docutils literal notranslate"><span class="pre">/etc/systemd/system/kube-apiserver.service</span></code></p>
</div></blockquote>
</section>
<section id="backup">
<h3>Backup<a class="headerlink" href="#backup" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>use source code repository to store resource definitions</p></li>
<li><dl class="simple">
<dt>query kube-apiserver to save resource configurations</dt><dd><ul class="simple">
<li><p>better way to backup when in managed environment</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">get</span> <span class="pre">all</span> <span class="pre">--all-namespaces</span> <span class="pre">-o</span> <span class="pre">yaml</span> <span class="pre">&gt;</span> <span class="pre">all-deploy-services.yml</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>can use tools like Velero to backup the cluster</p></li>
<li><dl>
<dt>can backup etcd instead of saving all resource definitions</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--data-dir</span></code>, directory where all configurations will be stored</p></li>
<li><p>etcd has built-in snapshot too, <code class="docutils literal notranslate"><span class="pre">etcdctl</span> <span class="pre">snapshot</span> <span class="pre">save</span> <span class="pre">snapshot.db</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">service</span> <span class="pre">kube-apiserver</span> <span class="pre">stop</span> <span class="pre">&amp;&amp;</span> <span class="pre">etcd</span> <span class="pre">snapshot</span> <span class="pre">restore</span> <span class="pre">snapshot.db</span> <span class="pre">--data-dir</span> <span class="pre">/dir</span></code>,</p></li>
</ul>
<p>new data directory is created in /dir, then configure the etcd.service to use the new
data directory
- <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">daemon-reload</span> <span class="pre">&amp;&amp;</span> <span class="pre">service</span> <span class="pre">etcd</span> <span class="pre">restart</span> <span class="pre">&amp;&amp;</span> <span class="pre">service</span> <span class="pre">kube-apiserver</span> <span class="pre">start</span></code>
- always authenticate etcd commands, <code class="docutils literal notranslate"><span class="pre">--endpoints,</span> <span class="pre">--cacert,</span> <span class="pre">--cert,</span> <span class="pre">--key</span></code>
- when etcd restore, it initializes a new cluster config and configure the members
- as new members of the new cluster
- if etcd is running as a pod, ETCD is set up as a Stacked ETCD Topology where the
distributed data storage cluster provided by etcd is stacked on top of the cluster
formed by the nodes managed by kubeadm that run control plane components.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">ETCDCTL_API</span><span class="o">=</span><span class="m">3</span><span class="w"> </span>etcdctl<span class="w"> </span>--endpoints<span class="o">=</span>https://<span class="o">[</span><span class="m">127</span>.0.0.1<span class="o">]</span>:2379<span class="w"> </span><span class="se">\</span>
--cacert<span class="o">=</span>/etc/kubernetes/pki/etcd/ca.crt<span class="w"> </span><span class="se">\</span>
--cert<span class="o">=</span>/etc/kubernetes/pki/etcd/server.crt<span class="w"> </span><span class="se">\</span>
--key<span class="o">=</span>/etc/kubernetes/pki/etcd/server.key<span class="w"> </span><span class="se">\</span>
snapshot<span class="w"> </span>save<span class="w"> </span>/opt/snapshot-pre-boot.db
Snapshot<span class="w"> </span>saved<span class="w"> </span>at<span class="w"> </span>/opt/snapshot-pre-boot.db
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>backing up etcd cluster: [K8s docs](<a class="reference external" href="https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster">https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster</a>), [github](<a class="github reference external" href="https://github.com/etcd-io/website/blob/main/content/en/docs/v3.5/op-guide/recovery.md">etcd-io/website</a>), [YouTube](<a class="reference external" href="https://www.youtube.com/watch?v=qRPNuT080Hk">https://www.youtube.com/watch?v=qRPNuT080Hk</a>)</p></li>
</ul>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="microservices-architecture">
<h2>Microservices Architecture<a class="headerlink" href="#microservices-architecture" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a href="#id55"><span class="problematic" id="id56">`Sidecar`_</span></a>, <a href="#id57"><span class="problematic" id="id58">`Adapter`_</span></a>, <a href="#id59"><span class="problematic" id="id60">`Ambassador`_</span></a></p></li>
</ul>
<section id="sidecar-pattern">
<h3>Sidecar pattern<a class="headerlink" href="#sidecar-pattern" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>e.g deploying a logging agent alongside the web server with the agent sending logs to the</p></li>
</ul>
<p>central logging server</p>
</div></blockquote>
</section>
<section id="adapter-pattern">
<h3>Adapter pattern<a class="headerlink" href="#adapter-pattern" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>e.g logging agent is deployed alongside the web server, and the different formatted</p></li>
</ul>
<p>logs are processed before being sent to the logging server</p>
</div></blockquote>
</section>
<section id="ambassador-pattern">
<h3>Ambassador pattern<a class="headerlink" href="#ambassador-pattern" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>e.g application communicates to different databases at different stages of</p></li>
</ul>
<p>development, it is important to make sure to modify the code to have correct connectivity
depending on the environment, this process is handed to a separate container within the pod
so that the application can refer to the correct database</p>
</div></blockquote>
<ul class="simple">
<li><p><a href="#id61"><span class="problematic" id="id62">`example voting app on docker`_</span></a>, <a href="#id63"><span class="problematic" id="id64">`example voting app on K8s`_</span></a></p></li>
</ul>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
<p># Designing a Cluster</p>
<ul class="simple">
<li><p><a class="reference internal" href="#purpose">Purpose</a>, <a class="reference internal" href="#environment">Environment</a>, <a class="reference internal" href="#choosing-workloads">Choosing Workloads</a>, <a class="reference internal" href="#choosing-infrastructure">Choosing Infrastructure</a>, <a class="reference internal" href="#high-availability">High Availability</a></p></li>
<li><p><a class="reference internal" href="#mutable-vs-immutable-infrastructure">Mutable vs Immutable Infrastructure</a></p></li>
</ul>
</section>
<section id="purpose">
<h3>Purpose<a class="headerlink" href="#purpose" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>education</dt><dd><ul>
<li><p>Minikube, single node cluster with kubeadm, GCP, AWS</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>development &amp; testing</dt><dd><ul>
<li><p>multi-node with single control-plane and multiple workers</p></li>
<li><p>setup using kubeadm or GCP, AWS or AKS</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>hosting production applications</dt><dd><ul>
<li><p>high availability multi-node cluster with multiple control-plane nodes</p></li>
<li><p>kubeadm, GCP or Kops on AWS</p></li>
<li><p>up to 500 nodes, up to 150,000 pods in the cluster</p></li>
<li><p>up to 300,000 total containers, up to 100 pods per node</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="environment">
<h3>Environment<a class="headerlink" href="#environment" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>cloud: GKE, Kops for AWS, AKS</p></li>
<li><p>on premises: kubeadm</p></li>
</ul>
</div></blockquote>
</section>
<section id="choosing-workloads">
<h3>Choosing Workloads<a class="headerlink" href="#choosing-workloads" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>storage</dt><dd><ul>
<li><p>SSD for high performance, network based storage for multiple concurrent connections</p></li>
<li><p>persistent shared volumes for shared access across pods</p></li>
<li><p>label nodes with specific disk types</p></li>
<li><p>use node selectors to assign applications to nodes with specific disk types</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>nodes</dt><dd><ul>
<li><p>VM or physical machines</p></li>
<li><p>minimum of 4 node cluster</p></li>
<li><p>Linux x86_64 architecture</p></li>
<li><p>best practice is to not host workloads on control-plane nodes</p></li>
<li><p>may choose to separate etcd from control-plane node</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="choosing-infrastructure">
<h3>Choosing Infrastructure<a class="headerlink" href="#choosing-infrastructure" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl class="simple">
<dt>local machines</dt><dd><ul class="simple">
<li><p>can setup natively on Linux, VM or WSL on Windows</p></li>
<li><p>minikube: deploy VMs, single node cluster</p></li>
<li><p>kubeadm: requries VMs to be ready, single/multi node cluster</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>turnkey solutions</dt><dd><ul class="simple">
<li><p>provision, configure and maintain VMs and use scripts to deploy cluster</p></li>
<li><p>e.g [Kubernetes on AWS](<a class="reference external" href="https://aws.amazon.com/kubernetes/">https://aws.amazon.com/kubernetes/</a>) using [kops](<a class="reference external" href="https://kops.sigs.k8s.io/">https://kops.sigs.k8s.io/</a>) or [KubeOne](<a class="reference external" href="https://www.kubermatic.com/products/kubermatic-kubeone/">https://www.kubermatic.com/products/kubermatic-kubeone/</a>)</p></li>
<li><p>K8s certified solutions such as OpenShift, Cloud Foundry Container Runtime, VMware</p></li>
</ul>
<p>Cloud PKS, Vagrant</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>hosted</dt><dd><ul class="simple">
<li><p>managed solutions, K8s-as-a-Service</p></li>
<li><p>CSP provision and maintain VMs and install K8s</p></li>
<li><p>e.g [AWS EKS](<a class="reference external" href="https://aws.amazon.com/eks/">https://aws.amazon.com/eks/</a>), [GKE](<a class="reference external" href="https://cloud.google.com/kubernetes-engine">https://cloud.google.com/kubernetes-engine</a>), [AKS](<a class="reference external" href="https://azure.microsoft.com/en-us/services/kubernetes-service/">https://azure.microsoft.com/en-us/services/kubernetes-service/</a>), [OpenShift](<a class="reference external" href="https://www.redhat.com/en/technologies/cloud-computing/openshift/kubernetes-engine">https://www.redhat.com/en/technologies/cloud-computing/openshift/kubernetes-engine</a>)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="high-availability">
<h3>High Availability<a class="headerlink" href="#high-availability" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>have redundancy across every components</p></li>
<li><dl>
<dt>having two control-plane nodes</dt><dd><ul class="simple">
<li><p>running multiple instances of the same components</p></li>
<li><p>bot kube-apiserver are in active-active mode</p></li>
<li><p>have load balancer in front of the nodes using solutions such as Nginx, HA proxy</p></li>
<li><p>then point kubectl to the load balancer</p></li>
<li><p>two instances of each kube-controller-manager and kube-scheduler must run in</p></li>
</ul>
<p>active-standby mode, which is decided through leader election process
- <code class="docutils literal notranslate"><span class="pre">--leader-elect</span></code> , <code class="docutils literal notranslate"><span class="pre">--leader-elect-lease-duration</span></code>, <code class="docutils literal notranslate"><span class="pre">--leader-elect-renew-deadline</span></code>,
<code class="docutils literal notranslate"><span class="pre">--leader-elect-retry-period</span></code> options are available
- stacked topology: etcd is part of the control-plane node, easy to setup and manage,
but both etcd go down if one node goes down
- external etcd topology: etcd is separated from control-plane node, hard to setup but
less failure impact</p>
</dd>
</dl>
</li>
<li><dl>
<dt>etcd</dt><dd><ul class="simple">
<li><p>when distributing across multiple servers, data can be read from multiple nodes</p></li>
<li><p>only one is responsible for processing the write</p></li>
<li><p>one node is elected as leader, and others become followers</p></li>
<li><p>leader makes sure other nodes have copy of the data if write request is sent to</p></li>
</ul>
<p>it
- if writes are sent to the followers, they are internally forwarded to the leader
- uses RAFT for leader election
- a write is complete if it can be written to majority of the nodes, Quorum = n/2 + 1
- recommended to have at least 3 or odd number (5, beyond 5 is unnecessary) of
instances, as even number of
nodes has the possibility of failing when network is segmented</p>
</dd>
</dl>
</li>
<li><dl>
<dt>RAFT</dt><dd><ul class="simple">
<li><p>uses random timer for initiating requests</p></li>
<li><p>the first one to finish the request sends permission to others to be a leader</p></li>
<li><p>it sends notification to others that it will continue to be the leader</p></li>
<li><p>if the other nodes do not receive notification from the leader, new leader election</p></li>
</ul>
<p>process is initiated among them</p>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
</section>
<section id="mutable-vs-immutable-infrastructure">
<h3>Mutable vs Immutable Infrastructure<a class="headerlink" href="#mutable-vs-immutable-infrastructure" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl>
<dt><strong>Mutable</strong></dt><dd><ul class="simple">
<li><p>in-place update: updating software version by version on each server</p></li>
<li><p>underlying infrastructure remains the same</p></li>
<li><p>but software and configurations of the servers change as part of the update</p></li>
<li><p>upgrade can fail on one or more of the servers because of unmet dependencies,</p></li>
</ul>
<p>network issues, file system full, different OS versions
- configuration drift: not all servers able to update leaving the infrastructure in
a complex state, each server behaving different</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><strong>Immutable</strong></dt><dd><ul class="simple">
<li><p>deploy new servers with new software, and delete the old ones if the new ones succeed</p></li>
<li><p>cannot carry out in-place updates</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>although containers are to be immutable by default, can still carry in-place updates</p></li>
<li><p>copying files statically into the pod, or log in into the container and making changes</p></li>
<li><p>to prevent in-place updating, make sure file system cannot be written once the pod</p></li>
</ul>
<dl>
<dt>started</dt><dd><ul class="simple">
<li><p>using only <code class="docutils literal notranslate"><span class="pre">readOnlyRootFileSystem</span></code>, application might break if it has to write logs</p></li>
</ul>
<p>or cache data
- use volume mounts
- can still make changes to sudo file system if container is run in privileged mode</p>
</dd>
</dl>
<ul>
<li><p>to make infrastructure immutable, use least privileged principle and pod security policy</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">      </span><span class="nt">readOnlyRootFileSystem</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-volume</span>
<span class="w">        </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/cache/</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cache-volume</span>
<span class="w">    </span><span class="nt">emptyDir</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{}</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="system-hardening">
<h2>System Hardening<a class="headerlink" href="#system-hardening" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#limit-access-to-nodes">Limit access to nodes</a>, <a class="reference internal" href="#seccomp-in-k8s">Seccomp in K8s</a>, <a class="reference internal" href="#apparmor-in-k8s">AppArmor in K8s</a>, <a class="reference internal" href="#capabilities">Capabilities</a></p></li>
<li><p><a class="reference internal" href="#minimize-base-image-footprint">Minimize base image footprint</a>, <a class="reference internal" href="#image-policy-webhook">Image Policy Webhook</a></p></li>
<li><p>reducing the complexity of the systems reduce the attack surface</p></li>
<li><p>use least privilege principle make sure every systems only have minimum privileges to carry</p></li>
</ul>
<p>out their tasks</p>
<section id="limit-access-to-nodes">
<h3>Limit access to nodes<a class="headerlink" href="#limit-access-to-nodes" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>limit exposure of control-plane and the nodes to the Internet</p></li>
<li><p>some managed clusters do not allow access to control-plane, varies on CSP</p></li>
<li><p>some solutions use private networks, the cluster can then be accessed via VPN</p></li>
<li><dl class="simple">
<dt>enable authorized access within firewall if not able to setup VPN</dt><dd><ul class="simple">
<li><p>allow restricted access to the nodes based on source IP range</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>configure who can access</dt><dd><ul class="simple">
<li><p>admins need ssh access as they need to manage the nodes</p></li>
<li><p>developers might have access in development environment but not in production</p></li>
<li><p>end users should be restricted from having access</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>accounts</dt><dd><ul class="simple">
<li><p>user account: individuals who need access to Linux system, e.g admins, developers</p></li>
<li><p>superuser account: root account with UID 0, has unrestricted access</p></li>
<li><p>system account: created during OS installation, used by services not run</p></li>
</ul>
<p>as superuser
- service account: created when services are installed
- <code class="docutils literal notranslate"><span class="pre">id</span></code>, <code class="docutils literal notranslate"><span class="pre">who</span></code>, <code class="docutils literal notranslate"><span class="pre">last</span></code>
- <code class="docutils literal notranslate"><span class="pre">usermod</span> <span class="pre">-s</span> <span class="pre">/bin/nologin</span> <span class="pre">user1</span></code>, <code class="docutils literal notranslate"><span class="pre">userdel</span> <span class="pre">user1</span></code>, <code class="docutils literal notranslate"><span class="pre">deluser</span> <span class="pre">user1</span> <span class="pre">group1</span></code></p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>access control files</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/etc/passwd</span></code>, <code class="docutils literal notranslate"><span class="pre">/etc/shadow</span></code>, <code class="docutils literal notranslate"><span class="pre">/etc/group</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>SSH</dt><dd><ul class="simple">
<li><p>disable password authentication and use key pairs to authenticate</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PermitRootLogin</span> <span class="pre">no</span></code>, <code class="docutils literal notranslate"><span class="pre">PasswordAuthentication</span> <span class="pre">no</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/ssh/sshd_config</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</div></blockquote>
<ul>
<li><dl class="simple">
<dt>remove obsolete packages and services</dt><dd><ul class="simple">
<li><p>install only required packages</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">list-units</span> <span class="pre">--type</span> <span class="pre">service</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>restrict network access and obsolete kernel modules</dt><dd><ul class="simple">
<li><p>loading modules, <code class="docutils literal notranslate"><span class="pre">modprobe</span> <span class="pre">module1</span></code></p></li>
<li><p>list modules, <code class="docutils literal notranslate"><span class="pre">lsmod</span></code></p></li>
<li><p>blacklist modules on all the nodes</p></li>
<li><p>edit <code class="docutils literal notranslate"><span class="pre">etc/modprobe.d/blacklist.conf</span></code>, file name doesn’t matter</p></li>
<li><p>e.g add <code class="docutils literal notranslate"><span class="pre">blacklist</span> <span class="pre">sctp</span></code> in the file</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl>
<dt>identify and fix open ports</dt><dd><ul class="simple">
<li><p>check ports, <code class="docutils literal notranslate"><span class="pre">netstat</span> <span class="pre">-an</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-w</span> <span class="pre">LISTEN</span></code></p></li>
<li><p>check which services use the port, <code class="docutils literal notranslate"><span class="pre">cat</span> <span class="pre">/etc/services</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">-w</span> <span class="pre">PORT</span></code></p></li>
<li><p>[Required Ports](<a class="reference external" href="https://kubernetes.io/docs/reference/ports-and-protocols/">https://kubernetes.io/docs/reference/ports-and-protocols/</a>)</p></li>
<li><p>use third-party tools to add extra layer of security such as Cisco ASA, Juniper NGFW,</p></li>
</ul>
<p>Barracuda NGFW, Fortinet
* <strong>UFW (Uncomplicated Firewall)</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>interface for <code class="docutils literal notranslate"><span class="pre">iptables</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">status</span></code>, <code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">default</span> <span class="pre">allow</span> <span class="pre">outgoing</span></code>, <code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">default</span> <span class="pre">deny</span> <span class="pre">incoming</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">allow</span> <span class="pre">from</span> <span class="pre">172.16.238.5</span> <span class="pre">to</span> <span class="pre">any</span> <span class="pre">port</span> <span class="pre">22</span> <span class="pre">proto</span> <span class="pre">tcp</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">allow</span> <span class="pre">from</span> <span class="pre">172.16.100.0/28</span> <span class="pre">to</span> <span class="pre">any</span> <span class="pre">port</span> <span class="pre">80</span> <span class="pre">proto</span> <span class="pre">tcp</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">deny</span> <span class="pre">8080</span></code>, <code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">enable</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">delete</span> <span class="pre">deny</span> <span class="pre">8080</span></code> or <code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">delete</span> <span class="pre">5</span></code> based on <code class="docutils literal notranslate"><span class="pre">ufw</span> <span class="pre">status</span> <span class="pre">numbered</span></code> line number</p></li>
</ul>
</div></blockquote>
</dd>
</dl>
</li>
<li><p>use IAM roles to restrict users in the cloud environment</p></li>
</ul>
</section>
<section id="seccomp-in-k8s">
<h3>Seccomp in K8s<a class="headerlink" href="#seccomp-in-k8s" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>to check seccomp configuration</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">kubectl</span> <span class="pre">run</span> <span class="pre">amicontained</span> <span class="pre">--image=r.j3ss.co/amicontained</span> <span class="pre">amicontained</span> <span class="pre">--</span> <span class="pre">amicontained</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>when container is run as a pod, only 21 syscalls are blocked and mode 0</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">allowPrivilegeEscalation</span></code>, restrict process inside container from having more privilege</p></li>
<li><p>custom profiles must be in <code class="docutils literal notranslate"><span class="pre">/var/lib/kubelet/seccomp/profiles</span></code></p></li>
<li><dl class="simple">
<dt>to audit the syscalls made by application</dt><dd><ul>
<li><p>use <code class="docutils literal notranslate"><span class="pre">&quot;defaultAction&quot;:</span> <span class="pre">&quot;SCMP_ACT_LOG</span></code>, logs will be under <code class="docutils literal notranslate"><span class="pre">/var/log/syslog</span></code></p></li>
<li><p>can also use tracee</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>the key is to find all the syscalls made by the application and block all others</p></li>
<li><p>can help isolate the pod and secure the cluster</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">    </span><span class="nt">seccompProfile</span><span class="p">:</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RuntimeDefault</span><span class="w"> </span><span class="c1"># default is Unconfined</span>
<span class="w">      </span><span class="c1"># for custom profile</span>
<span class="w">      </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Localhost</span>
<span class="w">      </span><span class="nt">localhostProfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">profiles/custom.json</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">r.j3ss.co/amicontained</span>
<span class="w">    </span><span class="nt">args</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">amicontained</span>
<span class="w">    </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">      </span><span class="nt">allowPrivilegeEscalation</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="apparmor-in-k8s">
<h3>AppArmor in K8s<a class="headerlink" href="#apparmor-in-k8s" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>AppArmor kernel module must be enabled on the node that the pods will run</p></li>
<li><p>profiles must be loaded, CRI should support AppArmor</p></li>
<li><p>still in beta state</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">    </span><span class="nt">container.apparmor.security.beta.kubernetes.io/container1</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">localhost/myprofile</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="capabilities">
<h3>Capabilities<a class="headerlink" href="#capabilities" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>super user privileges divided into distinct units</p></li>
<li><p>processes are assigned a subset of capabilities</p></li>
<li><p>check needed capabilities of a command, <code class="docutils literal notranslate"><span class="pre">getcap</span> <span class="pre">/usr/bin/ping</span></code></p></li>
<li><p>check needed capabilities of a process, <code class="docutils literal notranslate"><span class="pre">getpcaps</span> <span class="pre">779</span></code></p></li>
<li><p>containers using docker runtime has only 14 capabilites by default</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># pod-definition.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">securityContext</span><span class="p">:</span>
<span class="w">      </span><span class="nt">capabilities</span><span class="p">:</span>
<span class="w">        </span><span class="nt">add</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;SYS_TIME&quot;</span><span class="p p-Indicator">]</span>
<span class="w">        </span><span class="nt">drop</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;CHOWN&quot;</span><span class="p p-Indicator">]</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="minimize-base-image-footprint">
<h3>Minimize base image footprint<a class="headerlink" href="#minimize-base-image-footprint" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>base image: an image that is built from scratch, can also call a parent image as base</p></li>
<li><p>do not build images that combine multiple applications</p></li>
<li><p>each image must solve only one problem</p></li>
<li><p>the images can then be combined to form a single service, and each application can be</p></li>
</ul>
<p>scaled without worrying about the others
* do not persist state inside the container
* use official, frequently updated and minimal images as base
* only install necessary packages, rmeove shells/package managers/tools
* maintain different images for different environment, development with debug tools and
lean images for production
* use multi-stage builds
* distroless docker images</p>
<blockquote>
<div><ul class="simple">
<li><p>contain only application and runtime dependencies</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">gcr.io/distroless</span></code></p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><p>minimal image is less vulnerable</p></li>
</ul>
</div></blockquote>
</section>
<section id="image-policy-webhook">
<h3>Image Policy Webhook<a class="headerlink" href="#image-policy-webhook" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to ensure images are only pulled from approved registries</p></li>
<li><p>deploy Admission Webhook server, enable and configure <code class="docutils literal notranslate"><span class="pre">ImagePolicyWebhook</span></code> to communicate</p></li>
</ul>
<p>it using <cite>AdmissionConfiguration</cite> file
* <code class="docutils literal notranslate"><span class="pre">defaultAllow</span></code>, allow by default if Admission Webhook server is down
* need to pass <code class="docutils literal notranslate"><span class="pre">--admission-control-config-file</span></code> in kube-apiserver</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># admission-config.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apiserver.config.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">AdmissionConfiguration</span>
<span class="nt">plugins</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ImagePolicyWebhook</span>
<span class="w">  </span><span class="nt">configuration</span><span class="p">:</span>
<span class="w">    </span><span class="nt">imagePolicy</span><span class="p">:</span>
<span class="w">      </span><span class="nt">kubeConfigFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-kubeconfig-file</span>
<span class="w">      </span><span class="nt">allowTTL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">      </span><span class="nt">denyTTL</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50</span>
<span class="w">      </span><span class="nt">retryBackoff</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">500</span>
<span class="w">      </span><span class="nt">defaultAllow</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>

<span class="c1"># my-kubeconfig-file</span>
<span class="nt">clusters</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name-of-remote-imagepolicy-service</span>
<span class="w">  </span><span class="nt">cluster</span><span class="p">:</span>
<span class="w">    </span><span class="nt">certificate-authority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/ca.pem</span>
<span class="w">    </span><span class="nt">server</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">https://images.example.com/policy</span>
<span class="nt">users</span><span class="p">:</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name-of-api-server</span>
<span class="w">  </span><span class="nt">user</span><span class="p">:</span>
<span class="w">    </span><span class="nt">client-certificate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/cert/pem</span>
<span class="w">    </span><span class="nt">client-key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/path/to/key.pem</span>
</pre></div>
</div>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="tools">
<h2>Tools<a class="headerlink" href="#tools" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference internal" href="#kubectx">kubectx</a>, <a class="reference internal" href="#kubesec">kubesec</a>, <a class="reference internal" href="#trivy">Trivy</a>, <a class="reference internal" href="#weaveworks">Weaveworks</a>, <a class="reference internal" href="#helm">Helm</a>, <a href="#id65"><span class="problematic" id="id66">`CIS Benchmark`_</span></a>, <a class="reference internal" href="#kube-bench">kube-bench</a></p></li>
<li><p><a href="#id67"><span class="problematic" id="id68">`OPA`_</span></a>, <a class="reference internal" href="#gvisor">gVisor</a>, <a class="reference internal" href="#kata-containers">Kata Containers</a>, <a class="reference internal" href="#falco">Falco</a></p></li>
</ul>
<section id="kubectx">
<h3>kubectx<a class="headerlink" href="#kubectx" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>easier way to switch contexts, useful in multi-cluster environment</p></li>
<li><p>[kubectx](<a class="github reference external" href="https://github.com/ahmetb/kubectx">ahmetb/kubectx</a>)</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># switch to another cluster that&#39;s in kubeconfig</span>
kubectx<span class="w"> </span>minikube

<span class="c1"># switch back to previous cluster</span>
kubectx<span class="w"> </span>-

<span class="c1"># create an alias for the context</span>
kubectx<span class="w"> </span><span class="nv">dublin</span><span class="o">=</span>gke_ahmetb_europe-west1-b_dublin

<span class="c1"># change the active namespace on kubectl</span>
kubens<span class="w"> </span>kube-system

<span class="c1"># go back to the previous namespace</span>
kubens<span class="w"> </span>-
</pre></div>
</div>
</div></blockquote>
</section>
<section id="kubesec">
<h3>kubesec<a class="headerlink" href="#kubesec" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>static analysis: review resource files and enforce policies in development</p></li>
<li><p>helps analyze the given resource file and returns a score with critical issues found</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubesec</span> <span class="pre">scan</span> <span class="pre">pod.yml</span></code>, using binaries</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">-sSX</span> <span class="pre">POST</span> <span class="pre">--data-binary</span> <span class="pre">&#64;&quot;pod.yml&quot;</span> <span class="pre">https://v2.kubesec.io/scan</span></code>, on hosted server</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kubesec</span> <span class="pre">http</span> <span class="pre">8080</span></code>, run locally</p></li>
<li><p>[kubesec](<a class="github reference external" href="https://github.com/controlplaneio/kubesec">controlplaneio/kubesec</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="trivy">
<h3>Trivy<a class="headerlink" href="#trivy" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><dl class="simple">
<dt>criteria to be in CVE (Common Vulnerabilities an Exposures)</dt><dd><ul>
<li><p>allowing attacker to bypass security checks</p></li>
<li><p>severity score from 0-10 (none, low, medium, high, critical)</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>scan container images for CVE by Aqua Security</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">triby</span> <span class="pre">image</span> <span class="pre">nginx:1.12</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trivy</span> <span class="pre">image</span> <span class="pre">--severity</span> <span class="pre">CRITICAL,HIGH</span> <span class="pre">nginx:1.12</span></code>, only show critical and high</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trivy</span> <span class="pre">image</span> <span class="pre">--ignore-unfixed</span> <span class="pre">nginx:1.12</span></code>, only show that can be immediately fixed</p></li>
<li><p>can scan tar, <code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">save</span> <span class="pre">nginx:1.12</span> <span class="pre">&gt;</span> <span class="pre">nginx.tar</span></code>, <code class="docutils literal notranslate"><span class="pre">trivy</span> <span class="pre">image</span> <span class="pre">--input</span> <span class="pre">nginx.tar</span></code></p></li>
<li><p>configure Admission Controllers to scan images, have own repository with pre-scanned</p></li>
</ul>
<p>images, integrate scanning into CI/CD pipeline
* [Trivy](<a class="github reference external" href="https://github.com/aquasecurity/trivy">aquasecurity/trivy</a>)</p>
</div></blockquote>
</section>
<section id="weaveworks">
<h3>Weaveworks<a class="headerlink" href="#weaveworks" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><p>solution that makes creating network models easy</p></li>
<li><p>deploy agent or service on each node</p></li>
<li><p>each agent store the topology of entire network setup</p></li>
<li><p>Weave creates its own bridge named “WEAVE” on each node and assign IP addresses</p></li>
<li><p>makes sure that pods get correct routes configured to reach the agents</p></li>
<li><p>agents encapsulate and decapsulate the packets between each other</p></li>
<li><p>Weave and its peers can be deployed as services/daemons on each node manually</p></li>
<li><dl>
<dt>deploy as pods if the cluster is already setup with right configurations with</dt><dd><ul class="simple">
<li><p>peers are deployed as daemonsets and can view logs using <code class="docutils literal notranslate"><span class="pre">kubectl</span></code></p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span><span class="se">\</span>
<span class="s2">&quot;https://cloud.weave.works/k8s/net?k8s-version=</span><span class="k">$(</span>kubectl<span class="w"> </span>version<span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="w"> </span><span class="p">|</span><span class="w"> </span>tr<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="k">)</span><span class="s2">&quot;</span>
</pre></div>
</div>
</dd>
</dl>
</li>
<li><p>by default, uses IP range 10.32.0.0/12</p></li>
<li><p>the peers decide to split IP addresses equally between them and assign one portion to</p></li>
</ul>
<p>each node</p>
</div></blockquote>
</section>
<section id="helm">
<h3>Helm<a class="headerlink" href="#helm" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>package manager for K8s</p></li>
<li><p>looks multiple objects of the application as a group</p></li>
<li><p>keeps track of all objects used by the application</p></li>
<li><p>do not need to micromanage each object</p></li>
<li><p>only need to tell what package to act on</p></li>
<li><p>automatically knows what objects to change, based on package name, even if there are</p></li>
</ul>
<p>hundreds of objects in the package
* only use single command to install the application with multiple objects
* helm proceeds to add every necessary objects to K8s
* can specify desired values at install time
* <code class="docutils literal notranslate"><span class="pre">values.yml</span></code>: single file to declare every custom setting instead of multiple YAML files</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># first convert definition files to templates</span>

<span class="c1"># templates/deployment.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Values.image</span><span class="w"> </span><span class="p p-Indicator">}}</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wordpress</span>

<span class="c1"># templates/secret.yml</span>
<span class="nt">data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Values.passwordEncoded</span><span class="w"> </span><span class="p p-Indicator">}}</span>

<span class="c1"># templates/pv.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">capacity</span><span class="p">:</span>
<span class="w">    </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Values.storage</span><span class="w"> </span><span class="p p-Indicator">}}</span>

<span class="c1"># templatespvc.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">      </span><span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">{{</span><span class="w"> </span><span class="nv">.Values.storage</span><span class="w"> </span><span class="p p-Indicator">}}</span>

<span class="c1"># {{ .Values.* }} will be fetched from values.yml</span>


<span class="c1"># values.yml</span>
<span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wordpress</span>
<span class="nt">storage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20Gi</span>
<span class="nt">passwordEncoded</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">encoDedPasSwoRd</span>
</pre></div>
</div>
<ul>
<li><dl>
<dt>Helm Chart</dt><dd><ul class="simple">
<li><p>combination of templates, <code class="docutils literal notranslate"><span class="pre">values.yml</span></code> and Chart.yml, which has info about the chart</p></li>
</ul>
<p>itself
- single chart may be used to deploy simple application
- can create own chart or search from [ArtifactHUB](<a class="reference external" href="https://artifacthub.io/">https://artifacthub.io/</a>), which
is a repository for Helm Charts
- <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">search</span> <span class="pre">hub</span> <span class="pre">wordpress</span></code> searches from ArtifactHUB
- other repositories such as [Bitnami]()
- <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">repo</span> <span class="pre">add</span> <span class="pre">bitnami</span> <span class="pre">https://charts.bitnami.com/bitnami</span></code>: must add repository to
search from other than ArtifactHUB
- <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">search</span> <span class="pre">repo</span> <span class="pre">wordpress</span></code>: can now search
- <code class="docutils literal notranslate"><span class="pre">helm</span> <span class="pre">repo</span> <span class="pre">list</span></code> to list repos
- release: each installation of a chart
- each release has a release name
- can install multiple releases and each release is independent of each other</p>
</dd>
</dl>
</li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>helm<span class="w"> </span>install<span class="w"> </span>release-1<span class="w"> </span>bitnami/wordpress
helm<span class="w"> </span>install<span class="w"> </span>release-2<span class="w"> </span>bitnami/wordpress

<span class="c1"># helm knows which objects need to be upgraded</span>
helm<span class="w"> </span>upgrade<span class="w"> </span>release-2

helm<span class="w"> </span>rollback<span class="w"> </span>release-1

<span class="c1"># no need to delete each object</span>
helm<span class="w"> </span>uninstall<span class="w"> </span>release-2

<span class="c1"># only download and extract</span>
helm<span class="w"> </span>pull<span class="w"> </span>--untar<span class="w"> </span>bitnami/wordpress

<span class="c1"># install local chart</span>
helm<span class="w"> </span>install<span class="w"> </span>release-3<span class="w"> </span>./wordpress
</pre></div>
</div>
<ul class="simple">
<li><p>installation prerequisites: kubectl and K8s cluster with right credentials</p></li>
<li><p>[Helm](<a class="reference external" href="https://helm.sh/docs/intro/install/">https://helm.sh/docs/intro/install/</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="cis-benchmark-center-for-internet-security">
<h3>CIS Benchmark (Center for Internet Security)<a class="headerlink" href="#cis-benchmark-center-for-internet-security" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul>
<li><dl>
<dt>some necessary security benchmark</dt><dd><ul class="simple">
<li><p>physical access (e.g usb ports)</p></li>
<li><p>user access: what users, which users, disable root user, use sudo if required, but</p></li>
</ul>
<p>only those who are configured to
- network: configure firewall, iptables, open only required ports
- services: enable only necessary services
- filesystems: right permission of files, disable unused file systems
- auditing, logging</p>
</dd>
</dl>
</li>
<li><p>CIS provides cyber security benchmarks for over 25 different vendors</p></li>
<li><p>OS, cloud, mobile, network, desktop and server softwares, databases</p></li>
<li><p>benchmarks have instructions for various security recommendations</p></li>
<li><p>each recommendation explains why the threat exists and how to prevent it</p></li>
<li><p>also provides tools to run assessments and remediate</p></li>
<li><p>e.g CIS-CAT tool helps in automated assessment of the server and output result in html</p></li>
<li><p>CIS-CAT Lite tool only support for Windows 10, Ubuntu, Google Chrome, macOS</p></li>
<li><dl>
<dt><strong>CIS benchmark for K8s</strong></dt><dd><ul class="simple">
<li><p>document contains recommendations for components, details to check current status</p></li>
</ul>
<p>and necessary commands to remediate
- CIS-CAT Pro tool is required</p>
</dd>
</dl>
</li>
<li><p>[CIS](<a class="reference external" href="https://www.cisecurity.org/">https://www.cisecurity.org/</a>)</p></li>
</ul>
</div></blockquote>
<p>on the master node and set the –terminated-pod-gc-threshold to an appropriate threshold,
for example:
<a href="#id24"><span class="problematic" id="id25">*</span></a>-terminated-pod-gc-threshold=10</p>
</section>
<section id="kube-bench">
<h3>kube-bench<a class="headerlink" href="#kube-bench" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>open source tool from Aqua Security to perform automated assessments</p></li>
<li><p>test according to recommendations from CIS</p></li>
<li><p>can deploy as container, as a pod in K8s, install binaries or compile from source</p></li>
<li><p>[kube-bench](<a class="github reference external" href="https://github.com/aquasecurity/kube-bench">aquasecurity/kube-bench</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="opa-open-policy-agent">
<h3>OPA (Open Policy Agent)<a class="headerlink" href="#opa-open-policy-agent" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>takes care of authorization</p></li>
<li><p>applications don’t need to implement authorization in the code</p></li>
<li><p>deploy in the environment with a set of policies</p></li>
<li><p>applications first reach OPA and it verifies the request</p></li>
<li><p>it returns allowed or denied error message and services process the request</p></li>
<li><p>runs on port 8181 by default</p></li>
<li><p>policies are defined in <code class="docutils literal notranslate"><span class="pre">rego</span></code> language</p></li>
<li><p>also provides policy testing framework</p></li>
</ul>
<p># example.rego
package httpapi.authz
import input
default allow = false
allow {
# all conditions need to be true</p>
<blockquote>
<div><p>input.path == “home”
input.user == “john”</p>
</div></blockquote>
<p>}</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># installation</span>
curl<span class="w"> </span>-L<span class="w"> </span>-o<span class="w"> </span>opa<span class="w"> </span>https://openpolicyagent.org/downloads/v0.44.0/opa_linux_amd64_static
chmod<span class="w"> </span><span class="m">755</span><span class="w"> </span>./opa
./opa<span class="w"> </span>run<span class="w"> </span>-s

<span class="c1"># load policy</span>
curl<span class="w"> </span>-X<span class="w"> </span>PUT<span class="w"> </span>--data-binary<span class="w"> </span>@example.rego<span class="w"> </span>http://localhost:8181/v1/policies/example1

<span class="c1"># list policies</span>
curl<span class="w"> </span>http://localhost:8181/v1/policies

<span class="c1"># test policy</span>
opa<span class="w"> </span><span class="nb">test</span><span class="w"> </span>.<span class="w"> </span>-v
</pre></div>
</div>
<ul class="simple">
<li><p>[OPA at Netflix](<a class="reference external" href="https://www.youtube.com/watch?v=R6tUNpRpdnY">https://www.youtube.com/watch?v=R6tUNpRpdnY</a>), [OPA Deep Dive](<a class="reference external" href="https://www.youtube.com/watch?v=4mBJSIhs2xQ">https://www.youtube.com/watch?v=4mBJSIhs2xQ</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="gvisor">
<h3>gVisor<a class="headerlink" href="#gvisor" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>tool made by Google, allows additional layer between containers and the kernel</p></li>
<li><p>when a process in the container wants to make a syscall to the kernel, it makes to the</p></li>
</ul>
<p>gVisor
* two components: Sentry and Gofer
* <strong>Sentry</strong></p>
<blockquote>
<div><ul class="simple">
<li><p>independent application level kernel</p></li>
<li><p>intercept syscalls made by container application</p></li>
<li><p>has limited syscalls</p></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt><strong>Gofer</strong></dt><dd><ul>
<li><p>file proxy for containerized apps to access the system files</p></li>
<li><p>Sentry communicates to it if the application needs to access files</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>use its own network stack, so that the container doesn’t need to interact directly with</p></li>
</ul>
<p>OS network code
* not all applications work with gVisor, and more cpu usage as syscalls are processed by
middleman
* uses Runsc
* to be used in K8s cluster, create <code class="docutils literal notranslate"><span class="pre">RuntimeClass</span></code> object
* container cannot be seen as a process from the node</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># gvisor.yml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">node.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RuntimeClass</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gvisor</span>
<span class="nt">handler</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">runsc</span>

<span class="c1"># gvisor-nginx.yml</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">runtimeClassName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gvisor</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="kata-containers">
<h3>Kata Containers<a class="headerlink" href="#kata-containers" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>process the syscalls into its own VM kernel</p></li>
<li><p>each container has dedicated VM kernel</p></li>
<li><p>VM kernels are optimized, but still has slight performance impact</p></li>
<li><p>won’t be able to run in cloud environments, as many CSPs do not provide nested</p></li>
</ul>
<p>virtualization, but can be manually enable in GCP
* useful in on-premises environment
* uses kata-runtime</p>
</div></blockquote>
<ul class="simple">
<li><dl class="simple">
<dt>since kata-runtime and Runsc are OCI compliant, can use with docker</dt><dd><ul>
<li><p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--runtime</span> <span class="pre">kata</span> <span class="pre">-d</span> <span class="pre">nginx</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--runtime</span> <span class="pre">runsc</span> <span class="pre">-d</span> <span class="pre">nginx</span></code></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="falco">
<h3>Falco<a class="headerlink" href="#falco" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>if there is a breach, identify as soon as possible</p></li>
<li><p>analyse the syscalls and filter suspicious ones, and can even notify</p></li>
<li><p>needs to see what syscalls are made by application from user space to kernel</p></li>
<li><p>can deploy as kernel module but some K8s providers do not allow as it is intrusive, so</p></li>
</ul>
<p>can make use of eBPF
* syscalls are analyzed by sysdig libraries in user space
* events are filterd by policy engine by using pre defined rules and output and alert
* using Falco as a service on the node directly isolates it from K8s and still continue
to detect in case of compromise
* can also deploy as daemonset on the nodes using helm charts
* installed directly on host</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">status</span> <span class="pre">falco</span></code>, on host</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-fu</span> <span class="pre">falco</span></code>, on nodes, inspect events</p></li>
</ul>
</div></blockquote>
<ul>
<li><dl class="simple">
<dt>sysdig filters</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">container.id</span></code>, <code class="docutils literal notranslate"><span class="pre">proc.name</span></code>, <code class="docutils literal notranslate"><span class="pre">fd.name</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">evt.type</span></code>, <code class="docutils literal notranslate"><span class="pre">user.name</span></code>, <code class="docutils literal notranslate"><span class="pre">container.image.repository</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">priority</span></code> values</dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">DEBUG</span></code>, <code class="docutils literal notranslate"><span class="pre">INFORMATIONAL</span></code>, <code class="docutils literal notranslate"><span class="pre">NOTICE</span></code>, <code class="docutils literal notranslate"><span class="pre">WARNING</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ERROR</span></code>, <code class="docutils literal notranslate"><span class="pre">CRITICAL</span></code>, <code class="docutils literal notranslate"><span class="pre">ALERT</span></code>, <code class="docutils literal notranslate"><span class="pre">EMERGENCY</span></code></p></li>
</ul>
</dd>
</dl>
</li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">list</span></code> instead of making rules for each process</p></li>
<li><p>use <code class="docutils literal notranslate"><span class="pre">macro</span></code> to write simpler conditions</p></li>
<li><dl>
<dt>main falco configuration file, <code class="docutils literal notranslate"><span class="pre">/etc/falco/falco.yml</span></code></dt><dd><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rules_file</span></code>, define rules files to be used, order matters, the last file is used</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">json_out</span></code>, logs events in json, false by default, so logs as text</p></li>
<li><p>logging options, <code class="docutils literal notranslate"><span class="pre">log_stderr</span></code>, <code class="docutils literal notranslate"><span class="pre">log_syslog</span></code>, <code class="docutils literal notranslate"><span class="pre">log_level</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">priority</span></code>, related to falco rules, minimum to use all events, everything higher</p></li>
</ul>
<p>will be logged
- <code class="docutils literal notranslate"><span class="pre">stdout_output</span></code>, logs to stdout by default, can have multiple output channels
- <code class="docutils literal notranslate"><span class="pre">file_output</span></code>, logs to a file
- <code class="docutils literal notranslate"><span class="pre">program_output</span></code>, send output to programs
- <code class="docutils literal notranslate"><span class="pre">http_output</span></code>, send output to http endpoints</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>main rules file, <code class="docutils literal notranslate"><span class="pre">/etc/falco/falco_rules.yml</span></code></dt><dd><ul class="simple">
<li><p>contain all built-in rules, macros and lists</p></li>
<li><p>check which file is used, <code class="docutils literal notranslate"><span class="pre">journalctl</span> <span class="pre">-fu</span> <span class="pre">falco</span></code></p></li>
<li><p>changes to the file will be overwritten when falco updates</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>put change or custom rules in <code class="docutils literal notranslate"><span class="pre">/etc/falco/falco_rules.local.yml</span></code></p></li>
<li><p>hot reload, <code class="docutils literal notranslate"><span class="pre">kill</span> <span class="pre">-1</span> <span class="pre">$(cat</span> <span class="pre">/var/run/falco.pid)</span></code></p></li>
<li><p>[Falco](<a class="reference external" href="https://falco.org/docs/">https://falco.org/docs/</a>), [Falco charts](<a class="github reference external" href="https://github.com/falcosecurity/charts">falcosecurity/charts</a>)</p></li>
</ul>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># falco-rules.yml</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">rule</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Detect shell inside container</span><span class="w"> </span><span class="c1"># name of rule</span>
<span class="w">  </span><span class="nt">desc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Alert if shell is opened inside container</span><span class="w"> </span><span class="c1"># detailed description of rule</span>
<span class="w">  </span><span class="c1"># when to filter events matching</span>
<span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">container and proc.name in (linux_shells)</span>
<span class="w">  </span><span class="nt">output</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Bash Shell Opened (user=%user.name %container.id)</span><span class="w"> </span><span class="c1"># output to ge generated</span>
<span class="w">  </span><span class="nt">priority</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">WARNING</span><span class="w"> </span><span class="c1"># severity of event</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">list</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">linux_shells</span>
<span class="w">  </span><span class="nt">items</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">bash</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">zsh</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">ksh</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">sh</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">csh</span><span class="p p-Indicator">]</span>
<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">macro</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">container</span>
<span class="w">  </span><span class="nt">condition</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">container.id != host</span>

<span class="c1"># custom-falco-rules.yml</span>
</pre></div>
</div>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="exam-guide">
<h2>Exam Guide<a class="headerlink" href="#exam-guide" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>certs are made by CNCF in collaboration with The Linux Foundation</p></li>
<li><p><a href="#id69"><span class="problematic" id="id70">`exam instructions`_</span></a>, <a href="#id71"><span class="problematic" id="id72">`curriculum`_</span></a>, <a href="#id73"><span class="problematic" id="id74">`handbook`_</span></a></p></li>
<li><p>discount code: DEVOPS15</p></li>
</ul>
<section id="ckad">
<h3>CKAD<a class="headerlink" href="#ckad" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to be able to design and build cloud-native applications for K8s</p></li>
<li><p>2-hours online performance based exam with hands-on labs, 19 questions</p></li>
<li><p>allow to access [K8s Documentation](<a class="reference external" href="https://kubernetes.io/docs/home/">https://kubernetes.io/docs/home/</a>) page during exam</p></li>
<li><p>can answer questions in any order</p></li>
<li><p>finish as many questions as possible, max attempt 3 times per question and skip if cannot</p></li>
</ul>
<p>solve, then comeback later
* get good with YAML, indentation doesn’t need to look pretty
* remember to use aliases for commands (po, rs, deploy, svc, ns, netpol, pv, pvc, sa)
* require only minimal knowledge of logging and monitoring
* [CKAD](<a class="reference external" href="https://www.cncf.io/certification/ckad/">https://www.cncf.io/certification/ckad/</a>), [tips](<a class="reference external" href="https://medium.com/&#64;harioverhere/ckad-certified-kubernetes-application-developer-my-journey-3afb0901014">https://medium.com/&#64;harioverhere/ckad-certified-kubernetes-application-developer-my-journey-3afb0901014</a>)</p>
</div></blockquote>
</section>
<section id="cka">
<h3>CKA<a class="headerlink" href="#cka" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>to be able to design, build and administer K8s cluster</p></li>
<li><p>allow to access [K8s Documentation](<a class="reference external" href="https://kubernetes.io/docs/home/">https://kubernetes.io/docs/home/</a>) page during exam</p></li>
<li><p>can use any CNI plugin if not specified, but cannot access the plugin documents</p></li>
<li><p>[CKA](<a class="reference external" href="https://www.cncf.io/certification/cka/">https://www.cncf.io/certification/cka/</a>)</p></li>
</ul>
</div></blockquote>
</section>
<section id="cks">
<h3>CKS<a class="headerlink" href="#cks" title="Link to this heading">#</a></h3>
<blockquote>
<div><ul class="simple">
<li><p>must have CKA certificate and certificate must be active to take the exam</p></li>
<li><p>allow to access [K8s Documentation](<a class="reference external" href="https://kubernetes.io/docs/home/">https://kubernetes.io/docs/home/</a>) page during exam</p></li>
<li><p>may ask to copy seccomp profiles</p></li>
<li><p>[CKS](<a class="reference external" href="https://www.cncf.io/certification/cks/">https://www.cncf.io/certification/cks/</a>)</p></li>
</ul>
</div></blockquote>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>
<section id="additional-resources">
<h2>Additional Resources<a class="headerlink" href="#additional-resources" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a href="#id75"><span class="problematic" id="id76">`Kubernetes the hard way`_</span></a></p></li>
<li><p><a href="#id77"><span class="problematic" id="id78">`K8s Documentation`_</span></a>, <a href="#id79"><span class="problematic" id="id80">`Glossary`_</span></a></p></li>
<li><p><a href="#id81"><span class="problematic" id="id82">`kubectl conventions`_</span></a>, <a href="#id83"><span class="problematic" id="id84">`kubectl overview`_</span></a>, <a href="#id85"><span class="problematic" id="id86">`kubectl cheat sheet`_</span></a>, <a href="#id87"><span class="problematic" id="id88">`kubectl commands`_</span></a></p></li>
<li><p><a class="reference internal" href="#secrets">Secrets</a></p></li>
<li><p><a class="reference internal" href="#init-containers">Init Containers</a></p></li>
<li><p><a class="reference internal" href="#ingress">Ingress</a>, <a href="#id89"><span class="problematic" id="id90">`K8s DNS`_</span></a></p></li>
<li><p><a href="#id91"><span class="problematic" id="id92">`Storage`_</span></a>, <a href="#id93"><span class="problematic" id="id94">`Object Management`_</span></a></p></li>
<li><p><a href="#id95"><span class="problematic" id="id96">`API Conventions`_</span></a>, <a href="#id97"><span class="problematic" id="id98">`Changing the API`_</span></a></p></li>
<li><p><a href="#id99"><span class="problematic" id="id100">`Addons`_</span></a></p></li>
<li><p><a href="#id101"><span class="problematic" id="id102">`KodeKloud CKA notes`_</span></a>, <a href="#id103"><span class="problematic" id="id104">`KodeKloud CKS notes`_</span></a></p></li>
</ul>
<p><a class="reference external" href="#kubernetes">back to top</a></p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="Jenkins.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Jenkins</p>
      </div>
    </a>
    <a class="right-next"
       href="LangChain.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">LangChain</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#what-is-k8s">What is K8s?</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#principles">Principles</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#basics">Basics</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#velocity">Velocity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#project-maturity">Project Maturity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#yaml">YAML</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tls-basics">TLS Basics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#switching-routing">Switching &amp; Routing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dns">DNS</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#network-namespace">Network Namespace</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-network-configurations">Container Network Configurations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-runtime-interface-cri">Container Runtime Interface (CRI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-storage-interface-csi">Container Storage Interface (CSI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-network-interface-cni">Container Network Interface (CNI)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#container-sandboxing">Container Sandboxing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#system-calls">System Calls</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apparmor">AppArmor</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#architecture">Architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nodes">Nodes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster">Cluster</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#control-plane">Control Plane</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#worker-nodes">Worker Nodes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-up-k8s">Setting up K8s</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubeadm">kubeadm</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#microk8s">MicroK8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minikube">minikube</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectl">kubectl</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectl-apply">kubectl apply</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectl-proxy">kubectl proxy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectl-port-forward">kubectl port-forward</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#etcd">etcd</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pods">Pods</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#creating-pods">Creating Pods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generating-yaml">Generating YAML</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#editing-pods">Editing Pods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copying-files">Copying Files</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#static-pods">Static Pods</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#init-containers">Init Containers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#multi-container-pods">Multi-Container pods</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#services">Services</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#nodeport">NodePort</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#clusterip">ClusterIP</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loadbalancer">LoadBalancer</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#headless-services">Headless Services</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#selector-less-services">Selector-less Services</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#connect-from-external">Connect from External</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#workloads">Workloads</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replication-controller">Replication Controller</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replicaset">ReplicaSet</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deployments">Deployments</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deployment-strategies">Deployment Strategies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#statefulsets">StatefulSets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#daemonset">Daemonset</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#jobs">Jobs</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cronjobs">CronJobs</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#storage-volumes">Storage &amp; Volumes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#recommended-patterns">Recommended Patterns</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#persistent-volume-pv">Persistent Volume (PV)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#persistent-volume-claims-pvc">Persistent Volume Claims (PVC)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#storage-classes">Storage Classes</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#controller">Controller</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kube-controller-manager">Kube Controller Manager</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#node-controller">Node Controller</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#admission-controller">Admission Controller</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#webhook">Webhook</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-controllers">Custom Controllers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#operator-framework">Operator Framework</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#scheduler">Scheduler</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#binding">Binding</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#networking">Networking</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ports">ports</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementing-network-model">Implementing Network Model</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cni-in-k8s">CNI in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-networking">Service Networking</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#dns-in-k8s">DNS in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#network-policies">Network Policies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ingress">Ingress</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mtls">mTLS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#security">Security</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#authentication">Authentication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubeconfig">kubeconfig</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#authorization">Authorization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#tls-in-k8s">TLS in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#certificates-api">Certificates API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-security">Image Security</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k8s-attack-surface">K8s Attack Surface</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubelet-security">Kubelet Security</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#pod-security-policies">Pod Security Policies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#opa-in-k8s">OPA in K8s</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#configuration">Configuration</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#declarative">Declarative</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#imperative">Imperative</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#namespaces">Namespaces</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#labels">Labels</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#annotations">Annotations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specify-arguments-and-commands">Specify arguments and commands</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configmaps">ConfigMaps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#secrets">Secrets</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#setting-env-variables">Setting ENV variables</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#resource-requirements">Resource Requirements</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#service-accounts">Service Accounts</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taints-tolerations">Taints &amp; Tolerations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#node-selectors">Node Selectors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#node-affinity">Node Affinity</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#custom-resource-definition">Custom Resource Definition</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#observability">Observability</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#health-checks">Health Checks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#readiness-probes">Readiness Probes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#liveness-probes">Liveness Probes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#startup-probes">Startup Probes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#exec-probes">Exec Probes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#logging">Logging</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#monitoring">Monitoring</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#application-failure">Application Failure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#controlplane-failure">Controlplane Failure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#node-failure">Node Failure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#network-failure">Network Failure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#auditing">Auditing</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k8s-dashboard">K8s Dashboard</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#json-path">JSON Path</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-maintenance">Cluster Maintenance</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#draining-the-node">Draining the node</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k8s-versions">K8s Versions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#k8s-api">K8s API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#backup">Backup</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#microservices-architecture">Microservices Architecture</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sidecar-pattern">Sidecar pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adapter-pattern">Adapter pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ambassador-pattern">Ambassador pattern</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#purpose">Purpose</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#environment">Environment</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-workloads">Choosing Workloads</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choosing-infrastructure">Choosing Infrastructure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#high-availability">High Availability</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#mutable-vs-immutable-infrastructure">Mutable vs Immutable Infrastructure</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#system-hardening">System Hardening</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#limit-access-to-nodes">Limit access to nodes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#seccomp-in-k8s">Seccomp in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#apparmor-in-k8s">AppArmor in K8s</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#capabilities">Capabilities</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#minimize-base-image-footprint">Minimize base image footprint</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#image-policy-webhook">Image Policy Webhook</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#tools">Tools</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubectx">kubectx</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kubesec">kubesec</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#trivy">Trivy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#weaveworks">Weaveworks</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#helm">Helm</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cis-benchmark-center-for-internet-security">CIS Benchmark (Center for Internet Security)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kube-bench">kube-bench</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#opa-open-policy-agent">OPA (Open Policy Agent)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#gvisor">gVisor</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kata-containers">Kata Containers</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#falco">Falco</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exam-guide">Exam Guide</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#ckad">CKAD</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cka">CKA</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cks">CKS</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-resources">Additional Resources</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Myat Kyaw Tun
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025, Myat Kyaw Tun.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=26a4bc78f4c0ddb94549"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=26a4bc78f4c0ddb94549"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>